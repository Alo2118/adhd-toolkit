// Active Tasks Management Functions - Temp file to be merged // These functions will be added to index.html before </script> // Show/Hide Modal function showAddTaskModal(){ currentEditingTaskId=null; document.getElementById('taskModalTitle').textContent='Nuovo compito'; document.getElementById('taskNameInput').value=''; document.getElementById('taskCategoryInput').value=''; document.getElementById('taskDeadlineInput').value=''; document.getElementById('taskNotesInput').value=''; document.getElementById('taskModal').style.display='flex'; } function showEditTaskModal(id){ const task=state.activeTasks.find(t=>t.id===id); if(!task)return; currentEditingTaskId=id; document.getElementById('taskModalTitle').textContent='Modifica compito'; document.getElementById('taskNameInput').value=task.name; document.getElementById('taskCategoryInput').value=task.category||''; document.getElementById('taskDeadlineInput').value=task.deadline||''; document.getElementById('taskNotesInput').value=task.notes||''; document.getElementById('taskModal').style.display='flex'; } function closeTaskModal(){ document.getElementById('taskModal').style.display='none'; currentEditingTaskId=null; } // Save Task function saveTask(){ const name=document.getElementById('taskNameInput').value.trim(); const category=document.getElementById('taskCategoryInput').value; const deadline=document.getElementById('taskDeadlineInput').value; const notes=document.getElementById('taskNotesInput').value.trim(); if(!name){ showToast('‚ùå Inserisci un nome per il compito'); return; } const now=new Date().toISOString(); if(currentEditingTaskId){ const task=state.activeTasks.find(t=>t.id===currentEditingTaskId); if(task){ task.name=name; task.category=category; task.deadline=deadline||null; task.notes=notes; task.lastUpdatedAt=now; saveState(); renderActiveTasks(); closeTaskModal(); showToast('‚úèÔ∏è Compito aggiornato'); } }else{ const newTask={ id:Date.now(), name:name, category:category, deadline:deadline||null, notes:notes, status:'active', createdAt:now, lastUpdatedAt:now, relatedHistoryIds:[] }; state.activeTasks.push(newTask); saveState(); renderActiveTasks(); closeTaskModal(); showToast('‚úì Compito aggiunto'); checkAndScheduleNotifications(); } } // Filters function setTaskStatusFilter(status){ taskStatusFilter=status; document.querySelectorAll('[data-status]').forEach(b=>b.classList.toggle('selected',b.dataset.status===status)); renderActiveTasks(); } function filterActiveTasks(){ if(taskStatusFilter==='all')return state.activeTasks; return state.activeTasks.filter(t=>t.status===taskStatusFilter); } // Date helpers function getDaysUntilDeadline(deadline){ if(!deadline)return null; const now=new Date(); const deadlineDate=new Date(deadline); deadlineDate.setHours(23,59,59,999); const diff=deadlineDate-now; return Math.ceil(diff/(1000*60*60*24)); } function getDaysSinceUpdate(lastUpdatedAt){ const now=new Date(); const lastUpdate=new Date(lastUpdatedAt); const diff=now-lastUpdate; return Math.floor(diff/(1000*60*60*24)); } // Render function renderActiveTasks(){ const filtered=filterActiveTasks().sort((a,b)=>{ if(a.status!==b.status){ const order={'active':0,'paused':1,'completed':2}; return order[a.status]-order[b.status]; } if(a.deadline&&b.deadline)return new Date(a.deadline)-new Date(b.deadline); if(a.deadline)return -1; if(b.deadline)return 1; return new Date(b.createdAt)-new Date(a.createdAt); }); const c=document.getElementById('activeTasksContent'); const counter=document.getElementById('activeTasksCount'); const activeCount=state.activeTasks.filter(t=>t.status==='active').length; counter.textContent=activeCount+(activeCount===1?' attivit√† attiva':' attivit√† attive'); if(state.activeTasks.length===0){ c.innerHTML='<div class="task-empty-state"><div class="task-empty-state-emoji">‚úì</div><div class="task-empty-state-text">Nessun compito</div><div class="task-empty-state-hint">Aggiungi il tuo primo compito per iniziare</div></div>'; return; } if(filtered.length===0){ c.innerHTML='<div class="task-empty-state"><div class="task-empty-state-emoji">üîç</div><div class="task-empty-state-text">Nessun risultato</div><div class="task-empty-state-hint">Prova un altro filtro</div></div>'; return; } let h='<div style="padding:0 20px">'; filtered.forEach(task=>{ const daysUntil=getDaysUntilDeadline(task.deadline); const daysSince=getDaysSinceUpdate(task.lastUpdatedAt); let cardClass='task-card'; let deadlineClass=''; let deadlineText=''; if(task.status==='completed')cardClass+=' completed'; else if(task.status==='paused')cardClass+=' paused'; else if(daysUntil!==null){ if(daysUntil<0){ cardClass+=' overdue'; deadlineClass='urgent'; deadlineText='‚ö†Ô∏è Scaduto '+Math.abs(daysUntil)+' giorni fa'; }else if(daysUntil===0){ cardClass+=' near-deadline'; deadlineClass='urgent'; deadlineText='‚è∞ Scade oggi'; }else if(daysUntil===1){ cardClass+=' near-deadline'; deadlineClass='soon'; deadlineText='‚è∞ Scade domani'; }else if(daysUntil<=state.notificationSettings.deadlineWarningDays){ cardClass+=' near-deadline'; deadlineClass='soon'; deadlineText='‚è∞ Scade tra '+daysUntil+' giorni'; }else{ deadlineText='üìÖ Scade tra '+daysUntil+' giorni'; } } h+='<div class="'+cardClass+'">'; h+='<div class="task-card-header">'; h+='<input type="checkbox" class="task-card-checkbox" '+(task.status==='completed'?'checked':'')+' onclick="toggleTaskComplete('+task.id+')">'; h+='<div class="task-card-main">'; h+='<div class="task-card-name">'+task.name+'</div>'; h+='<div class="task-card-meta">'; if(task.category){ const emoji=getCategoryEmoji(task.category); h+='<span class="task-card-category">'+emoji+' '+task.category+'</span>'; } if(deadlineText){ h+='<span class="task-card-deadline '+deadlineClass+'">'+deadlineText+'</span>'; } if(daysSince>=state.notificationSettings.taskStuckDays&&task.status==='active'){ h+='<span style="color:var(--accent-warm)">üí≠ Fermo da '+daysSince+' giorni</span>'; } h+='</div>'; h+='</div>'; h+='</div>'; if(task.notes){ h+='<div class="task-card-notes">'+task.notes+'</div>'; } h+='<div class="task-card-actions">'; if(task.status==='active'){ h+='<button class="task-card-action-btn" onclick="pauseTask('+task.id+')" title="Metti in pausa">‚è∏Ô∏è</button>'; }else if(task.status==='paused'){ h+='<button class="task-card-action-btn" onclick="resumeTask('+task.id+')" title="Riprendi">‚ñ∂Ô∏è</button>'; } h+='<button class="task-card-action-btn" onclick="showEditTaskModal('+task.id+')" title="Modifica">‚úèÔ∏è</button>'; h+='<button class="task-card-action-btn" onclick="deleteTask('+task.id+')" title="Elimina">üóëÔ∏è</button>'; h+='</div>'; h+='</div>'; }); h+='</div>'; c.innerHTML=h; } // Task actions function toggleTaskComplete(id){ const task=state.activeTasks.find(t=>t.id===id); if(!task)return; if(task.status==='completed'){ task.status='active'; task.lastUpdatedAt=new Date().toISOString(); showToast('‚ñ∂Ô∏è Compito riattivato'); }else{ task.status='completed'; task.lastUpdatedAt=new Date().toISOString(); addGardenPoints(10,'Compito completato'); showToast('‚úì Compito completato! +10 punti'); } saveState(); renderActiveTasks(); checkAndScheduleNotifications(); } function pauseTask(id){ const task=state.activeTasks.find(t=>t.id===id); if(!task)return; task.status='paused'; task.lastUpdatedAt=new Date().toISOString(); saveState(); renderActiveTasks(); showToast('‚è∏Ô∏è Compito in pausa'); } function resumeTask(id){ const task=state.activeTasks.find(t=>t.id===id); if(!task)return; task.status='active'; task.lastUpdatedAt=new Date().toISOString(); saveState(); renderActiveTasks(); showToast('‚ñ∂Ô∏è Compito ripreso'); checkAndScheduleNotifications(); } function deleteTask(id){ if(!confirm('Vuoi davvero eliminare questo compito?\n\nQuesta azione non pu√≤ essere annullata.'))return; state.activeTasks=state.activeTasks.filter(t=>t.id!==id); saveState(); renderActiveTasks(); showToast('üóëÔ∏è Compito eliminato'); } // Notifications function requestNotificationPermission(){ if(!('Notification' in window)){ showToast('‚ùå Notifiche non supportate'); return; } if(Notification.permission==='granted'){ state.notificationSettings.enabled=true; saveState(); showToast('‚úì Notifiche gi√† attive'); checkAndScheduleNotifications(); return; } if(Notification.permission!=='denied'){ Notification.requestPermission().then(permission=>{ if(permission==='granted'){ state.notificationSettings.enabled=true; saveState(); showToast('‚úì Notifiche attivate'); checkAndScheduleNotifications(); }else{ showToast('‚ùå Notifiche rifiutate'); } }); } } function checkAndScheduleNotifications(){ if(!state.notificationSettings.enabled||!('Notification' in window)||Notification.permission!=='granted')return; state.activeTasks.filter(t=>t.status==='active').forEach(task=>{ const daysSince=getDaysSinceUpdate(task.lastUpdatedAt); const daysUntil=getDaysUntilDeadline(task.deadline); if(daysSince>=state.notificationSettings.taskStuckDays){ scheduleNotification(task.id,'stuck',{ title:'üí≠ '+task.name, body:'Questo compito √® fermo da '+daysSince+' giorni. Va bene se non sei pronto, ma volevo ricordartelo.', tag:'task-stuck-'+task.id }); } if(daysUntil!==null&&daysUntil<=state.notificationSettings.deadlineWarningDays&&daysUntil>=0){ let body=''; if(daysUntil===0)body='La scadenza √® oggi. Respira, puoi farcela.'; else if(daysUntil===1)body='La scadenza √® domani. Un passo alla volta.'; else body='La scadenza √® tra '+daysUntil+' giorni.'; scheduleNotification(task.id,'deadline',{ title:'‚è∞ '+task.name, body:body, tag:'task-deadline-'+task.id }); } }); } function scheduleNotification(taskId,type,options){ if(!state.notificationSettings.enabled||!('Notification' in window)||Notification.permission!=='granted')return; const notifKey='notif-'+taskId+'-'+type; const lastShown=localStorage.getItem(notifKey); const now=Date.now(); if(lastShown&&now-parseInt(lastShown)<86400000)return; new Notification(options.title,{ body:options.body, tag:options.tag, icon:'/icon-192.png', badge:'/icon-192.png', requireInteraction:false }); localStorage.setItem(notifKey,now.toString()); } function linkTaskToHistory(taskId,historyId){ const task=state.activeTasks.find(t=>t.id===taskId); if(!task)return; if(!task.relatedHistoryIds.includes(historyId)){ task.relatedHistoryIds.push(historyId); task.lastUpdatedAt=new Date().toISOString(); saveState(); } } 