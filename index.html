<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="Il tuo supporto per i momenti difficili. Capisci cosa ti succede e trova strategie per affrontarlo. App per la gestione dell'ADHD.">
  <meta name="keywords" content="ADHD, supporto, salute mentale, benessere, mindfulness, gestione emozioni">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Come Stai?">
  <meta name="application-name" content="Come Stai?">
  <meta name="format-detection" content="telephone=no">
  <title>Come Stai? - Supporto ADHD</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{--bg-deep:#1a1a2e;--bg-card:#25253d;--bg-elevated:#2d2d4a;--accent-calm:#7eb8da;--accent-warm:#e8a87c;--accent-soft:#c3aed6;--accent-green:#7dd3a8;--accent-coral:#e07a7a;--text-primary:#f0f0f5;--text-secondary:#a0a0b8;--text-muted:#6a6a82;--radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-full:100px;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,20px)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Nunito',sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.6}
    .app{height:100%;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
    .screen{display:none;flex-direction:column;height:100%;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .screen.active{display:flex}
    .home-screen{justify-content:center;align-items:center;text-align:center;padding:60px 24px 40px;display:flex;flex-direction:column;width:100%}
    .home-greeting{font-size:1.1rem;color:var(--text-secondary);margin-bottom:12px}
    .home-question{font-size:2rem;font-weight:800;margin-bottom:50px;line-height:1.3;max-width:400px}
    .home-main-btn{position:relative;width:240px;height:240px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);font-family:inherit;font-size:0.95rem;font-weight:700;cursor:pointer;box-shadow:0 20px 60px rgba(126,184,218,0.3);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;margin-bottom:50px;padding:20px}
    .home-main-btn:active{transform:scale(0.95)}
    .garden-pause-btn{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,0.9);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:all 0.2s;z-index:10}
    .garden-pause-btn:hover{transform:scale(1.1);background:white}
    .garden-pause-btn:active{transform:scale(0.95)}
    .garden-emoji{font-size:3rem;line-height:1}
    .garden-level{font-size:0.75rem;font-weight:600;opacity:0.8;letter-spacing:0.5px}
    .garden-points{font-size:0.85rem;font-weight:600;opacity:0.9}
    .main-btn-text{font-size:1rem;margin-top:4px}
    .home-actions{display:flex;flex-direction:column;gap:12px;width:300px;margin-bottom:40px}
    .home-action-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:18px 24px;border-radius:var(--radius-lg);border:1px solid var(--bg-elevated);background:var(--bg-card);color:var(--text-secondary);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;width:100%}
    .home-action-btn:active{background:var(--bg-elevated);transform:scale(0.98)}
    .home-secondary{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:350px}
    .home-sec-btn{padding:12px 20px;border-radius:var(--radius-full);border:1px solid var(--bg-elevated);background:transparent;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer}
    .app-footer{margin-top:40px;padding:20px 16px;text-align:center;font-size:0.75rem;color:var(--text-muted);line-height:1.6}
    .app-footer a{color:var(--text-muted);text-decoration:none;transition:color 0.2s}
    .app-footer a:hover{color:var(--text-secondary)}
    .flow-header{display:flex;align-items:center;gap:16px;margin-bottom:30px;padding-top:10px}
    .back-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-secondary);font-size:1.25rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .flow-progress{flex:1;height:4px;background:var(--bg-elevated);border-radius:2px;overflow:hidden}
    .flow-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-calm),var(--accent-soft));transition:width 0.4s}
    .flow-step{font-size:0.85rem;color:var(--text-muted)}
    .flow-question{font-size:1.5rem;font-weight:700;margin-bottom:12px}
    .flow-subtitle{color:var(--text-secondary);font-size:1rem;margin-bottom:30px}
    .options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .option-card{background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);padding:20px 16px;cursor:pointer;text-align:center;transition:all 0.2s}
    .option-card:active{transform:scale(0.97)}
    .option-card.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .option-card .emoji{font-size:2rem;margin-bottom:10px;display:block}
    .option-card .label{font-size:0.9rem;font-weight:600}
    .triggers-list{display:flex;flex-direction:column;gap:10px}
    .trigger-card{background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);padding:18px 20px;cursor:pointer;display:flex;align-items:center;gap:14px}
    .trigger-card.selected{border-color:var(--accent-warm);background:rgba(232,168,124,0.1)}
    .trigger-card .emoji{font-size:1.5rem}
    .trigger-card .label{font-size:0.95rem;font-weight:600}
    .intensity-section{margin-top:24px}
    .intensity-label{display:flex;justify-content:space-between;margin-bottom:16px;font-size:0.9rem;color:var(--text-secondary)}
    .intensity-value{font-weight:700;color:var(--text-primary)}
    .intensity-bar{display:flex;gap:8px}
    .intensity-dot{flex:1;height:50px;border-radius:var(--radius-sm);border:2px solid var(--bg-elevated);background:var(--bg-card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text-muted)}
    .intensity-dot.selected{border-color:var(--accent-warm);background:rgba(232,168,124,0.15);color:var(--accent-warm)}
    .response-screen{padding:20px;padding-bottom:40px}
    .response-header{text-align:center;margin-bottom:24px}
    .response-emoji{font-size:3rem;margin-bottom:12px}
    .response-title{font-size:1.3rem;font-weight:700;margin-bottom:6px}
    .response-feeling{color:var(--accent-calm);font-weight:600}
    .understanding-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:20px}
    .understanding-title{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--accent-soft);margin-bottom:10px}
    .understanding-text{font-size:0.95rem;color:var(--text-secondary);line-height:1.6}
    .understanding-text strong{color:var(--text-primary)}
    .guided-actions{margin-bottom:24px}
    .guided-actions-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .guided-action-card{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;border:1px solid transparent}
    .guided-action-card:active{border-color:var(--accent-calm)}
    .guided-action-icon{width:48px;height:48px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.5rem;background:rgba(126,184,218,0.15)}
    .guided-action-info{flex:1}
    .guided-action-name{font-weight:700;font-size:0.95rem}
    .guided-action-desc{font-size:0.8rem;color:var(--text-muted)}
    .guided-action-arrow{color:var(--text-muted);font-size:1.2rem}
    .strategies-section{margin-bottom:24px}
    .strategies-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .strategy-card{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:10px;border-left:3px solid var(--accent-green);transition:all 0.2s}
    .strategy-card:hover{background:var(--bg-elevated);transform:translateX(4px)}
    .strategy-card:active{transform:scale(0.98)}
    .strategy-card.secondary{border-left-color:var(--accent-calm)}
    .strategy-name{font-weight:700;font-size:0.95rem;margin-bottom:4px}
    .strategy-desc{font-size:0.85rem;color:var(--text-secondary);line-height:1.5}
    .feedback-section{text-align:center;padding:16px 0}
    .feedback-question{font-size:0.9rem;color:var(--text-secondary);margin-bottom:12px}
    .feedback-btns{display:flex;justify-content:center;gap:12px}
    .feedback-btn{padding:10px 20px;border-radius:var(--radius-full);border:1px solid var(--bg-elevated);background:var(--bg-card);color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer}
    .feedback-btn.selected.positive{background:rgba(125,211,168,0.15);border-color:var(--accent-green);color:var(--accent-green)}
    .feedback-btn.selected.negative{background:rgba(224,122,122,0.15);border-color:var(--accent-coral);color:var(--accent-coral)}
    .timer-screen,.breathe-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px}
    .timer-title,.breathe-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .timer-subtitle,.breathe-subtitle{color:var(--text-secondary);font-size:0.95rem;margin-bottom:40px}
    .timer-circle{width:200px;height:200px;position:relative;margin-bottom:40px}
    .timer-circle svg{transform:rotate(-90deg)}
    .timer-circle circle{fill:none;stroke-width:8}
    .timer-circle .bg{stroke:var(--bg-elevated)}
    .timer-circle .progress{stroke:var(--accent-calm);stroke-linecap:round;transition:stroke-dashoffset 1s linear}
    .timer-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;font-weight:800}
    .timer-controls,.breathe-controls{display:flex;gap:16px}
    .timer-btn{padding:16px 32px;border-radius:var(--radius-full);border:none;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .timer-btn.primary{background:var(--accent-calm);color:var(--bg-deep)}
    .timer-btn.secondary{background:var(--bg-card);color:var(--text-secondary)}
    .timer-done{display:none;flex-direction:column;align-items:center;gap:16px}
    .timer-done.show{display:flex}
    .timer-done-emoji{font-size:4rem}
    .timer-done-text{font-size:1.2rem;font-weight:700}
    .breathe-circle{width:180px;height:180px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));display:flex;align-items:center;justify-content:center;margin-bottom:30px;transition:transform 4s ease-in-out;box-shadow:0 0 60px rgba(195,174,214,0.3)}
    .breathe-circle.inhale{transform:scale(1.3)}
    .breathe-circle.exhale{transform:scale(1)}
    .breathe-instruction{font-size:1.5rem;font-weight:700;color:var(--bg-deep)}
    .breathe-counter{font-size:1.1rem;color:var(--text-secondary);margin-bottom:40px}
    .dump-screen,.ground-screen{padding:20px;padding-bottom:120px}
    .dump-header,.ground-header{text-align:center;margin-bottom:24px}
    .dump-emoji,.ground-emoji{font-size:2.5rem;margin-bottom:12px}
    .dump-title,.ground-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .dump-subtitle,.ground-subtitle{color:var(--text-secondary);font-size:0.9rem}
    .dump-textarea{width:100%;min-height:250px;padding:20px;background:var(--bg-card);border:2px solid var(--bg-elevated);border-radius:var(--radius-lg);color:var(--text-primary);font-family:inherit;font-size:1rem;line-height:1.6;resize:none}
    .dump-textarea:focus{outline:none;border-color:var(--accent-warm)}
    .dump-tip{margin-top:16px;padding:14px;background:rgba(232,168,124,0.1);border-radius:var(--radius-md);font-size:0.85rem;color:var(--accent-warm)}
    .dump-actions{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;display:flex;gap:12px}
    .dump-actions .btn{flex:1;padding:16px;border-radius:var(--radius-lg);border:none;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .dump-actions .btn.primary{background:var(--accent-warm);color:var(--bg-deep)}
    .dump-actions .btn.secondary{background:var(--bg-card);color:var(--text-secondary)}
    .ground-step{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:12px;display:flex;align-items:flex-start;gap:16px;border:2px solid transparent}
    .ground-step.active{border-color:var(--accent-green);background:rgba(125,211,168,0.08)}
    .ground-step.done{opacity:0.5}
    .ground-step-num{width:36px;height:36px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem}
    .ground-step.active .ground-step-num{background:var(--accent-green);color:var(--bg-deep)}
    .ground-step-content{flex:1}
    .ground-step-title{font-weight:700;margin-bottom:4px}
    .ground-step-desc{font-size:0.85rem;color:var(--text-secondary)}
    .ground-step-input{margin-top:12px;display:none}
    .ground-step.active .ground-step-input{display:block}
    .ground-input-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .ground-input-item{padding:8px 14px;background:var(--bg-elevated);border:1px solid transparent;border-radius:var(--radius-full);color:var(--text-secondary);font-family:inherit;font-size:0.85rem}
    .ground-input-item:focus{outline:none;border-color:var(--accent-green)}
    .ground-next-btn{margin-top:12px;padding:12px 24px;background:var(--accent-green);color:var(--bg-deep);border:none;border-radius:var(--radius-full);font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer}
    .diary-screen{padding:20px}
    .diary-header,.insights-header{margin-bottom:24px}
    .diary-title,.insights-title{font-size:1.5rem;font-weight:800;margin-bottom:6px}
    .diary-subtitle,.insights-subtitle{color:var(--text-secondary);font-size:0.95rem}
    .diary-new-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:18px;background:linear-gradient(135deg,var(--accent-warm),var(--accent-coral));color:white;border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:24px}
    .diary-entries-title{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:12px}
    .diary-entry{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;cursor:pointer}
    .diary-entry-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .diary-entry-emoji{font-size:1.5rem}
    .diary-entry-meta{flex:1}
    .diary-entry-date{font-weight:600;font-size:0.9rem}
    .diary-entry-time{font-size:0.8rem;color:var(--text-muted)}
    .diary-entry-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .diary-entry-intensity{display:flex;gap:3px}
    .diary-intensity-dot{width:8px;height:8px;border-radius:2px;background:var(--bg-elevated)}
    .diary-intensity-dot.filled{background:var(--accent-warm)}
    .diary-new-screen{padding:20px;padding-bottom:120px}
    .diary-new-header{text-align:center;margin-bottom:24px}
    .diary-new-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .diary-section-label{font-size:0.9rem;font-weight:600;margin-bottom:12px}
    .diary-mood-grid{display:flex;justify-content:space-between;gap:8px}
    .diary-mood-btn{flex:1;padding:14px 8px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);cursor:pointer;text-align:center}
    .diary-mood-btn.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .diary-mood-btn .emoji{font-size:1.5rem;display:block;margin-bottom:4px}
    .diary-mood-btn .label{font-size:0.7rem;color:var(--text-muted)}
    .diary-text-section{margin-bottom:20px}
    .diary-text-input{width:100%;min-height:150px;padding:16px;background:var(--bg-card);border:2px solid var(--bg-elevated);border-radius:var(--radius-lg);color:var(--text-primary);font-family:inherit;font-size:1rem;line-height:1.6;resize:none}
    .diary-text-input:focus{outline:none;border-color:var(--accent-calm)}
    .diary-prompts{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .diary-prompt{padding:8px 14px;background:var(--bg-card);border:1px solid var(--bg-elevated);border-radius:var(--radius-full);font-size:0.8rem;color:var(--text-secondary);cursor:pointer}
    .diary-save-btn{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;padding:18px;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .diary-detail-screen{padding:20px}
    .diary-detail-header{text-align:center;padding:20px 0;border-bottom:1px solid var(--bg-elevated);margin-bottom:20px}
    .diary-detail-emoji{font-size:3rem;margin-bottom:12px}
    .diary-detail-date{font-size:1.1rem;font-weight:700}
    .diary-detail-time{color:var(--text-muted);font-size:0.9rem}
    .diary-detail-content{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:20px}
    .diary-detail-text{font-size:1rem;line-height:1.7;color:var(--text-secondary)}
    .diary-delete-btn{width:100%;padding:14px;background:rgba(224,122,122,0.1);border:none;border-radius:var(--radius-lg);color:var(--accent-coral);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer}
    .insight-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:14px}
    .insight-card-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .insight-card-emoji{font-size:1.4rem}
    .insight-card-title{font-weight:700;font-size:0.95rem}
    .insight-card-content{font-size:0.9rem;color:var(--text-secondary);line-height:1.6}
    .insight-highlight{color:var(--accent-calm);font-weight:600}
    .continue-btn{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;padding:18px;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1.05rem;font-weight:700;cursor:pointer;display:none;z-index:100}
    .continue-btn.show{display:block}
    .close-btn{position:fixed;top:calc(var(--safe-top) + 16px);right:20px;width:44px;height:44px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-secondary);font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:100}
    .notes-section{margin-top:20px}
    .notes-label{font-size:0.9rem;color:var(--text-secondary);margin-bottom:10px}
    .notes-input{width:100%;padding:16px;background:var(--bg-elevated);border:2px solid var(--bg-elevated);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:1rem;resize:none;min-height:80px}
    .notes-input:focus{outline:none;border-color:var(--accent-calm)}
    .empty-state{text-align:center;padding:50px 20px}
    .empty-state .emoji{font-size:3.5rem;margin-bottom:16px}
    .empty-state h3{font-size:1.1rem;margin-bottom:8px}
    .empty-state p{color:var(--text-muted);font-size:0.9rem}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-elevated);color:var(--text-primary);padding:16px 28px;border-radius:var(--radius-full);font-weight:600;box-shadow:0 10px 40px rgba(0,0,0,0.3);opacity:0;transition:all 0.3s;z-index:200}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .report-option{margin-bottom:20px}
    .report-option-label{display:block;font-size:0.9rem;font-weight:700;margin-bottom:12px;color:var(--text-primary)}
    .report-checkbox{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .report-checkbox:active{transform:scale(0.98)}
    .report-checkbox.checked{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .report-checkbox input{width:22px;height:22px;cursor:pointer;accent-color:var(--accent-calm)}
    .report-checkbox-label{flex:1;font-size:0.95rem;font-weight:600}
    .report-period{display:flex;gap:10px;margin-bottom:16px}
    .report-period-btn{flex:1;padding:14px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);color:var(--text-secondary);font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s}
    .report-period-btn:active{transform:scale(0.97)}
    .report-period-btn.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1);color:var(--text-primary)}
    .report-download-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1.05rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:24px}
    .report-download-btn:active{transform:scale(0.98)}
    .generate-report-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:10px}
    .filter-chip{padding:8px 14px;background:rgba(160,160,184,0.1);border:1px solid rgba(160,160,184,0.2);border-radius:20px;font-size:0.85rem;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all 0.2s;font-family:inherit}
    .filter-chip:hover{background:rgba(160,160,184,0.15);border-color:rgba(160,160,184,0.3)}
    .filter-chip.selected{background:var(--accent-calm);color:white;border-color:var(--accent-calm)}
    .history-card{background:var(--card-bg);border:1px solid rgba(160,160,184,0.15);border-radius:12px;padding:16px;margin-bottom:12px}
    .history-card-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px}
    .history-card-emoji{font-size:1.8rem;line-height:1}
    .history-card-main{flex:1}
    .history-card-feeling{font-weight:700;font-size:1rem;color:var(--text-primary);margin-bottom:4px}
    .history-card-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:0.85rem;color:var(--text-muted)}
    .history-card-trigger{color:var(--text-secondary);font-size:0.9rem}
    .history-card-task{display:flex;align-items:center;gap:6px;margin-top:8px;padding:8px 10px;background:rgba(126,184,218,0.1);border-radius:8px;font-size:0.85rem}
    .history-card-strategy{display:flex;align-items:center;gap:6px;margin-top:6px;padding:8px 10px;background:rgba(126,200,126,0.1);border-radius:8px;font-size:0.85rem;color:var(--accent-green)}
    .history-card-strategy.incomplete{background:rgba(160,160,184,0.1);color:var(--text-muted)}
    .history-card-actions{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(160,160,184,0.1)}
    .edit-btn,.delete-btn{flex:1;padding:8px 12px;border:none;border-radius:8px;font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
    .edit-btn{background:rgba(126,184,218,0.15);color:var(--accent-calm)}
    .edit-btn:hover{background:var(--accent-calm);color:white;transform:scale(1.02)}
    .edit-btn:active{transform:scale(0.98)}
    .delete-btn{background:rgba(224,122,122,0.15);color:var(--accent-coral)}
    .delete-btn:hover{background:var(--accent-coral);color:white;transform:scale(1.02)}
    .delete-btn:active{transform:scale(0.98)}
  </style>
</head>
<body>
  <div class="app">
    <div class="screen" id="legalScreen">
      <div class="legal-screen">
        <div class="legal-header">
          <div class="legal-icon">‚öñÔ∏è</div>
          <h1 class="legal-title">Termini e Condizioni</h1>
          <p class="legal-subtitle">Prima di iniziare, leggi attentamente</p>
        </div>

        <div class="legal-warning">
          <div class="legal-warning-title">
            <span>‚ö†Ô∏è</span>
            <span>DISCLAIMER MEDICO IMPORTANTE</span>
          </div>
          <div class="legal-warning-text">
            <p style="margin-bottom:10px"><strong>Questa app NON √® un dispositivo medico</strong> e NON sostituisce la consulenza professionale di medici, psicologi o psichiatri.</p>
            <p style="margin-bottom:10px">√à uno strumento di <strong>auto-aiuto educativo</strong> per il benessere personale.</p>
            <p><strong>In caso di emergenza, contatta il 112 o il tuo medico.</strong></p>
          </div>
        </div>

        <div class="legal-section">
          <div class="legal-section-title">üì± Cosa fa questa app</div>
          <div class="legal-section-text">
            L'app ti aiuta a:
            <ul>
              <li>Identificare emozioni e trigger</li>
              <li>Scoprire strategie di gestione</li>
              <li>Tenere un diario personale</li>
              <li>Analizzare pattern comportamentali</li>
            </ul>
          </div>
        </div>

        <div class="legal-section">
          <div class="legal-section-title">üîí Privacy e dati</div>
          <div class="legal-section-text">
            I tuoi dati sono <strong>salvati solo sul tuo dispositivo</strong>. Non vengono mai inviati a server esterni. L'autore NON ha accesso ai tuoi dati personali.
          </div>
        </div>

        <div class="legal-section">
          <div class="legal-section-title">‚ö†Ô∏è Limitazione di responsabilit√†</div>
          <div class="legal-section-text">
            L'autore declina ogni responsabilit√† per danni derivanti dall'uso dell'app. L'app √® fornita "cos√¨ com'√®" senza garanzie. <strong>Utilizzi a tuo rischio.</strong>
          </div>
        </div>

        <div class="legal-section">
          <div class="legal-section-title">¬©Ô∏è Copyright</div>
          <div class="legal-section-text">
            Tutti i diritti riservati. √à concesso solo il diritto di utilizzare l'app per uso personale. <strong>Vietate copia, modifica e distribuzione.</strong>
          </div>
        </div>

        <div class="legal-links">
          <a href="TERMINI.md" target="_blank" class="legal-link-btn">üìÑ Termini completi</a>
          <a href="PRIVACY.md" target="_blank" class="legal-link-btn">üîí Privacy Policy</a>
        </div>

        <div class="legal-consent">
          <div class="legal-checkbox-container">
            <input type="checkbox" id="consentCheckbox1" onchange="updateAcceptButton()">
            <label for="consentCheckbox1" class="legal-checkbox-label">
              Ho letto e <strong>accetto i Termini e Condizioni</strong> d'uso
            </label>
          </div>
          <div class="legal-checkbox-container">
            <input type="checkbox" id="consentCheckbox2" onchange="updateAcceptButton()">
            <label for="consentCheckbox2" class="legal-checkbox-label">
              Ho letto e compreso la <strong>Privacy Policy</strong>
            </label>
          </div>
          <div class="legal-checkbox-container">
            <input type="checkbox" id="consentCheckbox3" onchange="updateAcceptButton()">
            <label for="consentCheckbox3" class="legal-checkbox-label">
              Comprendo che questa app <strong>NON √® un dispositivo medico</strong> e NON sostituisce la consulenza professionale
            </label>
          </div>
          <div class="legal-checkbox-container">
            <input type="checkbox" id="consentCheckbox4" onchange="updateAcceptButton()">
            <label for="consentCheckbox4" class="legal-checkbox-label">
              Utilizzo l'app <strong>a mio rischio</strong> e l'autore non √® responsabile per conseguenze derivanti dall'uso
            </label>
          </div>
        </div>

        <div class="legal-actions">
          <button class="legal-accept-btn" id="acceptBtn" disabled onclick="acceptTerms()">
            ‚úì Accetto e Continua
          </button>
          <button class="legal-decline-btn" onclick="declineTerms()">
            Rifiuta
          </button>
        </div>

        <div class="legal-footer">
          ¬© 2025 Alo - Come Stai? - Tutti i diritti riservati<br>
          Versione 1.0.2 ‚Ä¢ Ultimo aggiornamento: 19/12/2025
        </div>
      </div>
    </div>
    <div class="screen" id="homeScreen">
      <div class="home-screen">
        <p class="home-greeting" id="greeting">Ciao</p>
        <div id="gardenBadge" style="display:none"></div>
        <h1 class="home-question">Come stai<br>in questo momento?</h1>
        <button class="home-main-btn" onclick="startFlow()">
          <div class="garden-pause-btn" id="gardenPauseBtn" onclick="event.stopPropagation();showGardenPauseModal()" role="button" tabindex="0">‚è∏Ô∏è</div>
          <span class="garden-emoji" id="mainGardenEmoji">üå±</span>
          <span class="garden-level" id="mainGardenLevel">Lv 0</span>
          <span class="garden-points" id="mainGardenPoints">0 punti</span>
          <span class="main-btn-text">Ho bisogno<br>di aiuto</span>
        </button>
        <div class="home-actions">
          <button class="home-action-btn" onclick="showScreen('diaryScreen')">
            <span>üìù</span><span>Scrivi nel diario</span>
          </button>
        </div>
        <div class="home-secondary">
          <button class="home-sec-btn" onclick="showScreen('learnScreen')">üí° Impara</button>
          <button class="home-sec-btn" onclick="showScreen('insightsScreen')">üìä Pattern</button>
          <button class="home-sec-btn" onclick="showScreen('historyScreen')">üìã Storico</button>
          <button class="home-sec-btn" onclick="showScreen('settingsScreen')">‚öôÔ∏è Dati</button>
        </div>
        <div class="app-footer">
          ¬© 2025 Come Stai?<br>
          <a href="TERMINI.md" target="_blank">Termini</a> ‚Ä¢ <a href="PRIVACY.md" target="_blank">Privacy</a> ‚Ä¢ <a href="LICENSE" target="_blank">Licenza</a>
        </div>
      </div>
    </div>
    <div class="screen" id="feelingScreen">
      <div class="flow-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="flow-progress"><div class="flow-progress-fill" style="width:33%"></div></div>
        <span class="flow-step">1/3</span>
      </div>
      <h2 class="flow-question">Come ti senti?</h2>
      <p class="flow-subtitle">Scegli quello che descrive meglio questo momento</p>
      <div class="options-grid" id="feelingsGrid"></div>
      <div class="intensity-section" id="intensitySection" style="display:none">
        <div class="intensity-label"><span>Quanto √® forte?</span><span class="intensity-value" id="intensityValue">3</span></div>
        <div class="intensity-bar">
          <div class="intensity-dot" onclick="setIntensity(1)">1</div>
          <div class="intensity-dot" onclick="setIntensity(2)">2</div>
          <div class="intensity-dot selected" onclick="setIntensity(3)">3</div>
          <div class="intensity-dot" onclick="setIntensity(4)">4</div>
          <div class="intensity-dot" onclick="setIntensity(5)">5</div>
        </div>
      </div>
      <button class="continue-btn" id="feelingContinue" onclick="goToTrigger()">Continua ‚Üí</button>
    </div>
    <div class="screen" id="triggerScreen">
      <div class="flow-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="flow-progress"><div class="flow-progress-fill" style="width:66%"></div></div>
        <span class="flow-step">2/3</span>
      </div>
      <h2 class="flow-question">Cosa stava succedendo?</h2>
      <p class="flow-subtitle">Cosa ha scatenato questa sensazione?</p>
      <div class="triggers-list" id="triggersList"></div>
      <button class="continue-btn" id="triggerContinue" onclick="goToTaskOrResponse()">Continua ‚Üí</button>
    </div>
    <div class="screen" id="taskScreen">
      <div class="flow-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="flow-progress"><div class="flow-progress-fill" style="width:75%"></div></div>
        <span class="flow-step">3/4</span>
      </div>
      <h2 class="flow-question">Quale attivit√†?</h2>
      <p class="flow-subtitle">Cosa devi fare? (aiuta a tracciare cosa funziona)</p>
      <div style="padding:0 24px">
        <input type="text" id="taskInput" class="notes-input" placeholder="es. studiare storia, fare le pulizie..." style="margin-bottom:16px;padding:16px;font-size:1rem">
        <div id="recentTasksList" style="margin-bottom:20px"></div>
        <div class="notes-section">
          <p class="notes-label">Vuoi aggiungere qualcosa? (opzionale)</p>
          <textarea class="notes-input" id="notesInput" placeholder="Descrivi la situazione..."></textarea>
        </div>
      </div>
      <div style="display:flex;gap:12px;padding:0 24px;margin-top:20px">
        <button class="timer-btn secondary" onclick="skipTask()" style="flex:1">Salta</button>
        <button class="continue-btn" id="taskContinue" onclick="generateResponse()" style="flex:2">Dammi una mano ‚Üí</button>
      </div>
    </div>
    <div class="screen" id="responseScreen">
      <button class="close-btn" onclick="finishAndGoHome()">√ó</button>
      <div class="response-screen">
        <div class="response-header">
          <div class="response-emoji" id="responseEmoji">ü§ó</div>
          <h2 class="response-title">Capisco, ti senti <span class="response-feeling" id="responseFeelingText">bloccato</span></h2>
        </div>
        <div class="understanding-card">
          <div class="understanding-title">üí° Cosa sta succedendo</div>
          <p class="understanding-text" id="understandingText"></p>
        </div>
        <div class="guided-actions">
          <h3 class="guided-actions-title">‚ö° Prova subito</h3>
          <div id="guidedActionsList"></div>
        </div>
        <div class="strategies-section">
          <h3 class="strategies-title">üõ†Ô∏è Altre strategie</h3>
          <div id="strategiesList"></div>
        </div>
        <div class="feedback-section">
          <p class="feedback-question">Ti √® stato utile?</p>
          <div class="feedback-btns">
            <button class="feedback-btn positive" onclick="giveFeedback(true)">üëç S√¨</button>
            <button class="feedback-btn negative" onclick="giveFeedback(false)">üëé No</button>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="timerScreen">
      <button class="close-btn" onclick="stopTimer();showScreen('responseScreen')">√ó</button>
      <div class="timer-screen">
        <h2 class="timer-title">‚è±Ô∏è Regola dei 2 minuti</h2>
        <p class="timer-subtitle">Inizia qualsiasi cosa per soli 2 minuti. Spesso basta per sbloccarsi.</p>
        <div class="timer-circle">
          <svg width="200" height="200">
            <circle class="bg" cx="100" cy="100" r="90"/>
            <circle class="progress" id="timerProgress" cx="100" cy="100" r="90" stroke-dasharray="565.48" stroke-dashoffset="0"/>
          </svg>
          <div class="timer-display" id="timerDisplay">2:00</div>
        </div>
        <div class="timer-controls" id="timerControls">
          <button class="timer-btn primary" id="timerStartBtn" onclick="startTimer()">Inizia</button>
          <button class="timer-btn secondary" onclick="stopTimer();showScreen('responseScreen')">Annulla</button>
        </div>
        <div class="timer-done" id="timerDone">
          <div class="timer-done-emoji">üéâ</div>
          <div class="timer-done-text">Ce l'hai fatta!</div>
          <button class="timer-btn primary" onclick="resetTimer()">Altri 2 minuti</button>
          <button class="timer-btn secondary" onclick="showScreen('responseScreen')">Ho finito</button>
        </div>
      </div>
    </div>
    <div class="screen" id="breatheScreen">
      <button class="close-btn" onclick="stopBreathing();showScreen('responseScreen')">√ó</button>
      <div class="breathe-screen">
        <h2 class="breathe-title">üå¨Ô∏è Respira con me</h2>
        <p class="breathe-subtitle">Segui il ritmo. 4 secondi inspira, 4 secondi espira.</p>
        <div class="breathe-circle" id="breatheCircle">
          <span class="breathe-instruction" id="breatheInstruction">Pronto?</span>
        </div>
        <div class="breathe-counter" id="breatheCounter">5 cicli</div>
        <div class="breathe-controls">
          <button class="timer-btn primary" id="breatheStartBtn" onclick="startBreathing()">Inizia</button>
          <button class="timer-btn secondary" onclick="stopBreathing();showScreen('responseScreen')">Chiudi</button>
        </div>
      </div>
    </div>
    <div class="screen" id="dumpScreen">
      <div class="dump-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="dump-header">
          <div class="dump-emoji">üß†</div>
          <h2 class="dump-title">Svuota la mente</h2>
          <p class="dump-subtitle">Scrivi tutto quello che hai in testa. Non deve essere ordinato o sensato.</p>
        </div>
        <textarea class="dump-textarea" id="dumpTextarea" placeholder="Scrivi tutto..."></textarea>
        <div class="dump-tip">üí° Una volta fuori dalla testa, i pensieri pesano meno.</div>
      </div>
      <div class="dump-actions">
        <button class="btn secondary" onclick="showScreen('responseScreen')">Chiudi</button>
        <button class="btn primary" onclick="saveDump()">Fatto ‚úì</button>
      </div>
    </div>
    <div class="screen" id="groundScreen">
      <div class="ground-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="ground-header">
          <div class="ground-emoji">üåø</div>
          <h2 class="ground-title">Torna al presente</h2>
          <p class="ground-subtitle">Tecnica 5-4-3-2-1</p>
        </div>
        <div id="groundingSteps"></div>
      </div>
    </div>
    <div class="screen" id="microStepScreen">
      <button class="close-btn" onclick="showScreen('responseScreen')">√ó</button>
      <div class="timer-screen">
        <h2 class="timer-title">üéØ Micro-step</h2>
        <p class="timer-subtitle">Qual √® il primissimo passo pi√π piccolo che puoi fare? Tipo "apri file", "leggi prima riga".</p>
        <div style="padding:0 20px">
          <textarea class="dump-textarea" id="microStepInput" placeholder="Il mio micro-step √®...&#x0a;&#x0a;Es: Aprire il file&#x0a;Es: Leggere la prima riga&#x0a;Es: Scrivere il titolo" style="min-height:150px;margin:20px 0"></textarea>
          <div class="understanding-card" style="margin-bottom:20px">
            <div class="understanding-title">üí° Perch√© funziona</div>
            <p class="understanding-text">Il cervello ADHD si blocca sui compiti grandi. Un micro-step √® troppo piccolo per spaventare. Spesso, iniziare √® il 90% del lavoro.</p>
          </div>
        </div>
        <div class="timer-controls">
          <button class="timer-btn secondary" onclick="showScreen('responseScreen')">Chiudi</button>
          <button class="timer-btn primary" onclick="completeMicroStep()">L'ho fatto! ‚úì</button>
        </div>
      </div>
    </div>
    <div class="screen" id="strategyDetailScreen">
      <div class="timer-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
          <button class="close-btn" onclick="showScreen('responseScreen')" style="position:static">√ó</button>
        </div>
        <div style="padding:20px;padding-top:0">
          <h2 class="timer-title" id="strategyDetailTitle">Strategia</h2>
          <p class="timer-subtitle" id="strategyDetailDesc">Descrizione</p>
          <div class="understanding-card" style="margin:20px 0">
            <div class="understanding-title">üí° Perch√© funziona</div>
            <p class="understanding-text" id="strategyDetailExplanation">Spiegazione</p>
          </div>
          <div class="timer-controls" style="flex-direction:column;gap:12px">
            <button class="timer-btn primary" id="strategyDetailExecute" onclick="executeStrategyFromDetail()">Inizia ‚Üí</button>
            <button class="timer-btn secondary" onclick="completeStrategyFromDetail()">L'ho fatto ‚úì</button>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="learnScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üí° Impara</h1>
          <p class="insights-subtitle">Comprendi il tuo ADHD</p>
        </div>
        <div id="learnContent"></div>
      </div>
    </div>
    <div class="screen" id="settingsScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">‚öôÔ∏è Gestione Dati</h1>
          <p class="insights-subtitle">Backup e sicurezza</p>
        </div>
        <div style="margin-top:20px">
          <div class="understanding-card" style="margin-bottom:16px">
            <div class="understanding-title">üíæ BACKUP</div>
            <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px">
              Esporta i tuoi dati per creare una copia di sicurezza. Potrai reimportarla in qualsiasi momento.
            </p>
            <button class="timer-btn primary" onclick="exportData()" style="width:100%">
              üì• Scarica Backup
            </button>
          </div>
          <div class="understanding-card" style="margin-bottom:16px">
            <div class="understanding-title">üì§ RIPRISTINO</div>
            <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px">
              Importa un backup precedente per ripristinare i tuoi dati.
            </p>
            <button class="timer-btn secondary" onclick="importData()" style="width:100%;background:var(--accent-calm);color:white">
              üì§ Carica Backup
            </button>
          </div>
          <div class="understanding-card" style="background:rgba(224,122,122,0.1);border:1px solid var(--accent-coral)">
            <div class="understanding-title" style="color:var(--accent-coral)">üóëÔ∏è ZONA PERICOLOSA</div>
            <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px">
              Elimina tutti i dati salvati nell'app. Questa azione √® irreversibile.
            </p>
            <button class="timer-btn secondary" onclick="clearAllData()" style="width:100%;background:var(--accent-coral);color:white">
              ‚ö†Ô∏è Elimina Tutti i Dati
            </button>
          </div>
          <div class="understanding-card" style="margin-top:20px;background:rgba(126,184,218,0.1)">
            <div class="understanding-title">‚ÑπÔ∏è INFO STORAGE</div>
            <p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6">
              I tuoi dati sono salvati localmente nel browser. Per sicurezza, viene creato automaticamente un backup ad ogni salvataggio. I dati pi√π vecchi di 6 mesi vengono archiviati automaticamente se lo storage si riempie.
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="diaryScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-header">
          <h1 class="diary-title">üìù Diario emotivo</h1>
          <p class="diary-subtitle">Cattura i tuoi momenti</p>
        </div>
        <button class="diary-new-btn" onclick="showScreen('diaryNewScreen')">‚úèÔ∏è Nuova nota</button>
        <div class="diary-entries-title">Note recenti</div>
        <div id="diaryEntries"></div>
      </div>
    </div>
    <div class="screen" id="diaryNewScreen">
      <div class="diary-new-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('diaryScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-new-header">
          <h2 class="diary-new-title">Come ti senti ora?</h2>
        </div>
        <div class="diary-mood-section">
          <p class="diary-section-label">Il tuo stato d'animo</p>
          <div class="diary-mood-grid" id="diaryMoodGrid"></div>
        </div>
        <div class="diary-text-section">
          <p class="diary-section-label">Cosa vuoi annotare?</p>
          <textarea class="diary-text-input" id="diaryTextInput" placeholder="Scrivi liberamente..."></textarea>
          <div class="diary-prompts">
            <button class="diary-prompt" onclick="addPrompt('Mi sento cos√¨ perch√©...')">Mi sento cos√¨ perch√©...</button>
            <button class="diary-prompt" onclick="addPrompt('Oggi ho notato che...')">Oggi ho notato...</button>
          </div>
        </div>
      </div>
      <button class="diary-save-btn" onclick="saveDiaryEntry()">Salva nota</button>
    </div>
    <div class="screen" id="diaryDetailScreen">
      <div class="diary-detail-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('diaryScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-detail-header" id="diaryDetailHeader"></div>
        <div class="diary-detail-content">
          <p class="diary-detail-text" id="diaryDetailText"></p>
        </div>
        <button class="diary-delete-btn" onclick="deleteDiaryEntry()">üóëÔ∏è Elimina nota</button>
      </div>
    </div>
    <div class="screen" id="insightsScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üìä I tuoi pattern</h1>
          <p class="insights-subtitle">Cosa abbiamo imparato insieme</p>
        </div>
        <div id="insightsContent"></div>
      </div>
    </div>
    <div class="screen" id="historyScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-header">
          <h1 class="diary-title">üìã Storico</h1>
          <p class="diary-subtitle" id="historyCount">I tuoi momenti</p>
        </div>
        <div style="padding:0 20px 16px">
          <div style="margin-bottom:12px">
            <label style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;display:block;margin-bottom:8px">Periodo</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="filter-chip selected" data-period="all" onclick="setHistoryPeriod('all')">Tutto</button>
              <button class="filter-chip" data-period="week" onclick="setHistoryPeriod('week')">Settimana</button>
              <button class="filter-chip" data-period="month" onclick="setHistoryPeriod('month')">Mese</button>
              <button class="filter-chip" data-period="today" onclick="setHistoryPeriod('today')">Oggi</button>
            </div>
          </div>
          <div>
            <label style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;display:block;margin-bottom:8px">Emozione</label>
            <div id="historyFeelingFilters" style="display:flex;gap:6px;flex-wrap:wrap"></div>
          </div>
        </div>
        <div id="historyContent"></div>
      </div>
    </div>
    <div class="screen" id="reportScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('insightsScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üìñ Il mio percorso ADHD</h1>
          <p class="insights-subtitle">Condividi la tua storia con chi ti aiuta</p>
        </div>
        <div class="report-option">
          <label class="report-option-label">Periodo</label>
          <div class="report-period">
            <button class="report-period-btn selected" onclick="selectReportPeriod(7)">7 giorni</button>
            <button class="report-period-btn" onclick="selectReportPeriod(30)">30 giorni</button>
            <button class="report-period-btn" onclick="selectReportPeriod(0)">Tutto</button>
          </div>
        </div>
        <div class="report-option">
          <label class="report-option-label">Cosa vuoi condividere?</label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludePatterns')">
            <input type="checkbox" id="reportIncludePatterns" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">I miei pattern e trigger</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeHistory')">
            <input type="checkbox" id="reportIncludeHistory" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Momenti in cui ho chiesto aiuto</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeDiary')">
            <input type="checkbox" id="reportIncludeDiary" onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Le mie note personali</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeStrategies')">
            <input type="checkbox" id="reportIncludeStrategies" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Cosa funziona per me</span>
          </label>
        </div>
        <button class="report-download-btn" onclick="generatePDFReport()">
          <span>üì•</span>
          <span>Scarica PDF</span>
        </button>
      </div>
    </div>
    <div class="screen" id="checklistScreen">
      <div class="dump-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="dump-header">
          <div class="dump-emoji" id="checklistEmoji">‚úì</div>
          <h2 class="dump-title" id="checklistTitle">Checklist</h2>
          <p class="dump-subtitle" id="checklistSubtitle">Controlla questi punti</p>
        </div>
        <div id="checklistItems" style="margin:20px 0"></div>
      </div>
      <div class="dump-actions">
        <button class="btn secondary" onclick="showScreen('responseScreen')">Chiudi</button>
        <button class="btn primary" onclick="completeChecklist()">Fatto ‚úì</button>
      </div>
    </div>
    <div class="screen" id="guidedQuestionScreen">
      <div class="dump-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="dump-header">
          <div class="dump-emoji" id="questionEmoji">üí≠</div>
          <h2 class="dump-title" id="questionTitle">Rifletti</h2>
          <p class="dump-subtitle" id="questionPrompt">Prenditi un momento per pensare</p>
        </div>
        <textarea class="dump-textarea" id="questionAnswer" placeholder="La tua risposta..."></textarea>
        <div class="dump-tip">üí° Scrivere aiuta a chiarire i pensieri</div>
      </div>
      <div class="dump-actions">
        <button class="btn secondary" onclick="showScreen('responseScreen')">Chiudi</button>
        <button class="btn primary" onclick="saveGuidedAnswer()">Salva ‚úì</button>
      </div>
    </div>
    <div class="screen" id="guidedTipScreen">
      <div class="dump-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="dump-header">
          <div class="dump-emoji" id="tipEmoji">üí°</div>
          <h2 class="dump-title" id="tipTitle">Strategia</h2>
        </div>
        <div id="tipContent" style="padding:20px;font-size:0.95rem;line-height:1.7;color:var(--text-secondary);white-space:pre-line"></div>
      </div>
      <div class="dump-actions">
        <button class="btn primary" onclick="showScreen('responseScreen')" style="width:100%">Ho capito ‚úì</button>
      </div>
    </div>
    <div class="toast" id="toast"></div>
  </div>
<script>
const feelings=[{id:'blocked',emoji:'üò∂',label:'Bloccato'},{id:'frustrated',emoji:'üò§',label:'Frustrato'},{id:'overwhelmed',emoji:'üåÄ',label:'Sovraccarico'},{id:'down',emoji:'üòî',label:'Gi√π'},{id:'anxious',emoji:'üò∞',label:'Ansioso'},{id:'drained',emoji:'ü•±',label:'Svuotato'},{id:'scattered',emoji:'üå™Ô∏è',label:'Disperso'},{id:'restless',emoji:'‚ö°',label:'Irrequieto'},{id:'hyperfocus',emoji:'üéØ',label:'Iperfocus'},{id:'shame',emoji:'üòû',label:'In colpa'}];
const triggers=[{id:'big_task',emoji:'üìã',label:'Devo iniziare un compito importante'},{id:'too_many',emoji:'üóÇÔ∏è',label:'Troppe cose, non so da dove partire'},{id:'criticized',emoji:'üí¨',label:'Mi hanno criticato'},{id:'mistake',emoji:'‚ùå',label:'Ho fatto un errore'},{id:'distracted',emoji:'üì±',label:'Mi sono distratto'},{id:'deadline',emoji:'‚è∞',label:'Scadenza vicina'},{id:'conflict',emoji:'üí¢',label:'Conflitto con qualcuno'},{id:'tired',emoji:'üò¥',label:'Stanchezza fisica'},{id:'unknown',emoji:'‚ùì',label:'Non so, √® arrivato cos√¨'},{id:'boring_task',emoji:'üòë',label:'Compito noioso ma necessario'},{id:'transition',emoji:'üîÑ',label:'Devo cambiare attivit√†'},{id:'social_event',emoji:'üë•',label:'Evento sociale imminente'},{id:'interruption',emoji:'üîî',label:'Sono stato interrotto'},{id:'waiting',emoji:'‚è≥',label:'Devo aspettare qualcosa'},{id:'decision',emoji:'ü§î',label:'Devo prendere una decisione'},{id:'noise',emoji:'üîä',label:'Troppo rumore/stimoli'},{id:'routine_break',emoji:'üíî',label:'La mia routine √® saltata'}];
const diaryMoods=[{id:'great',emoji:'üòä',label:'Bene'},{id:'okay',emoji:'üòê',label:'Cos√¨ cos√¨'},{id:'low',emoji:'üòî',label:'Gi√π'},{id:'anxious',emoji:'üò∞',label:'Ansioso'},{id:'angry',emoji:'üò§',label:'Irritato'}];
const guidedActions=[{id:'timer',icon:'‚è±Ô∏è',name:'Timer 2 minuti',desc:'Inizia per soli 2 minuti',screen:'timerScreen'},{id:'breathe',icon:'üå¨Ô∏è',name:'Respira con me',desc:'5 cicli di respirazione',screen:'breatheScreen'},{id:'dump',icon:'üß†',name:'Svuota la mente',desc:'Scrivi tutto senza filtri',screen:'dumpScreen'},{id:'ground',icon:'üåø',name:'Torna al presente',desc:'Tecnica 5-4-3-2-1',screen:'groundScreen'},{id:'microstep',icon:'üéØ',name:'Micro-step',desc:'Solo il primissimo passo',screen:'microStepScreen'}];
const strategyExplanations={
'Body doubling':'La presenza di qualcuno riduce la solitudine cognitiva e crea responsabilit√† esterna. Il cervello ADHD lavora meglio con un\'ancora sociale.',
'Versione brutta':'Il perfezionismo blocca l\'inizio. Una versione imperfetta esiste, una perfetta mai iniziata no. Puoi sempre migliorare dopo.',
'Primo micro-step':'Il cervello ADHD si blocca sui compiti grandi. Il primo micro-step bypassa la paralisi perch√© √® troppo piccolo per spaventare.',
'Deadline artificiale':'L\'urgenza attiva adrenalina e dopamina. Crea la pressione necessaria per attivare il cervello ADHD che funziona meglio sotto deadline.',
'Regola dei 3':'Troppe opzioni sovraccaricano la working memory. 3 √® il numero massimo gestibile dal cervello ADHD senza paralisi decisionale.',
'Domanda magica':'Forzare una scelta elimina la paralisi. Se potessi fare solo UNA cosa, il cervello deve decidere invece di girare a vuoto.',
'Esternalizza lista':'Scrivere libera la working memory. Vedere visivamente le opzioni aiuta a scegliere invece di tenerle tutte in testa.',
'Eliminazione rapida':'Ridurre le opzioni riduce il carico cognitivo. Ogni cosa eliminata √® energia risparmiata per ci√≤ che conta.',
'Gamification':'Il gioco produce dopamina. Trasformare un compito noioso in sfida attiva il cervello ADHD che cerca stimoli.',
'Ricompensa dopo':'La dopamina della ricompensa anticipata aiuta a iniziare. Sapere cosa viene dopo crea motivazione esterna.',
'Musica/podcast':'Stimoli extra riempiono il bisogno di dopamina. Il cervello ADHD lavora meglio con doppia stimolazione controllata.',
'Pomodoro da 10':'10 minuti √® abbastanza breve da non spaventare, abbastanza lungo da fare progresso. Spesso basta per sbloccarsi.',
'Ponte mentale':'Finire con successo riduce la resistenza alla transizione. Un mini-win d√† dopamina per affrontare il cambio.',
'Nuovo contesto':'Cambio fisico aiuta il cambio mentale. Il cervello ADHD associa contesti a stati, spostarsi facilita il reset.',
'Chiusura esplicita':'Dire ad alta voce chiude il loop mentale aperto. Il cervello ADHD ha difficolt√† a chiudere task senza rituale esplicito.',
'Buffer 5 minuti':'La pausa vuota permette al cervello di scaricare il contesto precedente prima di caricare il nuovo. Previene sovraccarico.',
'Fatto vs Interpretazione':'RSD fa confondere fatto e interpretazione. Separare i due mostra che la reazione √® amplificata, non reale.',
'Test del tempo':'La prospettiva temporale riduce l\'intensit√† emotiva. Ci√≤ che sembra enorme ora diventa piccolo nel tempo.',
'Scala RSD':'Riconoscere che la reazione √® 10x aiuta a scalare gi√π. La consapevolezza dell\'amplificazione riduce il dolore.',
'Distanza temporale':'24 ore permettono all\'onda RSD di passare. Dopo, la reazione √® pi√π proporzionata e la risposta pi√π chiara.',
'Zoom out':'Il contesto ridimensiona l\'errore. Su 100 cose, 99 vanno bene. L\'errore √® eccezione, non regola.',
'Ripara e vai':'L\'azione ripara la vergogna. Fare qualcosa di concreto sposta da \"sono sbagliato\" a \"ho fatto un errore, ora lo sistemo\".',
'Diario vittorie':'Il cervello ADHD dimentica i successi e ricorda gli errori. Scrivere le vittorie bilancia la narrativa negativa.',
'Sistema, non colpa':'Gli errori ADHD richiedono sistemi, non forza di volont√†. Checklist e reminder funzionano, colpevolizzarsi no.',
'Compassione':'Con ADHD √® normale distrarsi. La compassione riduce la vergogna che peggiora il problema.',
'Normalizza':'Sapere che √® ADHD, non te, riduce la vergogna. 10 persone ADHD = 10 distratte. √à neurologia.',
'Reset ambientale':'Rimuovere stimoli riduce il carico sul filtro attentivo debole. Meno input = pi√π focus.',
'Ancora al presente':'L\'ansia vive nel futuro. Tornare al presente riduce l\'ansia perch√© nel qui-e-ora non c\'√® pericolo.',
'Worst case':'Scrivere lo scenario peggiore mostra che raramente √® catastrofico. L\'ansia amplifica, la scrittura ridimensiona.',
'Micro-azione':'Un passo cos√¨ piccolo bypassa l\'ansia. Il cervello dice \"ok, questo posso farlo\" e l\'azione spezza il blocco.',
'Mini-win':'Il progresso produce dopamina e riduce l\'ansia. Anche piccolo, il movimento avanti calma.',
'Relativizza':'La scala 1-10 ridimensiona. L\'ansia dice 10/10, la realt√† spesso √® 3/10.',
'Triage brutale':'Eliminare ci√≤ che non √® urgente riduce il sovraccarico. Ogni cosa tolta √® energia risparmiata.',
'Una cosa alla volta':'Il multitasking sovraccarica la working memory ADHD. Focus seriale funziona, parallelo blocca.',
'Chiudi tutte le tab':'Ogni tab aperta √® un carico cognitivo. Chiuderle libera memoria mentale per ci√≤ che conta.',
'Lista di 3':'3 √® il numero magico. Pi√π di 3 sovraccarica, meno di 3 sottoutilizza. 3 √® gestibile.',
'Riduzione stimoli':'Cuffie e luce soft riducono input sensoriali. Meno stimoli = meno energia spesa a filtrarli.',
'Break sensoriale':'5 minuti di silenzio e buio resettano il sistema sensoriale sovraccarico. Come riavviare un computer.',
'Rifugio sensoriale':'Avere un posto sicuro riduce l\'ansia da sovraccarico. Sapere dove andare calma.',
'Stimming controllato':'Fidget permette al corpo di scaricare energia irrequieta senza disturbare il focus. Movimento mirato.',
'Dimezza opzioni':'Ogni opzione consuma energia decisionale. Dimezzare libera energia per la scelta finale.',
'Flip a coin':'La moneta decide quando tu non puoi. Elimina la paralisi e spesso rivela la preferenza vera (\"speri che esca X\").',
'Timer di decisione':'Il limite temporale forza la scelta. La paralisi finisce quando il tempo finisce.',
'Delega decisione':'Quando l\'energia decisionale √® zero, delegare √® strategia valida. Non √® debolezza, √® efficienza.',
'Mini-routine':'Anche 3 passi ripetibili creano struttura. La routine sostituisce la decisione, risparmiando energia.',
'Ancora esterna':'Timer, posto, rituale sono protesi cognitive. Il cervello ADHD ha bisogno di ancore esterne.',
'Routine di emergenza':'Versione minima per giorni caotici. Meglio routine ridotta che nessuna routine.',
'Rituale reset':'Respiro-acqua-lista √® reset rapido. Quando tutto salta, questo ricrea un minimo di struttura.',
'Separa ansia da fatto':'L\'ansia √® emozione, il fatto √® realt√†. Separarli mostra che spesso l\'ansia mente.',
'Mini-task':'Lista di cose da 2 minuti riempie il bisogno di azione. Il cervello ADHD vuole fare, dare micro-task calma.',
'Fidget strategico':'Movimento ripetitivo occupa l\'irrequietezza senza richiedere attenzione. Penna, stress ball, respiro.',
'Phone time-box':'5 minuti con timer previene il buco nero dello scroll. Il limite contiene l\'impulsivit√†.',
'Cammina':'Movimento fisico scarica energia irrequieta. 5 minuti di cammino resettano il sistema nervoso.',
'Quiet stillness':'Osservare senza fare calma il cervello iperattivo. Sdraiato, occhi aperti, solo osservare.',
'Stretching dolce':'Movimento lento senza cardio rilassa il corpo senza eccitare il cervello. Reset gentile.',
'White noise':'Rumore costante maschera stimoli variabili. Il cervello ADHD si calma con input prevedibile.',
'Body scan':'Attenzione progressiva al corpo sposta focus da pensieri a sensazioni. Grounding somatico.',
'Snapshot mentale':'Scrivere veloce cattura lo stato pre-interruzione. Permette ricostruzione dopo.',
'Foto schermo':'Screenshot letterale preserva il contesto visivo. Ricostruire √® pi√π facile con immagine.',
'Segnale protezione':'Cuffie o cartello previene interruzioni. Proteggere l\'iperfocus √® legittimo.',
'Accetta e lascia':'L\'iperfocus perso non torna. Accettare riduce frustrazione, respirare permette ricostruzione.',
'Alarm ogni 30min':'Timer ricorrente interrompe l\'iperfocus sulla cosa sbagliata. Check-in regolare mantiene priorit√†.',
'Self-compassion':'Hai ADHD, il cervello funziona cos√¨. Non √® colpa, √® neurologia. Compassione riduce vergogna.',
'Celebra redirect':'Tornare al focus dopo distrazione √® vittoria. Conta come successo, non fallimento.',
'Repair action':'Azione concreta ripara vergogna. Fare qualcosa sposta da emozione paralizzante ad azione costruttiva.',
'Checklist preventiva':'Sistema previene, volont√† fallisce. Checklist funziona perch√© non richiede memoria.',
'Friend perspective':'Useresti compassione per un amico. Merita la stessa compassione da te.',
'Fonte check':'Chi critica? Conosce ADHD? Fonte ignara non √® fonte valida.',
'24h rule':'L\'onda RSD passa in 24 ore. Aspettare previene reazione amplificata che peggiora tutto.',
'Vittorie recenti':'Scrivere successi bilancia il bias negativo. Il cervello ADHD dimentica vittorie, va ricordato.',
'Permesso di fermarti':'Riposare √® produttivo per il cervello ADHD che lavora pi√π intenso. Non √® pigrizia.',
'Check fisico':'Fame, sete, sonno influenzano energia cognitiva. Check basics prima di assumere problema mentale.',
'Power nap 20min':'20 minuti resettano senza inerzia del sonno. Pi√π lungo causa grogginess, meno non basta.',
'Modalit√† sopravvivenza':'Giorni duri richiedono minimo. Solo essenziale, resto aspetta. Preservare energia.',
'Modalit√† autopilota':'Zero decisioni, solo routine automatiche. Quando energia decisionale √® zero.',
'Elimina scelte':'Ogni scelta consuma energia. Default elimina decisione.',
'Domani decide':'Lista per domani scarica la mente. Oggi solo esegue ci√≤ che √® deciso.',
'Brain dump totale':'Svuotare tutti i pensieri su carta libera RAM mentale. Poi scegliere uno.',
'Focus su uno':'Carta e penna, un compito, timer. Mono-focus funziona per ADHD, multi-focus blocca.',
'Ambiente nudo':'Solo necessario sul tavolo riduce stimoli competitivi. Meno scelte = pi√π focus.',
'Riparti da zero':'Chiudi tutto, respiro, riapri essenziale. Reset completo quando dispersione √® totale.',
'Chiusura rituale':'Dire \"ho finito X\" chiude loop mentale. Il cervello ADHD ha bisogno di chiusura esplicita.',
'Reset fisico':'Alzarsi e camminare 2 min resetta il sistema. Movimento aiuta transizione.',
'Pausa buffer':'5 minuti vuoti tra task permettono scarico contesto vecchio. Previene sovrapposizione mentale.',
'Checklist transizione':'Passi espliciti per chiudere A e aprire B. Rituale riduce energia di switching.',
'Cattura pensieri':'Nota rapida preserva contesto mentale. \"Ero qui, pensavo questo\" permette ricostruzione.',
'Ricostruisci contesto':'Rileggere ultime 5 righe ricarica contesto in memoria. Pi√π facile che ricreare da zero.',
'Segnale busy':'Prevenire √® meglio che riparare. Segnale visibile protegge il focus.',
'Accetta perdita':'Combattere frustrazione consuma energia. Accettare e ricostruire √® pi√π efficiente.',
'Stimolo extra':'Musica energica o podcast aggiunge dopamina. Doppia stimolazione per compito noioso.',
'Sprint 10 min':'10 minuti di intensit√† massima poi break. L\'intensit√† produce dopamina.',
'Ride the wave':'Non combattere l\'emozione, osservarla passare. Resistere amplifica, osservare calma.',
'Nessuna decisione':'Giorni di down non sono per decisioni importanti. Proteggere da scelte che peggioreranno tutto.',
'Attivit√† passiva':'Serie TV, musica permettono al cervello di riposare. Non tutto richiede produttivit√†.',
'Script mentale':'3 frasi pronte riducono ansia sociale. Sapere cosa dire calma.',
'Exit strategy':'Sapere di poter uscire riduce ansia. Il limite temporale contiene la paura.',
'Ruolo sociale':'Fare domande sposta focus da te agli altri. Meno ansia performativa.',
'Time-box':'\"Resto 1 ora\" definisce confine. Il limite riduce l\'ansia dell\'infinito.',
'Pausa prima':'5 respiri prima di rispondere previene reazione impulsiva amplificata da RSD.',
'Fatti vs Paura':'Separare fatto da paura mostra amplificazione. Consapevolezza riduce intensit√†.',
'Scrivi prima':'Buttare tutto su carta scarica l\'emotivit√†. Poi scegliere cosa dire.',
'RSD check':'\"Mia reazione 10x, scala a 1x\" ridimensiona. Consapevolezza amplificazione aiuta.',
'Contenitore vittorie':'Scrivere 3 cose di cui vai fiero contrasta narrativa negativa. Bias positivo intenzionale.',
'Questo non sei tu':'Feedback su azione, non identit√†. Errore non definisce valore.',
'ADHD context':'Critica ignora neurologia? Fonte senza contesto ADHD non √® valida.',
'Timeline di vittorie':'Rileggere note positive ricorda i successi. Memoria ADHD dimentica vittorie.',
'Pattern fix':'Quale sistema previene questo errore? Focus su soluzione, non colpa.',
'Contatore successi':'Quante cose bene oggi? Maggioranza √® successo, errore √® eccezione.',
'Amico ADHD':'Cosa diresti a amico con ADHD? Quella compassione √® per te.'
};
const groundingSteps=[{num:5,sense:'VEDI',desc:'5 cose che vedi',placeholders:['lampada','muro','telefono','finestra','mano']},{num:4,sense:'TOCCA',desc:'4 cose che tocchi',placeholders:['tavolo','tessuto','sedia','pelle']},{num:3,sense:'SENTI',desc:'3 cose che senti',placeholders:['respiro','traffico','musica']},{num:2,sense:'ANNUSA',desc:'2 cose che annusi',placeholders:['aria','caff√®']},{num:1,sense:'GUSTA',desc:'1 cosa che gusti',placeholders:['saliva']}];
const learnTopics=[
  {emoji:'üß†',title:'Cos\'√® l\'ADHD',content:'L\'ADHD √® una <strong>differenza neurologica</strong> che influenza attenzione, impulsi e regolazione emotiva. Non √® pigrizia o mancanza di volont√†. Il tuo cervello funziona in modo diverso.',context:'generale'},
  {emoji:'‚ö°',title:'Deficit di dopamina',content:'Il cervello ADHD produce <strong>meno dopamina</strong>. Per questo cerchi stimoli forti, ti annoi facilmente e hai bisogno di "urgenza" per attivarti.',context:'generale'},
  {emoji:'üéØ',title:'Iperfocus',content:'L\'iperfocus √® quando sei <strong>totalmente assorbito</strong> in un\'attivit√† interessante. √à un superpotere ADHD, ma pu√≤ farti perdere tempo su cose non prioritarie.',context:'lavoro'},
  {emoji:'üíî',title:'RSD - Sensibilit√† al rifiuto',content:'La <strong>Rejection Sensitive Dysphoria</strong> √® quando una critica o un rifiuto ti colpisce 10 volte pi√π forte. √à parte dell\'ADHD, non debolezza.',context:'sociale'},
  {emoji:'‚è∞',title:'Cecit√† temporale',content:'Il cervello ADHD non percepisce il tempo come gli altri. Ci sono solo <strong>"adesso" e "non adesso"</strong>. Per questo le scadenze lontane non ti motivano.',context:'lavoro'},
  {emoji:'üåÄ',title:'Paralisi da analisi',content:'Troppe opzioni causano <strong>blocco decisionale</strong>. Il cervello ADHD va in overload. Soluzione: riduci le scelte drasticamente.',context:'studio'},
  {emoji:'üîã',title:'Energy management',content:'Con ADHD l\'energia mentale √® <strong>limitata</strong>. Ogni decisione, cambio compito o stimolo la consuma. Gestisci l\'energia, non solo il tempo.',context:'lavoro'},
  {emoji:'üì±',title:'Distraibilit√†',content:'Non √® che "non ti concentri". Il tuo cervello <strong>si concentra su tutto</strong> contemporaneamente. Servono barriere esterne (timer, ambiente, body doubling).',context:'studio'},
  {emoji:'üé≤',title:'Ricerca di novit√†',content:'Il cervello ADHD <strong>ama il nuovo</strong>. Per questo inizi mille progetti. Non √® mancanza di impegno, √® bisogno di stimoli freschi.',context:'generale'},
  {emoji:'üõ°Ô∏è',title:'Strategie vs Forza di volont√†',content:'La forza di volont√† non basta con ADHD. Servono <strong>sistemi esterni</strong>: timer, checklist, body doubling, environment design.',context:'lavoro'},
  {emoji:'üò¥',title:'Paradosso stanco/agitato',content:'Con ADHD puoi essere <strong>esausto ma irrequieto</strong>. Il corpo √® stanco, il cervello √® agitato. Servono tecniche di grounding e quiet time.',context:'generale'},
  {emoji:'üîÑ',title:'Task switching',content:'Cambiare attivit√† <strong>costa molto</strong> al cervello ADHD. Serve un rituale di chiusura e uno di apertura per ogni transizione.',context:'lavoro'},
  {emoji:'üíä',title:'Medication & tools',content:'I farmaci possono aiutare, ma non sono magici. Funzionano meglio <strong>insieme a strategie</strong> comportamentali e sistemi di supporto.',context:'generale'},
  {emoji:'üé≠',title:'Masking',content:'Nascondere l\'ADHD per sembrare "normale" consuma <strong>energia immensa</strong>. Va bene mostrare chi sei. L\'ADHD non √® difetto.',context:'sociale'},
  {emoji:'‚úÖ',title:'Sistemi che funzionano',content:'<strong>Timer visivi, body doubling, gamification, chunking, external accountability</strong>. Non cambiare te stesso, cambia l\'ambiente.',context:'studio'}
];
const contextStrategies={
  lavoro:[
    {name:'Pomodoro modificato',desc:'25 min lavoro, 5 min break. Ma puoi accorciare a 15-3 se serve. L\'importante √® il ritmo.'},
    {name:'Body doubling virtuale',desc:'Lavora in videocall con qualcuno, anche in silenzio. La presenza aiuta.'},
    {name:'Un compito alla volta',desc:'Chiudi tutte le tab. Un file. Un compito. Finito quello, prossimo.'},
    {name:'Deadline artificiali',desc:'Crea urgenza falsa. "Devo finire entro le 15:00" anche se la vera deadline √® domani.'}
  ],
  studio:[
    {name:'Chunk down',desc:'Spezza tutto in pezzi da 10-15 minuti. Studia un pezzo, break, prossimo.'},
    {name:'Active recall',desc:'Non rileggere. Chiudi il libro e ripeti. L\'ADHD impara facendo, non guardando.'},
    {name:'Cambia location',desc:'Studia in posti diversi. Il cervello ADHD ama la novit√†.'},
    {name:'Insegna a qualcuno',desc:'Spiega ad alta voce. Anche a un pupazzo. L\'output attivo fissa la memoria.'}
  ],
  sociale:[
    {name:'Prepara frasi',desc:'3 frasi pronte per iniziare conversazioni. Toglie il carico mentale dell\'improvvisazione.'},
    {name:'Time-box sociale',desc:'"Resto 1 ora". Sapere che finisce aiuta. Puoi sempre restare di pi√π.'},
    {name:'Safe word',desc:'Con amici fidati, una parola per dire "sono in overload" senza spiegare.'},
    {name:'Recovery time',desc:'Dopo eventi sociali, blocca tempo per ricaricare. Non √® antisociale, √® necessit√†.'}
  ]
};
const responses={
  'blocked_big_task':{understanding:'Quando un compito sembra grande, il cervello ADHD va in <strong>paralisi</strong>. Ecco perch√©:<br><br>Il tuo cervello produce <strong>meno dopamina</strong> delle persone neurotipiche. La dopamina √® il neurotrasmettitore che d√† motivazione e "spinta" all\'azione. Per attivarti hai bisogno di:<br>‚Ä¢ Interesse forte (iperfocus)<br>‚Ä¢ Urgenza/scadenza imminente (adrenalina)<br>‚Ä¢ Novit√†/stimolo (ricerca dopamina)<br><br>Un compito grande non ha nessuna di queste caratteristiche. √à lontano, astratto, noioso.<br><strong>Risultato: paralisi.</strong> Non √® pigrizia. √à neurologia.',actions:['timer','dump'],strategies:[{name:'Body doubling',desc:'Lavora accanto a qualcuno (persona o videocall).'},{name:'Versione brutta',desc:'Fai prima una versione imperfetta in 10 min.'},{name:'Primo micro-step',desc:'Solo il primissimo passo. Tipo "apri file".'},{name:'Deadline artificiale',desc:'Crea urgenza: "finisco entro le 15:00".'}]},
  'blocked_too_many':{understanding:'Troppe opzioni causano <strong>sovraccarico cognitivo</strong>. Il cervello ADHD ha difficolt√† con le <strong>funzioni esecutive</strong> - quella parte che dovrebbe dire "questa √® priorit√† 1, questa 2, questa 3".<br><br>Per te tutto sembra urgente contemporaneamente perch√©:<br>‚Ä¢ La <strong>cecit√† temporale</strong> ti fa vedere solo "adesso" e "non adesso"<br>‚Ä¢ Il deficit di <strong>working memory</strong> rende difficile tenere in testa pi√π opzioni<br>‚Ä¢ La paralisi decisionale blocca l\'azione<br><br>Non √® che sei disorganizzato. Il tuo cervello fa fatica a <strong>filtrare le priorit√†</strong>.',actions:['dump','timer'],strategies:[{name:'Regola dei 3',desc:'Max 3 cose importanti oggi. Cancella il resto.'},{name:'Domanda magica',desc:'"Se potessi fare solo UNA cosa?"'},{name:'Esternalizza lista',desc:'Scrivi tutto su carta. Scegli visivamente.'},{name:'Eliminazione rapida',desc:'Cosa succede se NON fai X? Se niente, togli.'}]},
  'blocked_boring_task':{understanding:'Il cervello ADHD <strong>rifiuta attivamente i compiti noiosi</strong>. Non √® mancanza di disciplina.<br><br>Ecco cosa succede:<br>‚Ä¢ Il tuo cervello cerca costantemente <strong>dopamina</strong> (motivazione)<br>‚Ä¢ I compiti noiosi non producono dopamina<br>‚Ä¢ Il cervello dice "no, questo fa male" e si blocca<br>‚Ä¢ Tu interpreti questo come pigrizia o incapacit√†<br><br>√à lo stesso meccanismo per cui puoi passare ore su cose interessanti (iperfocus) ma non 5 minuti su cose noiose. <strong>Non sei tu. √à il deficit di dopamina.</strong>',actions:['timer','dump'],strategies:[{name:'Gamification',desc:'Crea una sfida: "quanto veloce?"'},{name:'Ricompensa dopo',desc:'Cosa fai DOPO averlo finito?'},{name:'Musica/podcast',desc:'Doppia stimolazione. Orecchie occupate.'},{name:'Pomodoro da 10',desc:'Solo 10 minuti. Poi decidi se continuare.'}]},
  'blocked_transition':{understanding:'Il <strong>task switching</strong> √® una delle difficolt√† pi√π grandi con ADHD.<br><br>Cambiare attivit√† richiede:<br>‚Ä¢ Chiudere il contesto mentale precedente<br>‚Ä¢ Caricare il nuovo contesto in memoria<br>‚Ä¢ Riorientare l\'attenzione<br><br>Per il cervello ADHD questo costa <strong>energia cognitiva enorme</strong>. √à come riavviare un computer ogni volta. Servono rituali di chiusura e apertura per facilitare il passaggio.<br><br>Non √® che sei lento. Stai facendo un lavoro invisibile che altri non devono fare.',actions:['breathe','timer'],strategies:[{name:'Ponte mentale',desc:'Finisci con un mini-win, poi stacca 2 min.'},{name:'Nuovo contesto',desc:'Cambia stanza o posizione fisica.'},{name:'Chiusura esplicita',desc:'D√¨ ad alta voce "ho finito X, ora faccio Y".'},{name:'Buffer 5 minuti',desc:'Pausa vuota tra attivit√†. Reset mentale.'}]},
  'frustrated_criticized':{understanding:'La <strong>Rejection Sensitive Dysphoria (RSD)</strong> √® quando una critica ti colpisce 10 volte pi√π forte.<br><br>Non √® ipersensibilit√† emotiva. √à una caratteristica neurologica dell\'ADHD:<br>‚Ä¢ Il cervello ADHD ha una <strong>disregolazione emotiva</strong><br>‚Ä¢ Le critiche attivano aree del dolore fisico<br>‚Ä¢ La risposta √® immediata, intensa, travolgente<br><br>Una persona neurotipica sente: "Mi ha criticato, va bene".<br>Tu senti: "Mi ha RIFIUTATO, sono orribile, √® la fine".<br><br><strong>Non sei debole. Il tuo cervello amplifica il segnale di rifiuto.</strong>',actions:['breathe','ground'],strategies:[{name:'Fatto vs Interpretazione',desc:'Cosa √® stato DETTO vs cosa INTERPRETO?'},{name:'Test del tempo',desc:'Tra una settimana sar√† ancora grave?'},{name:'Scala RSD',desc:'La mia reazione √® 10/10. Il fatto √®...?'},{name:'Distanza temporale',desc:'24 ore prima di rispondere. L\'onda RSD passa.'}]},
  'frustrated_mistake':{understanding:'Gli errori attivano il <strong>critico interiore</strong> amplificato dall\'ADHD.<br><br>Ecco perch√© ti colpisce cos√¨ forte:<br>‚Ä¢ Anni di <strong>"perch√© non ci riesci?"</strong> hanno costruito vergogna interna<br>‚Ä¢ Il cervello ADHD tende a generalizzare: un errore = "sono un fallimento"<br>‚Ä¢ La disregolazione emotiva amplifica la reazione<br><br>Con ADHD gli errori sono pi√π frequenti (deficit attenzione, impulsivit√†, memoria di lavoro). Non sei incapace. <strong>Stai facendo di pi√π con meno risorse neurologiche.</strong>',actions:['breathe','dump'],strategies:[{name:'Zoom out',desc:'Su 100 cose, quante vanno bene?'},{name:'Ripara e vai',desc:'Puoi rimediare? Fallo. Altrimenti lascia andare.'},{name:'Diario vittorie',desc:'Scrivi 3 cose che hai fatto bene oggi.'},{name:'Sistema, non colpa',desc:'Quale checklist/promemoria previene questo?'}]},
  'frustrated_distracted':{understanding:'La distrazione <strong>non √® mancanza di volont√†</strong>. √à il cervello ADHD che funziona diversamente.<br><br>Cosa succede:<br>‚Ä¢ Il tuo cervello ha un <strong>filtro attentivo debole</strong><br>‚Ä¢ Non √® che "non ti concentri" - ti concentri su TUTTO contemporaneamente<br>‚Ä¢ Ogni stimolo (suono, pensiero, notifica) ha lo stesso "peso"<br>‚Ä¢ Il risultato: salti continuamente<br><br>Le persone neurotipiche filtrano automaticamente. Tu devi costruire <strong>barriere esterne</strong> (timer, ambiente, body doubling). Non cambiare te stesso. Cambia l\'ambiente.',actions:['dump','ground'],strategies:[{name:'Reset ambientale',desc:'Togli stimoli non necessari ora.'},{name:'Compassione',desc:'Accade. Riparti senza giudizio.'},{name:'Modalit√† aereo',desc:'Phone in flight mode. Timer 25 min.'},{name:'Un tab, un file',desc:'Chiudi TUTTO tranne ci√≤ su cui lavori.'}]},
  'frustrated_interruption':{understanding:'Le interruzioni <strong>rompono l\'iperfocus</strong> e serve tempo per ricostruire il flusso mentale.<br><br>Con ADHD:<br>‚Ä¢ L\'iperfocus √® uno stato di <strong>totale immersione</strong><br>‚Ä¢ Romperlo √® come svegliare qualcuno dal sonno profondo<br>‚Ä¢ Serve tempo per ricaricare il contesto in memoria<br>‚Ä¢ La frustrazione √® amplificata dalla disregolazione emotiva<br><br>Non sei esagerato a sentirti cos√¨. <strong>Hai perso uno stato prezioso che costa fatica ricreare.</strong>',actions:['breathe','dump'],strategies:[{name:'Buffer time',desc:'5 minuti per riconnetterti al flusso.'},{name:'Nota rapida',desc:'Scrivi dove eri prima dell\'interruzione.'},{name:'Segnale "busy"',desc:'Cuffie/cartello "in focus" per prevenire.'},{name:'Accetta e ricostruisci',desc:'√à andato. Rileggi ultime 3 righe scritte.'}]},
  'overwhelmed_too_many':{understanding:'Il <strong>sovraccarico cognitivo</strong> √® il cervello che dice "troppi input, non reggo".<br><br>Il cervello ADHD ha:<br>‚Ä¢ <strong>Working memory ridotta</strong> - pu√≤ tenere meno cose in testa contemporaneamente<br>‚Ä¢ Difficolt√† a filtrare gli stimoli<br>‚Ä¢ Energia cognitiva limitata<br><br>Ogni compito, decisione, stimolo consuma energia. Quando finisce, vai in <strong>overload</strong>. √à come un computer che va in crash. Non √® debolezza. √à un limite fisiologico reale.',actions:['breathe','dump','ground'],strategies:[{name:'Triage brutale',desc:'Cosa succede se NON lo fai?'},{name:'Una cosa alla volta',desc:'Finisci UNA cosa, poi la prossima.'},{name:'Chiudi tutte le tab',desc:'Letteralmente. Browser, file, pensieri.'},{name:'Lista di 3',desc:'Scrivi SOLO 3 cose. Il resto domani.'}]},
  'overwhelmed_noise':{understanding:'Il <strong>sovraccarico sensoriale</strong> consuma energia cognitiva preziosa.<br><br>Il cervello ADHD ha difficolt√† a:<br>‚Ä¢ Filtrare stimoli non rilevanti<br>‚Ä¢ Gestire input multipli<br>‚Ä¢ Mantenere focus con disturbi<br><br>Ogni suono, luce, movimento richiede <strong>processamento attivo</strong>. Le persone neurotipiche filtrano automaticamente. Tu devi filtrare consciamente - e questo esaurisce.<br><br><strong>Ridurre gli stimoli non √® debolezza. √à gestione intelligente dell\'energia.</strong>',actions:['breathe','ground'],strategies:[{name:'Riduzione stimoli',desc:'Cuffie noise-cancelling, luce soft, spazio calmo.'},{name:'Break sensoriale',desc:'5 min in un posto tranquillo. Buio, silenzio.'},{name:'Rifugio sensoriale',desc:'Identifica un posto "sicuro" dove andare.'},{name:'Stimming controllato',desc:'Fidget cube, stress ball per scaricare.'}]},
  'overwhelmed_decision':{understanding:'Troppe scelte causano <strong>paralisi decisionale</strong> amplificata dall\'ADHD.<br><br>Il problema:<br>‚Ä¢ Il cervello ADHD ha deficit nelle <strong>funzioni esecutive</strong><br>‚Ä¢ Valutare opzioni richiede working memory (che √® ridotta)<br>‚Ä¢ Ogni scelta consuma dopamina (che √® scarsa)<br>‚Ä¢ Risultato: blocco totale<br><br>√à chiamato <strong>"paralisi da analisi"</strong>. Non sei indeciso per debolezza. Il tuo cervello va in overload con troppe variabili.',actions:['dump','breathe'],strategies:[{name:'Dimezza opzioni',desc:'Elimina met√† alternative subito. Chiudi occhi, scegli.'},{name:'Flip a coin',desc:'Se non decidi in 2 min, lascia al caso.'},{name:'Timer di decisione',desc:'2 minuti massimo per scegliere. Poi STOP.'},{name:'Delega decisione',desc:'Chiedi a qualcuno di scegliere per te.'}]},
  'overwhelmed_routine_break':{understanding:'La <strong>routine d√† struttura esterna</strong> che il cervello ADHD non crea da solo.<br><br>Perch√© perderla disorienta:<br>‚Ä¢ Il cervello ADHD ha deficit di <strong>autoregolazione</strong><br>‚Ä¢ La routine √® un\'ancora esterna che sostituisce il controllo interno<br>‚Ä¢ Quando salta, perdi la mappa mentale di "cosa faccio quando"<br><br>Non √® rigidit√†. Le routine sono <strong>protesi cognitive</strong> che compensano il deficit di funzioni esecutive. Perderle √® come togliere le stampelle a chi ne ha bisogno.',actions:['ground','breathe'],strategies:[{name:'Mini-routine',desc:'Anche solo 3 passaggi ripetibili. Scrivi e segui.'},{name:'Ancora esterna',desc:'Un timer, un posto, un rituale semplice.'},{name:'Routine di emergenza',desc:'Versione ridotta per giorni caotici.'},{name:'Rituale reset',desc:'Quando salta tutto: respira 5, acqua, lista.'}]},
  'anxious_big_task':{understanding:'L\'ansia √® <strong>paura del fallimento</strong> amplificata dalla storia ADHD.<br><br>Cosa succede:<br>‚Ä¢ Hai ricevuto anni di messaggi "perch√© non ci riesci?"<br>‚Ä¢ Il cervello ha imparato: compito grande = probabile fallimento<br>‚Ä¢ L\'ansia √® una risposta protettiva (evita il dolore)<br>‚Ä¢ Ma ti blocca prima ancora di iniziare<br><br>L\'ansia non √® realt√†. √à il cervello che cerca di <strong>proteggerti da un dolore passato</strong>. Ma quel dolore non √® qui, ora.',actions:['breathe','timer','ground'],strategies:[{name:'Worst case',desc:'Cosa succederebbe DAVVERO? Scrivi lo scenario.'},{name:'Ancora al presente',desc:'Cosa devi fare ORA? Solo questo passo.'},{name:'Separa ansia da fatto',desc:'Ansia dice X. Il fatto √® Y.'},{name:'Micro-azione',desc:'Un passo cos√¨ piccolo che non pu√≤ spaventare.'}]},
  'anxious_deadline':{understanding:'L\'ansia da scadenza √® il cervello in <strong>modalit√† allarme</strong> per la cecit√† temporale.<br><br>Il cervello ADHD:<br>‚Ä¢ Non percepisce il tempo in modo lineare<br>‚Ä¢ Esiste solo <strong>"adesso" e "non adesso"</strong><br>‚Ä¢ Le scadenze lontane non attivano motivazione<br>‚Ä¢ Quelle vicine attivano panico<br><br>L\'ansia √® il modo in cui il cervello crea <strong>urgenza artificiale</strong> per compensare il deficit di dopamina. √à doloroso ma funzionale. Non sei ansioso per debolezza - √® il tuo cervello che cerca di attivarti.',actions:['breathe','ground','timer'],strategies:[{name:'Mini-win',desc:'Fai la cosa pi√π piccola. Il progresso calma.'},{name:'Relativizza',desc:'Su scala 1-10, quanto √® grave davvero?'},{name:'Body doubling',desc:'Lavora con qualcuno. L\'ansia si dimezza.'},{name:'Spezza scadenza',desc:'Crea checkpoint ogni 2 ore. Non guardare oltre.'}]},
  'anxious_social_event':{understanding:'L\'<strong>ansia sociale</strong> √® amplificata dall\'ADHD per motivi neurologici.<br><br>Le difficolt√†:<br>‚Ä¢ <strong>RSD</strong>: temi il giudizio/rifiuto in modo amplificato<br>‚Ä¢ Gestire conversazioni richiede molta working memory<br>‚Ä¢ Rischio di dire cose impulsive o perdere il filo<br>‚Ä¢ Il sovraccarico sensoriale (voci, stimoli) esaurisce<br><br>Hai ragione a temere. <strong>Le situazioni sociali sono oggettivamente pi√π difficili per te.</strong> Ma questo non significa che non puoi farcela. Significa che ti serve strategia.',actions:['breathe','ground'],strategies:[{name:'Script mentale',desc:'3 frasi pronte per rompere il ghiaccio.'},{name:'Exit strategy',desc:'Sapere che puoi andartene dopo 1h calma.'},{name:'Ruolo sociale',desc:'Fai domande. Gli altri parlano, tu ascolti.'},{name:'Time-box',desc:'"Resto 1 ora". Definisci il limite prima.'}]},
  'anxious_conflict':{understanding:'Il <strong>conflitto attiva RSD</strong> (Rejection Sensitive Dysphoria). Il rifiuto percepito fa male come dolore fisico.<br><br>Perch√© √® cos√¨ intenso:<br>‚Ä¢ Il cervello ADHD ha <strong>disregolazione emotiva</strong><br>‚Ä¢ La critica/conflitto = rifiuto = dolore amplificato 10x<br>‚Ä¢ La risposta √® immediata, travolgente, difficile da controllare<br><br>Non sei drammatico. Il tuo cervello <strong>processa il rifiuto sociale come una minaccia grave</strong>. √à neurologia, non debolezza.',actions:['breathe','ground','dump'],strategies:[{name:'Pausa prima',desc:'Non rispondere subito. Respira 5 volte. Conta.'},{name:'Fatti vs Paura',desc:'Cosa √® successo vs cosa temo che significhi.'},{name:'Scrivi prima',desc:'Butta tutto su carta. Poi scegli cosa dire.'},{name:'RSD check',desc:'La mia reazione √® 10x. Scala gi√π a 1x.'}]},
  'down_criticized':{understanding:'La critica ha toccato la <strong>vergogna accumulata</strong> negli anni di ADHD non compreso.<br><br>Cosa succede:<br>‚Ä¢ Hai ricevuto anni di messaggi "perch√© sei cos√¨?"<br>‚Ä¢ Questo ha costruito <strong>vergogna interna</strong> ("c\'√® qualcosa di sbagliato in me")<br>‚Ä¢ Ogni nuova critica conferma quella narrativa<br>‚Ä¢ RSD amplifica il dolore 10x<br><br>Non sei fragile. Stai portando il peso di <strong>anni di incomprensione</strong>. La critica non √® su di te. √à su un comportamento - spesso causato dall\'ADHD che gli altri non vedono.',actions:['breathe','dump'],strategies:[{name:'Contenitore vittorie',desc:'Scrivi 3 cose di cui vai fiero oggi.'},{name:'Questo non sei tu',desc:'Feedback su azione, non su identit√†.'},{name:'ADHD context',desc:'Questa critica ignora il mio ADHD?'},{name:'Timeline di vittorie',desc:'Rileggi vecchie note positive. Esistono.'}]},
  'down_mistake':{understanding:'Gli errori ADHD <strong>attivano vergogna profonda</strong> costruita nel tempo.<br><br>Il meccanismo:<br>‚Ä¢ Con ADHD fai pi√π errori (deficit attenzione, impulsivit√†, memoria)<br>‚Ä¢ Ogni errore ha ricevuto messaggi "stai pi√π attento!"<br>‚Ä¢ Il cervello ha imparato: errore = "sono sbagliato"<br>‚Ä¢ La disregolazione emotiva amplifica la vergogna<br><br>Ma la verit√†: <strong>stai facendo di pi√π con meno risorse</strong>. Errori pi√π frequenti non significano minor valore. Significano che il compito √® pi√π difficile per te.',actions:['dump','breathe'],strategies:[{name:'Normalizza',desc:'Con ADHD gli errori sono pi√π frequenti. √à OK.'},{name:'Pattern fix',desc:'Quale checklist/reminder previene questo?'},{name:'Contatore successi',desc:'Quante cose hai fatto BENE oggi?'},{name:'Amico ADHD',desc:'Cosa diresti a un amico con ADHD?'}]},
  'down_unknown':{understanding:'A volte il <strong>down arriva senza motivo apparente</strong>. Pu√≤ essere chimico.<br><br>Con ADHD:<br>‚Ä¢ Le <strong>fluttuazioni di dopamina</strong> influenzano l\'umore<br>‚Ä¢ La stanchezza cognitiva accumulata emerge<br>‚Ä¢ La disregolazione emotiva causa sbalzi<br><br>Non tutto ha una causa psicologica. A volte √® solo <strong>neurologia che fa il suo corso</strong>. Non serve spiegarlo o risolverlo. Pu√≤ semplicemente passare.',actions:['ground','breathe'],strategies:[{name:'Ride the wave',desc:'Non combatterlo. Osservalo passare.'},{name:'Check basics',desc:'Mangiato? Dormito? Bevuto? Meds?'},{name:'Attivit√† passiva',desc:'Serie TV, musica. Lascia andare il cervello.'},{name:'Nessuna decisione',desc:'Oggi non decido niente di importante.'}]},
  'drained_tired':{understanding:'Sei <strong>esaurito</strong>. L\'ADHD consuma pi√π energia di quanto gli altri vedano.<br><br>Perch√© sei pi√π stanco:<br>‚Ä¢ Ogni compito richiede <strong>energia cognitiva attiva</strong> (niente autopilota)<br>‚Ä¢ Filtri stimoli consciamente (altri lo fanno automaticamente)<br>‚Ä¢ Gestisci disregolazione emotiva<br>‚Ä¢ Compensi deficit di memoria/attenzione/organizzazione<br><br>Stai facendo un <strong>lavoro invisibile costante</strong>. Non sei pigro. Sei esaurito per ragioni reali.',actions:['breathe','ground'],strategies:[{name:'Permesso di fermarti',desc:'Riposare √® produttivo. Non √® pigrizia.'},{name:'Check fisico',desc:'Fame? Sete? Sonno? Sovrastimolazione?'},{name:'Power nap 20min',desc:'Timer. Occhi chiusi. Reset.'},{name:'Modalit√† sopravvivenza',desc:'Solo essenziale oggi. Il resto pu√≤ aspettare.'}]},
  'drained_too_many':{understanding:'Il <strong>decision fatigue</strong> √® reale e amplificato dall\'ADHD.<br><br>Ogni decisione consuma:<br>‚Ä¢ Dopamina (che √® scarsa)<br>‚Ä¢ Working memory (che √® ridotta)<br>‚Ä¢ Energia cognitiva (che √® limitata)<br><br>Il cervello ADHD non ha modalit√† "risparmio energetico". Fa tutto a <strong>intensit√† massima</strong>. Quando l\'energia finisce, vai in shutdown.<br><br>Non sei debole. Hai esaurito un budget energetico reale.',actions:['ground','breathe'],strategies:[{name:'Modalit√† autopilota',desc:'Solo routine automatiche. Zero decisioni.'},{name:'Power nap 20min',desc:'Timer. Occhi chiusi. Brain reset.'},{name:'Elimina scelte',desc:'Togli opzioni. Scegli il default.'},{name:'Domani decide',desc:'Lista per domani. Oggi solo esegui.'}]},
  'scattered_distracted':{understanding:'Il cervello ADHD <strong>non riesce a filtrare gli stimoli</strong>. Salta tra tutto.<br><br>Cosa succede:<br>‚Ä¢ Il filtro attentivo √® debole<br>‚Ä¢ Ogni stimolo (interno ed esterno) ha lo stesso peso<br>‚Ä¢ Non √® deficit di attenzione - √® <strong>attenzione su TUTTO</strong><br>‚Ä¢ Il risultato: dispersione mentale<br><br>Le persone neurotipiche ignorano automaticamente. Tu devi costruire <strong>barriere fisiche ed esterne</strong>. Non √® mancanza di volont√†. √à architettura cerebrale diversa.',actions:['dump','ground'],strategies:[{name:'Brain dump totale',desc:'Svuota TUTTI i pensieri su carta. Poi scegli uno.'},{name:'Focus su uno',desc:'Carta e penna. Un compito. Timer 25 min.'},{name:'Ambiente nudo',desc:'Togli tutto. Solo il necessario sul tavolo.'},{name:'Riparti da zero',desc:'Chiudi tutto. Respiro. Riapri solo l\'essenziale.'}]},
  'scattered_transition':{understanding:'Il <strong>cambio attivit√† disperde</strong> l\'attenzione che gi√† fatica a mantenersi.<br><br>Con ADHD:<br>‚Ä¢ Il cervello non "chiude" automaticamente il contesto precedente<br>‚Ä¢ I pensieri della vecchia attivit√† continuano a girare<br>‚Ä¢ Serve energia per caricare il nuovo contesto<br>‚Ä¢ Il risultato: dispersione mentale totale<br><br>Serve un <strong>rituale di chiusura esplicito</strong>. Non √® lentezza. √à compensazione di un processo che altri fanno automaticamente.',actions:['breathe','dump'],strategies:[{name:'Chiusura rituale',desc:'D√¨ "Ho finito X" ad alta voce. Chiudi fisicamente.'},{name:'Reset fisico',desc:'Alzati, cammina 2 min, siediti di nuovo.'},{name:'Pausa buffer',desc:'5 minuti vuoti tra task. Respira.'},{name:'Checklist transizione',desc:'Fine task A: salva, chiudi, respira. Start task B.'}]},
  'scattered_interruption':{understanding:'Le interruzioni <strong>frammentano il flusso mentale</strong> che gi√† √® fragile.<br><br>Il cervello ADHD:<br>‚Ä¢ Fatica a mantenere il contesto in memoria<br>‚Ä¢ Ogni interruzione "cancella" parte del lavoro mentale fatto<br>‚Ä¢ Ricostruire il flusso richiede energia cognitiva<br>‚Ä¢ La frustrazione √® amplificata dalla disregolazione emotiva<br><br>Non sei esagerato a sentirti disperso. <strong>Hai perso un lavoro mentale reale e faticoso.</strong>',actions:['dump','timer'],strategies:[{name:'Cattura pensieri',desc:'Nota rapida: "ero qui, pensavo questo".'},{name:'Ricostruisci contesto',desc:'Rileggi ultime 5 righe/passi fatti.'},{name:'Segnale busy',desc:'Cuffie/cartello per prevenire interruzioni.'},{name:'Accetta perdita',desc:'√à andato. 5 min per ricostruire. Vai.'}]},
  'restless_boring_task':{understanding:'Il cervello ADHD <strong>cerca attivamente stimoli</strong>. Il noioso √® fisicamente doloroso.<br><br>Perch√©:<br>‚Ä¢ Il cervello cerca costantemente <strong>dopamina</strong><br>‚Ä¢ I compiti noiosi non la producono<br>‚Ä¢ L\'irrequietezza √® il cervello che dice "dammi stimoli"<br>‚Ä¢ Resistere consuma energia enorme<br><br>Non √® mancanza di disciplina. √à <strong>fame neurologica di stimoli</strong>. La soluzione: aggiungere stimoli (musica, movimento, gamification) invece di combattere il bisogno.',actions:['timer','dump'],strategies:[{name:'Stimolo extra',desc:'Musica energica, podcast, cambia posizione.'},{name:'Sprint 10 min',desc:'Corri per 10 min. Break. Ripeti.'},{name:'Gamifica',desc:'Sfida te stesso: "lo finisco in X minuti".'},{name:'Body doubling',desc:'Lavora accanto a qualcuno. Stimolo sociale.'}]},
  'restless_waiting':{understanding:'L\'<strong>attesa √® tortura</strong> per il cervello ADHD che vuole azione costante.<br><br>Il problema:<br>‚Ä¢ Il cervello cerca stimoli e dopamina<br>‚Ä¢ L\'attesa = assenza di stimoli<br>‚Ä¢ La cecit√† temporale rende l\'attesa "infinita"<br>‚Ä¢ L\'irrequietezza √® energia che non trova sfogo<br><br>Non sei impaziente per difetto caratteriale. Il tuo cervello <strong>ha bisogno di input costanti</strong> per regolarsi.',actions:['breathe','ground'],strategies:[{name:'Micro-task',desc:'Lista di cose da 2 min. Fai qualcosa.'},{name:'Fidget strategico',desc:'Penna che gira, stress ball, respiro contato.'},{name:'Phone time-box',desc:'5 min social. Timer. Poi basta.'},{name:'Cammina',desc:'Se puoi, muoviti. Scarica energia fisica.'}]},
  'restless_tired':{understanding:'Il <strong>paradosso ADHD</strong>: esausto fisicamente ma irrequieto mentalmente.<br><br>Cosa succede:<br>‚Ä¢ Il corpo √® stanco e ha bisogno di riposo<br>‚Ä¢ Il cervello cerca dopamina e stimoli<br>‚Ä¢ I due sistemi vanno in conflitto<br>‚Ä¢ Risultato: agitazione spossata<br><br>Non √® contraddizione. Sono <strong>due sistemi neurologici che danno segnali opposti</strong>. Servono tecniche per calmare il cervello senza attivare il corpo.',actions:['breathe','ground'],strategies:[{name:'Quiet stillness',desc:'Sdraiato. Occhi aperti. Osserva soffitto. Calma.'},{name:'Stretching dolce',desc:'5 min. Movimenti lenti. Senza cardio.'},{name:'White noise',desc:'Rumore bianco, pioggia. Calma input sensoriale.'},{name:'Body scan',desc:'Senti ogni parte del corpo. Rilassa progressivamente.'}]},
  'hyperfocus_interruption':{understanding:'L\'<strong>iperfocus √® uno stato fragile e prezioso</strong>. Romperlo causa frustrazione intensa.<br><br>L\'iperfocus √®:<br>‚Ä¢ Uno stato di totale assorbimento<br>‚Ä¢ Il momento in cui il cervello ADHD funziona al meglio<br>‚Ä¢ Difficile da raggiungere e facile da perdere<br>‚Ä¢ Quasi impossibile da ricreare a comando<br><br>Perderlo √® come <strong>svegliare qualcuno dal sonno profondo</strong>. La frustrazione non √® esagerata. Hai perso qualcosa di raro e potente.',actions:['dump','breathe'],strategies:[{name:'Snapshot mentale',desc:'Scrivi VELOCE: punto esatto, idea, prossimo passo.'},{name:'Foto schermo',desc:'Screenshot letterale di dove sei.'},{name:'Segnale protezione',desc:'Cuffie/cartello "in flow" per prevenire.'},{name:'Accetta e lascia',desc:'√à andato. Respirare. Ricostruire piano.'}]},
  'hyperfocus_deadline':{understanding:'L\'iperfocus pu√≤ essere <strong>sulla cosa sbagliata</strong> mentre il cervello ignora le priorit√†.<br><br>Il problema:<br>‚Ä¢ L\'iperfocus si attiva su ci√≤ che √® <strong>interessante</strong>, non importante<br>‚Ä¢ Il cervello ADHD non valuta priorit√† razionalmente<br>‚Ä¢ La cecit√† temporale fa ignorare le scadenze<br>‚Ä¢ Interromperlo √® difficile (vedi iperfocus fragile)<br><br>Non sei irresponsabile. Il tuo cervello <strong>segue interesse, non priorit√†</strong>. Serve un\'ancora esterna (timer, persona) per redirigere.',actions:['timer','dump'],strategies:[{name:'Alarm ogni 30min',desc:'Timer ricorrente: "√® ancora priorit√†?"'},{name:'Ancora esterna',desc:'Persona che ti interrompe e chiede: "deadline?"'},{name:'Lista visibile',desc:'Scrivi GRANDE la scadenza. Davanti a te.'},{name:'Transizione graduale',desc:'10 min per chiudere. Poi switch.'}]},
  'shame_distracted':{understanding:'La <strong>vergogna ADHD</strong> dice "dovrei essere diverso, dovrei riuscire".<br><br>Questa vergogna viene da:<br>‚Ä¢ Anni di messaggi "stai pi√π attento!"<br>‚Ä¢ La narrativa interna "gli altri ce la fanno, io no"<br>‚Ä¢ Non capire che il problema √® <strong>neurologico</strong>, non caratteriale<br><br>Ma la verit√†: non sei distratto per pigrizia. Il tuo cervello <strong>filtra diversamente</strong>. Servono supporti esterni, non pi√π forza di volont√†. La vergogna √® bugia. Il bisogno di aiuto √® legittimo.',actions:['dump','breathe'],strategies:[{name:'Self-compassion',desc:'Hai ADHD. Il cervello funziona cos√¨. OK.'},{name:'Sistema, non colpa',desc:'Timer? Cuffie? Ambiente? Cosa serve?'},{name:'Normalizza',desc:'10 persone con ADHD = 10 distratte. Non sei solo tu.'},{name:'Celebra redirect',desc:'Sei tornato? Bene. Conta come vittoria.'}]},
  'shame_mistake':{understanding:'Gli errori ADHD attivano <strong>vergogna profonda</strong> costruita in anni di incomprensione.<br><br>Il meccanismo:<br>‚Ä¢ Gli errori sono pi√π frequenti (deficit attenzione/impulsivit√†)<br>‚Ä¢ Ogni errore ha ricevuto "fai pi√π attenzione!"<br>‚Ä¢ Il cervello ha imparato: errore = "sono difettoso"<br>‚Ä¢ La disregolazione emotiva amplifica la vergogna<br><br>Ma la realt√†: <strong>hai fatto un errore, non SEI un errore</strong>. Con ADHD gli errori sono parte del pacchetto, non prova di incapacit√†. La vergogna √® la voce di chi non capiva. Non √® verit√†.',actions:['breathe','dump'],strategies:[{name:'Separa azione da s√©',desc:'Errore = comportamento. Tu = persona intera.'},{name:'Repair action',desc:'Cosa faccio ORA per sistemare? Fallo.'},{name:'Checklist preventiva',desc:'Sistema che previene. Non volont√† che ricorda.'},{name:'Friend perspective',desc:'Cosa diresti a un amico ADHD?'}]},
  'shame_criticized':{understanding:'RSD + critica = <strong>vergogna amplificata 10x</strong>. √à una tempesta neurologica.<br><br>Cosa succede:<br>‚Ä¢ La critica attiva <strong>RSD</strong> (sensibilit√† al rifiuto)<br>‚Ä¢ Il cervello interpreta critica = rifiuto totale<br>‚Ä¢ La disregolazione emotiva amplifica la risposta<br>‚Ä¢ La vergogna accumulata negli anni esplode<br><br>La tua reazione √® <strong>10 volte pi√π intensa del fatto oggettivo</strong>. Non √® debolezza. √à il cervello ADHD che amplifica il segnale di rifiuto come meccanismo protettivo (doloroso ma non volontario).',actions:['breathe','ground','dump'],strategies:[{name:'RSD scale-down',desc:'Reazione: 10/10. Fatto oggettivo: scrivi.'},{name:'Fonte check',desc:'Chi critica? Conosce il mio ADHD?'},{name:'24h rule',desc:'Non rispondere ora. Domani l\'onda RSD passa.'},{name:'Vittorie recenti',desc:'Scrivi 3 successi recenti. Bilancia.'}]},
  'default':{understanding:'Quello che senti √® <strong>valido e reale</strong>.<br><br>Con ADHD:<br>‚Ä¢ Le emozioni sono <strong>pi√π intense</strong> (disregolazione emotiva)<br>‚Ä¢ I trigger sono pi√π frequenti<br>‚Ä¢ Il recupero √® pi√π lento<br><br>Non stai esagerando. Il tuo cervello processa le emozioni diversamente. Servono strategie per gestire l\'intensit√†, non giudizio su ci√≤ che senti.',actions:['breathe','ground','dump'],strategies:[{name:'Check-in fisico',desc:'Fame? Sete? Stanchezza? Sovrastimolazione?'},{name:'Movimento breve',desc:'5 min camminata. Reset neurologico.'},{name:'Respira 5 volte',desc:'Inspira 4 sec, espira 6 sec. Ripeti 5 volte.'},{name:'Scrivi 3 righe',desc:'Cosa senti. Perch√©. Cosa ti serve ora.'}]}
};
let state={history:[],diary:[],patterns:{},garden:{points:0,level:0,lastActivityDate:null,isPaused:false,pauseUntil:null},tasks:{}};
let currentFlow={feeling:null,intensity:3,trigger:null,taskName:'',notes:''};
let screenHistory=['homeScreen'];
let timerInterval=null,timerSeconds=120,timerTotalSeconds=120;
let breatheCycles=5;
let currentGroundStep=0;
let diaryMood=null;
let currentDiaryEntry=null;
let reportPeriodDays=7;
let historyPeriodFilter='all';
let historyFeelingFilter=null;
function checkLegalConsent() {
  const consent = localStorage.getItem('legal-consent');
  if (consent === 'accepted') {
    document.getElementById('legalScreen').classList.remove('active');
    document.getElementById('homeScreen').classList.add('active');
  } else {
    document.getElementById('legalScreen').classList.add('active');
    document.getElementById('homeScreen').classList.remove('active');
  }
}

function updateAcceptButton() {
  const check1 = document.getElementById('consentCheckbox1').checked;
  const check2 = document.getElementById('consentCheckbox2').checked;
  const check3 = document.getElementById('consentCheckbox3').checked;
  const check4 = document.getElementById('consentCheckbox4').checked;
  document.getElementById('acceptBtn').disabled = !(check1 && check2 && check3 && check4);
}

function acceptTerms() {
  localStorage.setItem('legal-consent', 'accepted');
  localStorage.setItem('legal-consent-date', new Date().toISOString());
  document.getElementById('legalScreen').classList.remove('active');
  document.getElementById('homeScreen').classList.add('active');
  showToast('‚úÖ Benvenuto!');
}

function declineTerms() {
  if (confirm('Se rifiuti i termini non potrai utilizzare l\'app. Sei sicuro?')) {
    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;text-align:center;padding:40px;color:#f0f0f5"><div style="font-size:3rem;margin-bottom:20px">üòî</div><h2 style="margin-bottom:10px">Termini rifiutati</h2><p style="color:#a0a0b8">Per utilizzare l\'app devi accettare i Termini e Condizioni.</p><button onclick="location.reload()" style="margin-top:30px;padding:14px 28px;background:#7eb8da;color:#1a1a2e;border:none;border-radius:100px;font-weight:700;cursor:pointer">Riprova</button></div>';
  }
}

document.addEventListener('DOMContentLoaded',()=>{
  checkLegalConsent();
  loadState();
  setGreeting();
  updateGardenBadge();
  renderFeelings();
  renderTriggers();
  renderDiaryMoods();
});
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
const APP_VERSION = '1.0.2';
const SCHEMA_VERSION = 1;
const STORAGE_KEY = 'come-stai-v2';
function loadState() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (!s) return;
    const loaded = JSON.parse(s);

    if (!loaded || typeof loaded !== 'object') {
      return;
    }
    if (!loaded.version || loaded.version < SCHEMA_VERSION) {
      loaded.version = SCHEMA_VERSION;
    }
    state.history = Array.isArray(loaded.history) ? loaded.history : [];
    state.diary = Array.isArray(loaded.diary) ? loaded.diary : [];
    state.patterns = (loaded.patterns && typeof loaded.patterns === 'object') ? loaded.patterns : {};
    state.garden = (loaded.garden && typeof loaded.garden === 'object') ? loaded.garden : {points:0,level:0,lastActivityDate:null,isPaused:false,pauseUntil:null};
    state.tasks = (loaded.tasks && typeof loaded.tasks === 'object') ? loaded.tasks : {};
    state.version = SCHEMA_VERSION;
  } catch (err) {
    try {
      const backup = localStorage.getItem(STORAGE_KEY + '-backup');
      if (backup) {
        const loaded = JSON.parse(backup);
        state.history = Array.isArray(loaded.history) ? loaded.history : [];
        state.diary = Array.isArray(loaded.diary) ? loaded.diary : [];
        state.patterns = loaded.patterns || {};
        state.garden = (loaded.garden && typeof loaded.garden === 'object') ? loaded.garden : {points:0,level:0,lastActivityDate:null,isPaused:false,pauseUntil:null};
        state.tasks = (loaded.tasks && typeof loaded.tasks === 'object') ? loaded.tasks : {};
        showToast('‚ö†Ô∏è Dati recuperati da backup');
        return;
      }
    } catch (backupErr) {
    }
    showToast('‚ö†Ô∏è Errore caricamento dati');
  }
}
function saveState() {
  try {
    state.version = SCHEMA_VERSION;
    state.lastSaved = new Date().toISOString();

    const data = JSON.stringify(state);
    try {
      const current = localStorage.getItem(STORAGE_KEY);
      if (current) {
        localStorage.setItem(STORAGE_KEY + '-backup', current);
      }
    } catch (backupErr) {
    }
    localStorage.setItem(STORAGE_KEY, data);
  } catch (err) {
    if (err.name === 'QuotaExceededError' || err.code === 22) {
      const sixMonthsAgo = Date.now() - (6 * 30 * 24 * 60 * 60 * 1000);
      const originalHistoryLength = state.history.length;
      const originalDiaryLength = state.diary.length;

      state.history = state.history.filter(e => new Date(e.date).getTime() > sixMonthsAgo);
      state.diary = state.diary.filter(e => new Date(e.date).getTime() > sixMonthsAgo);

      const removedHistory = originalHistoryLength - state.history.length;
      const removedDiary = originalDiaryLength - state.diary.length;
      if (removedHistory > 0 || removedDiary > 0) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          showToast('‚ö†Ô∏è Dati vecchi archiviati (storage pieno)');
          return;
        } catch (retryErr) {
        }
      }

      showToast('‚ùå Storage pieno - esporta i dati');
    } else {
      showToast('‚ùå Errore salvataggio dati');
    }
  }
}
function getGardenLevel(points){if(points>=500)return 5;if(points>=201)return 4;if(points>=101)return 3;if(points>=51)return 2;if(points>=21)return 1;return 0;}
function getGardenEmoji(level,withered){const emojis=['üå±','üåø','ü™¥','üå≥','üå≤','üå∏'];if(withered&&level>0)return'üçÇ';return emojis[level]||'üå±';}
function getGardenName(level){const names=['Germoglio','Piantina','Pianta giovane','Albero','Albero maestoso','Albero fiorito'];return names[level]||'Germoglio';}
function checkGardenDecay(){if(state.garden.isPaused&&state.garden.pauseUntil){if(new Date()>=new Date(state.garden.pauseUntil)){state.garden.isPaused=false;state.garden.pauseUntil=null;saveState();}}if(state.garden.isPaused)return false;if(!state.garden.lastActivityDate)return false;const now=new Date();const lastActivity=new Date(state.garden.lastActivityDate);const hoursSince=(now-lastActivity)/(1000*60*60);if(hoursSince>=72){const daysPassed=Math.floor(hoursSince/24);const levelsToLose=Math.min(2,Math.floor((daysPassed-3)/3)+1);const currentLevel=getGardenLevel(state.garden.points);if(levelsToLose>0&&currentLevel>0){const targetLevel=Math.max(0,currentLevel-levelsToLose);const levelPoints=[0,21,51,101,201,500];state.garden.points=Math.max(levelPoints[targetLevel],0);state.garden.level=targetLevel;saveState();return true;}}return hoursSince>=24;}
function addGardenPoints(points,activityName){checkGardenDecay();const wasWithered=state.garden.lastActivityDate&&(new Date()-new Date(state.garden.lastActivityDate))/(1000*60*60)>=24;const oldLevel=getGardenLevel(state.garden.points);state.garden.points+=points;state.garden.lastActivityDate=new Date().toISOString();const newLevel=getGardenLevel(state.garden.points);state.garden.level=newLevel;saveState();updateGardenBadge();let message='';if(wasWithered){message='üå± Pianta riannaffiata! +'+points+' punti';showToast(message);setTimeout(()=>showToast('üíö Bonus recupero: +50% punti per 24h!'),1500);}else if(newLevel>oldLevel){message='üéâ LIVELLO '+newLevel+'! '+getGardenName(newLevel)+' (+'+points+' pt)';showToast(message);}else{message='‚ú® +'+points+' punti! '+getGardenEmoji(newLevel,false)+' '+state.garden.points+' pt';showToast(message);}}
function pauseGarden(days){state.garden.isPaused=true;const until=new Date();until.setDate(until.getDate()+days);state.garden.pauseUntil=until.toISOString();saveState();updateGardenBadge();showToast('üåô Pianta in pausa per '+days+' giorni');}
function resumeGarden(){state.garden.isPaused=false;state.garden.pauseUntil=null;saveState();updateGardenBadge();showToast('üå± Pausa terminata! Bentornato!');}
function updateGardenBadge(){updateMainButton();}
function updateMainButton(){const emojiEl=document.getElementById('mainGardenEmoji');const levelEl=document.getElementById('mainGardenLevel');const pointsEl=document.getElementById('mainGardenPoints');const pauseBtn=document.getElementById('gardenPauseBtn');if(!emojiEl||!levelEl||!pointsEl||!pauseBtn)return;const isWithered=checkGardenDecay();const level=getGardenLevel(state.garden.points);const emoji=getGardenEmoji(level,isWithered&&!state.garden.isPaused);const name=getGardenName(level);const points=state.garden.points;emojiEl.textContent=emoji;levelEl.textContent='Lv '+level;pointsEl.textContent=points+' punti';if(state.garden.isPaused){pauseBtn.textContent='‚ñ∂Ô∏è';pauseBtn.onclick=(e)=>{e.stopPropagation();resumeGarden();};}else{pauseBtn.textContent='‚è∏Ô∏è';pauseBtn.onclick=(e)=>{e.stopPropagation();showGardenPauseModal();};}}
function showGardenPauseModal(){if(confirm('Vuoi mettere in pausa il giardino?\n\nLa tua pianta non appassir√† per 7 giorni.\nUtile quando hai bisogno di una pausa dall\'app.')){pauseGarden(7);}}
const taskCategories={studio:['studiare','esame','lezione','compiti','tesi','scuola','universit√†','corso','materia','storia','matematica','fisica','chimica'],lavoro:['email','meeting','report','progetto','chiamata','lavoro','riunione','presentazione','deadline','documento','cliente'],casa:['pulizie','pulire','lavare','stirare','cucinare','spesa','casa','cucina','bagno','camera','stanza','piatti','biancheria','bucato'],sociale:['uscire','amici','festa','compleanno','chiamare','sociale','cena','aperitivo','evento','appuntamento'],cura:['doccia','vestirsi','medicine','dentista','sport','palestra','correre','yoga','meditare','dormire'],admin:['bollette','banca','documenti','tasse','prenotare','email','modulo','pratica','appuntamento','telefonata']};
function detectTaskCategory(taskName){const t=taskName.toLowerCase();for(const[cat,keywords]of Object.entries(taskCategories)){if(keywords.some(k=>t.includes(k)))return cat;}return 'altro';}
function normalizeTaskName(name){return name.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');}
function updateTaskDatabase(taskName,category,feeling,trigger,intensity,strategyUsed,completed){if(!taskName)return;const taskId=normalizeTaskName(taskName);if(!state.tasks[taskId]){state.tasks[taskId]={name:taskName,category:category,firstSeen:new Date().toISOString(),lastMentioned:new Date().toISOString(),timesBlocked:0,timesResolved:0,feelings:{},triggers:{},strategies:{},avgIntensity:0,totalIntensity:0,count:0};}const task=state.tasks[taskId];task.lastMentioned=new Date().toISOString();task.count++;task.totalIntensity+=intensity;task.avgIntensity=(task.totalIntensity/task.count).toFixed(1);task.timesBlocked++;if(completed)task.timesResolved++;task.feelings[feeling]=(task.feelings[feeling]||0)+1;task.triggers[trigger]=(task.triggers[trigger]||0)+1;if(strategyUsed){if(!task.strategies[strategyUsed])task.strategies[strategyUsed]={used:0,completed:0};task.strategies[strategyUsed].used++;if(completed)task.strategies[strategyUsed].completed++;}saveState();}
function getBestStrategyForTask(taskId){const task=state.tasks[taskId];if(!task||!task.strategies)return null;let best=null;let bestRate=0;for(const[stratName,stats]of Object.entries(task.strategies)){if(stats.used<2)continue;const rate=stats.completed/stats.used;if(rate>bestRate){bestRate=rate;best={name:stratName,rate:rate,used:stats.used};}}return best;}
function getRecentTasks(limit=5){const tasks=Object.values(state.tasks).sort((a,b)=>new Date(b.lastMentioned)-new Date(a.lastMentioned));return tasks.slice(0,limit);}
function isTaskRelatedTrigger(trigger){const taskTriggers=['big_task','too_many','boring_task','transition'];return taskTriggers.includes(trigger);}
window.addEventListener('storage', (e) => {
  if (e.key === STORAGE_KEY && e.newValue) {
    try {
      const newState = JSON.parse(e.newValue);
      if (newState && typeof newState === 'object') {
        state.history = Array.isArray(newState.history) ? newState.history : state.history;
        state.diary = Array.isArray(newState.diary) ? newState.diary : state.diary;
        state.patterns = newState.patterns || state.patterns;
        state.garden = (newState.garden && typeof newState.garden === 'object') ? newState.garden : state.garden;
        state.tasks = (newState.tasks && typeof newState.tasks === 'object') ? newState.tasks : state.tasks;
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
          const id = activeScreen.id;
          if (id === 'insightsScreen') renderInsights();
          if (id === 'historyScreen') renderHistory();
          if (id === 'diaryScreen') renderDiaryEntries();
          if (id === 'homeScreen') updateGardenBadge();
        }
      }
    } catch (err) {
    }
  }
});
function exportData() {
  try {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'come-stai-backup-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('üíæ Backup scaricato');
  } catch (err) {
    showToast('‚ùå Errore export');
  }
}
function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const imported = JSON.parse(event.target.result);
        if (!imported || typeof imported !== 'object') {
          showToast('‚ùå File non valido');
          return;
        }
        const hasData = state.history.length > 0 || state.diary.length > 0;
        if (hasData) {
          if (!confirm('Attenzione: questo sovrascriver√† i tuoi dati attuali. Continua?')) {
            return;
          }
        }
        state.history = Array.isArray(imported.history) ? imported.history : [];
        state.diary = Array.isArray(imported.diary) ? imported.diary : [];
        state.patterns = imported.patterns || {};
        saveState();
        const activeScreen = document.querySelector('.screen.active');
        if (activeScreen) {
          const id = activeScreen.id;
          if (id === 'insightsScreen') renderInsights();
          if (id === 'historyScreen') renderHistory();
          if (id === 'diaryScreen') renderDiaryEntries();
        }

        showToast('‚úÖ Dati importati (' + state.history.length + ' momenti, ' + state.diary.length + ' note)');
      } catch (err) {
        showToast('‚ùå Errore lettura file');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}
function clearAllData() {
  if (!confirm('Attenzione: questo eliminer√† TUTTI i tuoi dati in modo permanente. Sei sicuro?')) {
    return;
  }
  if (!confirm('Ultima conferma: eliminare tutti i dati?')) {
    return;
  }

  state.history = [];
  state.diary = [];
  state.patterns = {};

  saveState();
  try {
    localStorage.removeItem(STORAGE_KEY + '-backup');
  } catch (err) {
  }
  showToast('üóëÔ∏è Tutti i dati eliminati');
  screenHistory = ['homeScreen'];
  showScreen('homeScreen');
}

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(screenHistory[screenHistory.length-1]!==id)screenHistory.push(id);if(id==='insightsScreen')renderInsights();if(id==='historyScreen')renderHistory();if(id==='diaryScreen')renderDiaryEntries();if(id==='groundScreen')initGrounding();if(id==='learnScreen')renderLearn();}
function goBack(){screenHistory.pop();const prev=screenHistory[screenHistory.length-1]||'homeScreen';document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(prev).classList.add('active');}
function setGreeting(){const h=new Date().getHours();document.getElementById('greeting').textContent=h<12?'Buongiorno':h<18?'Buon pomeriggio':'Buonasera';}
function startFlow(){currentFlow={feeling:null,intensity:3,trigger:null,notes:''};document.getElementById('intensitySection').style.display='none';document.getElementById('feelingContinue').classList.remove('show');renderFeelings();showScreen('feelingScreen');}
function renderFeelings(){document.getElementById('feelingsGrid').innerHTML=feelings.map(f=>'<div class="option-card" data-id="'+f.id+'" onclick="selectFeeling(\''+f.id+'\')"><span class="emoji">'+f.emoji+'</span><span class="label">'+f.label+'</span></div>').join('');}
function selectFeeling(id){currentFlow.feeling=id;document.querySelectorAll('#feelingsGrid .option-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===id));document.getElementById('intensitySection').style.display='block';document.getElementById('feelingContinue').classList.add('show');}
function setIntensity(v){currentFlow.intensity=v;document.getElementById('intensityValue').textContent=v;document.querySelectorAll('.intensity-dot').forEach((d,i)=>d.classList.toggle('selected',i+1===v));}
function goToTrigger(){document.getElementById('triggerContinue').classList.remove('show');renderTriggers();showScreen('triggerScreen');}
function renderTriggers(){document.getElementById('triggersList').innerHTML=triggers.map(t=>'<div class="trigger-card" data-id="'+t.id+'" onclick="selectTrigger(\''+t.id+'\')"><span class="emoji">'+t.emoji+'</span><span class="label">'+t.label+'</span></div>').join('');}
function selectTrigger(id){currentFlow.trigger=id;document.querySelectorAll('#triggersList .trigger-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===id));document.getElementById('triggerContinue').classList.add('show');}
function goToTaskOrResponse(){if(isTaskRelatedTrigger(currentFlow.trigger)){renderRecentTasks();showScreen('taskScreen');}else{currentFlow.taskName='';generateResponse();}}
function renderRecentTasks(){const list=document.getElementById('recentTasksList');const recent=getRecentTasks(5);if(recent.length===0){list.innerHTML='';return;}let html='<p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px">Recenti:</p>';recent.forEach(t=>{const best=getBestStrategyForTask(normalizeTaskName(t.name));const badge=best?'‚ö° ('+Math.round(best.rate*100)+'%)':'';html+='<div onclick="selectRecentTask(\''+t.name.replace(/'/g,"\\'")+'\',\''+t.category+'\')" style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);margin-bottom:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'var(--bg-elevated)\'" onmouseout="this.style.background=\'var(--bg-card)\'"><div style="flex:1"><div style="font-size:0.95rem">'+t.name+' '+badge+'</div><div style="font-size:0.75rem;color:var(--text-muted)">'+getCategoryEmoji(t.category)+' '+t.category+' ¬∑ usato '+t.count+' volte</div></div></div>';});list.innerHTML=html;}
function selectRecentTask(name,category){document.getElementById('taskInput').value=name;currentFlow.taskName=name;}
function skipTask(){currentFlow.taskName='';generateResponse();}
function getCategoryEmoji(cat){const e={studio:'üìö',lavoro:'üíº',casa:'üè†',sociale:'üë•',cura:'üíö',admin:'üìã',altro:'üìå'};return e[cat]||'üìå';}
function getTopDifficultTasks(limit=5){const tasks=Object.values(state.tasks).filter(t=>t.timesBlocked>=2).sort((a,b)=>{const aRate=a.timesResolved/a.timesBlocked;const bRate=b.timesResolved/b.timesBlocked;if(aRate!==bRate)return aRate-bRate;return b.timesBlocked-a.timesBlocked;});return tasks.slice(0,limit);}
function getTasksWithBestStrategies(limit=5){const tasksWithStrat=Object.values(state.tasks).filter(t=>t.strategies&&Object.keys(t.strategies).length>0&&t.timesBlocked>=2);const results=[];tasksWithStrat.forEach(task=>{const best=getBestStrategyForTask(normalizeTaskName(task.name));if(best&&best.rate>=0.5){results.push({task:task,strategy:best});}});return results.sort((a,b)=>b.strategy.rate-a.strategy.rate).slice(0,limit);}
function generateResponse(){const taskInput=document.getElementById('taskInput');if(taskInput){currentFlow.taskName=taskInput.value.trim();}const notesInput=document.getElementById('notesInput');if(notesInput){currentFlow.notes=notesInput.value;}const key=currentFlow.feeling+'_'+currentFlow.trigger;const r=responses[key]||responses['default'];const f=feelings.find(x=>x.id===currentFlow.feeling);document.getElementById('responseEmoji').textContent=f.emoji;document.getElementById('responseFeelingText').textContent=f.label.toLowerCase();document.getElementById('understandingText').innerHTML=r.understanding;document.getElementById('guidedActionsList').innerHTML=r.actions.map(aid=>{const a=guidedActions.find(x=>x.id===aid);return'<div class="guided-action-card" onclick="showScreen(\''+a.screen+'\')"><div class="guided-action-icon">'+a.icon+'</div><div class="guided-action-info"><div class="guided-action-name">'+a.name+'</div><div class="guided-action-desc">'+a.desc+'</div></div><span class="guided-action-arrow">‚Üí</span></div>';}).join('');let strategiesHtml='';const taskId=currentFlow.taskName?normalizeTaskName(currentFlow.taskName):null;const bestStrat=taskId?getBestStrategyForTask(taskId):null;if(bestStrat){strategiesHtml='<div style="background:rgba(152,195,121,0.15);border:1px solid rgba(152,195,121,0.3);border-radius:12px;padding:16px;margin-bottom:16px"><div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px">üí° Per "'+currentFlow.taskName+'" funziona:</div><div style="font-weight:600;color:var(--accent-green)">'+bestStrat.name+' ('+Math.round(bestStrat.rate*100)+'% successo)</div></div>';}strategiesHtml+=r.strategies.map((s,i)=>'<div class="strategy-card'+(i===1?' secondary':'')+'" onclick="showStrategyDetail(\''+s.name.replace(/'/g,"\\'")+'\')" style="cursor:pointer"><div class="strategy-name">'+s.name+' ‚Üí</div><div class="strategy-desc">'+s.desc+'</div></div>').join('');document.getElementById('strategiesList').innerHTML=strategiesHtml;const taskCategory=currentFlow.taskName?detectTaskCategory(currentFlow.taskName):'';state.history.unshift({id:Date.now(),date:new Date().toISOString(),feeling:currentFlow.feeling,trigger:currentFlow.trigger,intensity:currentFlow.intensity,notes:currentFlow.notes,taskName:currentFlow.taskName,taskCategory:taskCategory,strategyUsed:null,strategyCompleted:false});updatePatterns();saveState();showScreen('responseScreen');}
function executeStrategy(name){if(state.history.length>0){state.history[0].strategyUsed=name;saveState();}const n=name.toLowerCase();if(n.includes('respira')||n.includes('breath')||n.includes('pausa vuota')){showScreen('breatheScreen');return;}if(n.includes('pomodoro')||n.includes('sprint')||n.includes('timer')||n.includes('nap')||n.includes('buffer')||n.includes('min')||n.includes('cammina')||n.includes('corri')||n.includes('movimento')||n.includes('phone')||n.includes('social')||n.includes('scroll')||n.includes('pausa')||n.includes('break')||n.includes('serie')||n.includes('tv')||n.includes('passiva')||n.includes('stretching')){let mins=2;if(n.includes('serie')||n.includes('tv')||n.includes('passiva'))mins=20;else if(n.includes('30'))mins=30;else if(n.includes('25'))mins=25;else if(n.includes('20'))mins=20;else if(n.includes('10'))mins=10;else if(n.includes('5'))mins=5;else if(n.includes('2'))mins=2;else if(n.includes('cammina')||n.includes('corri')||n.includes('movimento')||n.includes('phone')||n.includes('social')||n.includes('scroll')||n.includes('pausa')||n.includes('break')||n.includes('stretching'))mins=5;startCustomTimer(mins);return;}if(n.includes('dump')||n.includes('scrivi')||n.includes('lista')||n.includes('nota')||n.includes('vittorie')||n.includes('successi')||n.includes('contatore')||n.includes('diario')||n.includes('repair')||n.includes('snapshot')||n.includes('cattura')){let prompt='';if(n.includes('vittorie')||n.includes('successi')||n.includes('fiero'))prompt='3 cose di cui vado fiero oggi:\n1. \n2. \n3. ';else if(n.includes('lista')||n.includes('elimina')||n.includes('dimezza')||n.includes('triage'))prompt='Lista:\n‚Ä¢ ';else if(n.includes('3 righe'))prompt='Cosa sento:\nPerch√©:\nCosa mi serve:';else if(n.includes('worst')||n.includes('scenario'))prompt='Worst case scenario:\n\nCosa succederebbe davvero?\n';else if(n.includes('fatto')||n.includes('interpreta'))prompt='FATTO:\n\nINTERPRETAZIONE:\n';else if(n.includes('paura'))prompt='FATTO:\n\nPAURA:\n';else if(n.includes('contatore')||n.includes('quante'))prompt='Cose che ho fatto BENE:\n1. \n2. \n3. \n4. \n5. ';else if(n.includes('repair')||n.includes('sistemare'))prompt='Cosa posso fare ORA per sistemare:\n\n';else if(n.includes('snapshot')||n.includes('nota')||n.includes('cattura'))prompt='Dove ero:\n\nCosa pensavo:\n\nProssimo passo:\n';else prompt='';showDumpWithPrompt(prompt);return;}if(n.includes('ground')||n.includes('5 cose')||n.includes('ancora al presente')){showScreen('groundingScreen');return;}if(n.includes('check')||n.includes('basics')){showChecklist(name);return;}if(n.includes('doubling')||n.includes('body')){showGuidedTip('Body Doubling','üí° Lavora accanto a qualcuno:\n\n‚Ä¢ Chiamata video con un amico\n‚Ä¢ Vai in caff√® o biblioteca\n‚Ä¢ App come Focusmate o StudyStream\n‚Ä¢ Anche solo la presenza aiuta\n\nNon serve parlare!');return;}if(n.includes('gamif')||n.includes('sfida')){showGuidedTip('Gamification','üéÆ Trasforma in gioco:\n\n‚Ä¢ "Quanto veloce riesco?"\n‚Ä¢ Metti canzone, finisci prima che finisca\n‚Ä¢ Competi con te di ieri\n‚Ä¢ Ricompensa alla fine\n\nChe punteggio fai oggi?');return;}if(n.includes('ricompensa')||n.includes('dopo')){showGuidedTip('Ricompensa','üéÅ Cosa fai DOPO averlo finito?\n\n‚Ä¢ Episodio serie\n‚Ä¢ 10 min gioco\n‚Ä¢ Snack\n‚Ä¢ Pausa fuori\n\nDecidi ORA, prima di iniziare!');return;}if(n.includes('compassione')||n.includes('normaliz')){showGuidedTip('Self-Compassion','üíö Con ADHD √® NORMALE:\n\n‚Ä¢ Distrarsi spesso\n‚Ä¢ Errori frequenti\n‚Ä¢ Emozioni intense\n‚Ä¢ Bisogno di supporti\n\nNon sei pigro. Sei ADHD.');return;}if(n.includes('zoom')||n.includes('100')){showGuidedQuestion('Zoom Out','Su 100 cose che fai, quante vanno bene?\n\n(Scrivi un numero)');return;}if(n.includes('test del tempo')||n.includes('settimana')){showGuidedQuestion('Test del Tempo','Tra una settimana sar√† ancora grave?\n\nTra un mese?\n\nTra un anno?');return;}if(n.includes('script')||n.includes('frasi')){showGuidedTip('Script Sociale','üí¨ 3 frasi pronte:\n\n1. "Ciao! Come va?"\n2. "Che cosa fai?"\n3. "Interessante, dimmi di pi√π"\n\nBasta questo per iniziare!');return;}if(n.includes('exit')||n.includes('andare')){showGuidedTip('Exit Strategy','üö™ Puoi uscire quando vuoi:\n\n‚Ä¢ "Resto max 1h"\n‚Ä¢ "Ho impegno alle X"\n‚Ä¢ "Devo fare chiamata"\n\nDecidilo PRIMA. Calma.');return;}if(n.includes('scale')||n.includes('10x')||n.includes('rsd')){showGuidedQuestion('RSD Scale-Down','La tua reazione √®: 10/10\n\nIl fatto oggettivo √®: _/10\n\n(Scala da 1 a 10)');return;}if(n.includes('fonte')||n.includes('chi')){showGuidedQuestion('Check Fonte','Chi ha fatto questa critica?\n\nConosce il tuo ADHD?\n\n√à fonte affidabile?');return;}if(n.includes('priority')||n.includes('priorit√†')||n.includes('urgente')){showGuidedQuestion('Priority Check','Questa √® DAVVERO la cosa pi√π urgente ORA?\n\nSe s√¨, perch√©?\n\nSe no, qual √®?');return;}if(n.includes('ambiente')||n.includes('stimoli')||n.includes('reset amb')){showGuidedTip('Reset Ambiente','üßπ Togli stimoli non necessari:\n\n‚Ä¢ Chiudi tab extra\n‚Ä¢ Phone in altra stanza\n‚Ä¢ Cuffie noise-cancelling\n‚Ä¢ Solo il necessario sul tavolo\n\nAmbiente pulito = mente pulita');return;}if(n.includes('amico')||n.includes('friend')){showGuidedQuestion('Prospettiva Amico','Cosa diresti a un amico ADHD in questa situazione?\n\n(Usa quella compassione per te)');return;}if(n.includes('ripara')){showGuidedQuestion('Ripara e Vai','Puoi rimediare?\n\nSe s√¨: fallo ORA\nSe no: lascia andare\n\nQuale scegli?');return;}showGuidedTip(name,'üí° '+name+'\n\nStrategia attivata!');}
function startCustomTimer(minutes){timerSeconds=minutes*60;timerTotalSeconds=minutes*60;showScreen('timerScreen');resetTimer();updateTimerDisplay();}
function showDumpWithPrompt(prompt){showScreen('dumpScreen');document.getElementById('dumpTextarea').value=prompt;document.getElementById('dumpTextarea').focus();}
function showChecklist(strategyName){const n=strategyName.toLowerCase();let items=[];let emoji='‚úì';let subtitle='Controlla questi punti';if(n.includes('check')||n.includes('basics')){items=['Ho mangiato?','Ho bevuto acqua?','Ho dormito abbastanza?','Sto sovrastimolato?','Ho preso le medicine?'];emoji='üè•';subtitle='Check fisico - Basics prima di tutto';}else{items=['Punto 1','Punto 2','Punto 3'];}document.getElementById('checklistEmoji').textContent=emoji;document.getElementById('checklistTitle').textContent=strategyName;document.getElementById('checklistSubtitle').textContent=subtitle;let html='';items.forEach((item,i)=>{html+='<div style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-card);border-radius:var(--radius-md);margin-bottom:12px;cursor:pointer" onclick="toggleCheckItem('+i+')"><input type="checkbox" id="check_'+i+'" style="width:20px;height:20px;cursor:pointer"><label for="check_'+i+'" style="flex:1;font-size:0.95rem;cursor:pointer">'+item+'</label></div>';});document.getElementById('checklistItems').innerHTML=html;showScreen('checklistScreen');}
function toggleCheckItem(i){const cb=document.getElementById('check_'+i);cb.checked=!cb.checked;}
function completeChecklist(){addGardenPoints(10,'Checklist completata');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}showScreen('responseScreen');}
function completeMicroStep(){const input=document.getElementById('microStepInput').value.trim();if(input){state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:'microstep',text:'üéØ Micro-step: '+input,type:'microstep'});saveState();}addGardenPoints(5,'Micro-step completato');if(state.history.length>0){const h=state.history[0];h.strategyUsed=h.strategyUsed||'Primo micro-step';h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}document.getElementById('microStepInput').value='';showToast('üéØ Ottimo! Hai fatto il primo passo!');showScreen('responseScreen');}
function completeStrategy(name){addGardenPoints(3,'Strategia: '+name);if(state.history.length>0){const h=state.history[0];h.strategyUsed=name;h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,name,true);}saveState();showToast('‚úì '+name+' completata! +3 punti');event.target.textContent='‚úì Fatto';event.target.style.background='var(--accent-green)';event.target.style.color='white';event.target.disabled=true;}
let currentStrategyDetail={name:'',desc:''};
function showStrategyDetail(name){const allStrats=Object.values(responses).flatMap(r=>r.strategies);const strat=allStrats.find(s=>s.name===name);if(!strat)return;currentStrategyDetail={name:name,desc:strat.desc};document.getElementById('strategyDetailTitle').textContent=name;document.getElementById('strategyDetailDesc').textContent=strat.desc;const explanation=strategyExplanations[name]||'Questa strategia pu√≤ aiutarti a gestire la situazione.';document.getElementById('strategyDetailExplanation').textContent=explanation;showScreen('strategyDetailScreen');}
function executeStrategyFromDetail(){const name=currentStrategyDetail.name;executeStrategy(name);}
function completeStrategyFromDetail(){const name=currentStrategyDetail.name;addGardenPoints(3,'Strategia: '+name);if(state.history.length>0){const h=state.history[0];h.strategyUsed=name;h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,name,true);}saveState();showToast('‚úì '+name+' completata! +3 punti');showScreen('responseScreen');}
function showGuidedTip(title,content){document.getElementById('tipEmoji').textContent='üí°';document.getElementById('tipTitle').textContent=title;document.getElementById('tipContent').textContent=content;showScreen('guidedTipScreen');}
function showGuidedQuestion(title,question){document.getElementById('questionEmoji').textContent='üí≠';document.getElementById('questionTitle').textContent=title;document.getElementById('questionPrompt').textContent=question;document.getElementById('questionAnswer').value='';showScreen('guidedQuestionScreen');}
function saveGuidedAnswer(){const answer=document.getElementById('questionAnswer').value.trim();if(answer){state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:'reflection',text:answer,type:'reflection'});saveState();addGardenPoints(5,'Riflessione salvata');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}showScreen('responseScreen');}else{showToast('Scrivi una risposta');}}
function giveFeedback(h){if(state.history.length>0)state.history[0].helpful=h;saveState();document.querySelectorAll('.feedback-btn').forEach(b=>b.classList.remove('selected'));event.target.classList.add('selected');showToast(h?'Grazie! üíö':'Grazie per il feedback');}
function finishAndGoHome(){screenHistory=['homeScreen'];showScreen('homeScreen');}
function startTimer(){document.getElementById('timerStartBtn').style.display='none';timerInterval=setInterval(()=>{timerSeconds--;updateTimerDisplay();if(timerSeconds<=0){clearInterval(timerInterval);timerDone();}},1000);}
function updateTimerDisplay(){const m=Math.floor(timerSeconds/60),s=timerSeconds%60;document.getElementById('timerDisplay').textContent=m+':'+(s<10?'0':'')+s;const offset=565.48*(1-timerSeconds/timerTotalSeconds);document.getElementById('timerProgress').style.strokeDashoffset=offset;}
function timerDone(){document.getElementById('timerControls').style.display='none';document.getElementById('timerDone').classList.add('show');addGardenPoints(10,'Timer completato');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}}
function resetTimer(){timerSeconds=timerTotalSeconds;updateTimerDisplay();document.getElementById('timerDone').classList.remove('show');document.getElementById('timerControls').style.display='flex';document.getElementById('timerStartBtn').style.display='block';}
function stopTimer(){clearInterval(timerInterval);resetTimer();}
function startBreathing(){document.getElementById('breatheStartBtn').style.display='none';breatheCycles=5;runBreatheCycle();}
function runBreatheCycle(){if(breatheCycles<=0){breathingDone();return;}const c=document.getElementById('breatheCircle'),i=document.getElementById('breatheInstruction'),n=document.getElementById('breatheCounter');c.classList.add('inhale');c.classList.remove('exhale');i.textContent='Inspira...';n.textContent=breatheCycles+' cicli';setTimeout(()=>{c.classList.remove('inhale');c.classList.add('exhale');i.textContent='Espira...';setTimeout(()=>{breatheCycles--;runBreatheCycle();},4000);},4000);}
function breathingDone(){document.getElementById('breatheInstruction').textContent='Fatto! üôè';document.getElementById('breatheCounter').textContent='Come ti senti?';document.getElementById('breatheStartBtn').style.display='block';document.getElementById('breatheStartBtn').textContent='Ripeti';addGardenPoints(5,'Respirazione completata');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}}
function stopBreathing(){breatheCycles=0;document.getElementById('breatheCircle').classList.remove('inhale','exhale');document.getElementById('breatheInstruction').textContent='Pronto?';document.getElementById('breatheCounter').textContent='5 cicli';document.getElementById('breatheStartBtn').style.display='block';document.getElementById('breatheStartBtn').textContent='Inizia';}
function saveDump(){const t=document.getElementById('dumpTextarea').value;if(t.trim()){state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:'dump',text:t,type:'dump'});saveState();addGardenPoints(5,'Pensieri salvati');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}}else{showScreen('responseScreen');}document.getElementById('dumpTextarea').value='';showScreen('responseScreen');}
function initGrounding(){currentGroundStep=0;renderGroundingSteps();}
function renderGroundingSteps(){document.getElementById('groundingSteps').innerHTML=groundingSteps.map((s,i)=>'<div class="ground-step'+(i===currentGroundStep?' active':'')+(i<currentGroundStep?' done':'')+'"><div class="ground-step-num">'+(i<currentGroundStep?'‚úì':s.num)+'</div><div class="ground-step-content"><div class="ground-step-title">'+s.sense+'</div><div class="ground-step-desc">'+s.desc+'</div><div class="ground-step-input"><div class="ground-input-row">'+s.placeholders.map(p=>'<input type="text" class="ground-input-item" placeholder="'+p+'">').join('')+'</div><button class="ground-next-btn" onclick="nextGroundStep()">Avanti ‚Üí</button></div></div></div>').join('');}
function nextGroundStep(){currentGroundStep++;if(currentGroundStep>=groundingSteps.length){addGardenPoints(5,'Grounding completato');if(state.history.length>0){const h=state.history[0];h.strategyCompleted=true;if(h.taskName)updateTaskDatabase(h.taskName,h.taskCategory,h.feeling,h.trigger,h.intensity,h.strategyUsed,true);}setTimeout(()=>showScreen('responseScreen'),1500);return;}renderGroundingSteps();}
function renderDiaryMoods(){document.getElementById('diaryMoodGrid').innerHTML=diaryMoods.map(m=>'<button class="diary-mood-btn" data-id="'+m.id+'" onclick="selectDiaryMood(\''+m.id+'\')"><span class="emoji">'+m.emoji+'</span><span class="label">'+m.label+'</span></button>').join('');}
function selectDiaryMood(id){diaryMood=id;document.querySelectorAll('.diary-mood-btn').forEach(b=>b.classList.toggle('selected',b.dataset.id===id));}
function addPrompt(t){const i=document.getElementById('diaryTextInput');i.value=t+' '+i.value;i.focus();}
function saveDiaryEntry(){const t=document.getElementById('diaryTextInput').value.trim();if(!t){showToast('Scrivi qualcosa');return;}state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:diaryMood||'okay',text:t,type:'entry'});saveState();document.getElementById('diaryTextInput').value='';diaryMood=null;document.querySelectorAll('.diary-mood-btn').forEach(b=>b.classList.remove('selected'));addGardenPoints(5,'Nota salvata');showScreen('diaryScreen');}
function renderDiaryEntries(){const c=document.getElementById('diaryEntries');const e=state.diary.filter(x=>x.type==='entry'||x.type==='dump'||x.type==='microstep');if(e.length===0){c.innerHTML='<div class="empty-state"><div class="emoji">üìù</div><h3>Nessuna nota</h3><p>Inizia a scrivere</p></div>';return;}c.innerHTML=e.slice(0,20).map(x=>{const m=diaryMoods.find(d=>d.id===x.mood)||{emoji:'üí≠'};const d=new Date(x.date);return'<div class="diary-entry"><div class="diary-entry-header" onclick="openDiaryEntry('+x.id+')" style="cursor:pointer"><span class="diary-entry-emoji">'+m.emoji+'</span><div class="diary-entry-meta"><div class="diary-entry-date">'+formatDate(d)+'</div><div class="diary-entry-time">'+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})+'</div></div></div><p class="diary-entry-text" onclick="openDiaryEntry('+x.id+')" style="cursor:pointer">'+x.text+'</p><div class="history-card-actions"><button class="edit-btn" onclick="editDiaryEntryById('+x.id+')">‚úèÔ∏è Modifica</button><button class="delete-btn" onclick="deleteDiaryEntryById('+x.id+')">üóëÔ∏è Elimina</button></div></div>';}).join('');}
function openDiaryEntry(id){currentDiaryEntry=state.diary.find(x=>x.id===id);if(!currentDiaryEntry)return;const m=diaryMoods.find(x=>x.id===currentDiaryEntry.mood)||{emoji:'üí≠'};const d=new Date(currentDiaryEntry.date);document.getElementById('diaryDetailHeader').innerHTML='<div class="diary-detail-emoji">'+m.emoji+'</div><div class="diary-detail-date">'+formatDate(d)+'</div><div class="diary-detail-time">'+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})+'</div>';document.getElementById('diaryDetailText').textContent=currentDiaryEntry.text;showScreen('diaryDetailScreen');}
function deleteDiaryEntry(){if(!currentDiaryEntry)return;if(confirm('Eliminare?')){state.diary=state.diary.filter(x=>x.id!==currentDiaryEntry.id);saveState();showToast('Eliminata');showScreen('diaryScreen');}}
function deleteDiaryEntryById(id){if(!confirm('Vuoi davvero eliminare questa nota?\n\nQuesta azione non pu√≤ essere annullata.'))return;state.diary=state.diary.filter(x=>x.id!==id);saveState();renderDiaryEntries();showToast('üóëÔ∏è Nota eliminata');}
function editDiaryEntryById(id){const entry=state.diary.find(x=>x.id===id);if(!entry)return;const newText=prompt('Modifica il testo:',entry.text);if(newText===null)return;if(!newText.trim()){showToast('Il testo non pu√≤ essere vuoto');return;}entry.text=newText;saveState();renderDiaryEntries();showToast('‚úèÔ∏è Modificata');}
function updatePatterns(){const e=state.history[0];if(!e)return;if(!state.patterns.feelings)state.patterns.feelings={};if(!state.patterns.triggers)state.patterns.triggers={};if(!state.patterns.times)state.patterns.times={};state.patterns.feelings[e.feeling]=(state.patterns.feelings[e.feeling]||0)+1;state.patterns.triggers[e.trigger]=(state.patterns.triggers[e.trigger]||0)+1;const h=new Date(e.date).getHours();const t=h<12?'mattina':h<18?'pomeriggio':'sera';state.patterns.times[t]=(state.patterns.times[t]||0)+1;}
function renderInsights(){const c=document.getElementById('insightsContent');let h='<button class="generate-report-btn" onclick="showScreen(\'reportScreen\')"><span>üìñ</span><span>Condividi il tuo percorso</span></button>';if(state.history.length<3){c.innerHTML=h+'<div class="empty-state"><div class="emoji">üìä</div><h3>Non ho abbastanza dati</h3><p>Usa l\'app qualche volta</p></div>';return;}if(state.patterns.feelings){const t=Object.entries(state.patterns.feelings).sort((a,b)=>b[1]-a[1])[0];if(t){const f=feelings.find(x=>x.id===t[0]);h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+f.emoji+'</span><span class="insight-card-title">Emozione pi√π frequente</span></div><p class="insight-card-content">Ti senti <span class="insight-highlight">'+f.label.toLowerCase()+'</span> pi√π spesso ('+t[1]+' volte).</p></div>';}}if(state.patterns.triggers){const t=Object.entries(state.patterns.triggers).sort((a,b)=>b[1]-a[1])[0];if(t){const tr=triggers.find(x=>x.id===t[0]);h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+tr.emoji+'</span><span class="insight-card-title">Trigger pi√π comune</span></div><p class="insight-card-content">"<span class="insight-highlight">'+tr.label+'</span>" ti mette in difficolt√† pi√π spesso.</p></div>';}}if(state.patterns.times){const t=Object.entries(state.patterns.times).sort((a,b)=>b[1]-a[1])[0];if(t&&t[1]>=2)h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">üïê</span><span class="insight-card-title">Momento critico</span></div><p class="insight-card-content">I momenti difficili arrivano pi√π spesso <span class="insight-highlight">di '+t[0]+'</span>.</p></div>';}const difficultTasks=getTopDifficultTasks(3);if(difficultTasks.length>0){h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">üìã</span><span class="insight-card-title">Task pi√π difficili</span></div><div class="insight-card-content">';difficultTasks.forEach(task=>{const rate=task.timesResolved>0?Math.round((task.timesResolved/task.timesBlocked)*100):0;const best=getBestStrategyForTask(normalizeTaskName(task.name));h+='<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span>'+getCategoryEmoji(task.category)+'</span><span style="font-weight:600">'+task.name+'</span></div><div style="font-size:0.85rem;color:var(--text-muted)">Blocca spesso ('+task.timesBlocked+' volte) ¬∑ Risolto '+rate+'%</div>';if(best){h+='<div style="font-size:0.85rem;color:var(--accent-green);margin-top:4px">‚Üí '+best.name+' funziona ('+Math.round(best.rate*100)+'%)</div>';}h+='</div>';});h+='</div></div>';}const tasksWithStrat=getTasksWithBestStrategies(3);if(tasksWithStrat.length>0){h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">‚ö°</span><span class="insight-card-title">Cosa funziona per te</span></div><div class="insight-card-content">';tasksWithStrat.forEach(item=>{h+='<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span>'+getCategoryEmoji(item.task.category)+'</span><span style="font-weight:600">'+item.task.name+'</span></div><div style="font-size:0.9rem;color:var(--accent-green)">‚Üí '+item.strategy.name+' <span style="font-weight:700">('+Math.round(item.strategy.rate*100)+'% successo)</span></div></div>';});h+='</div></div>';}if(state.diary.length>0)h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">üìù</span><span class="insight-card-title">Il tuo diario</span></div><p class="insight-card-content">Hai scritto <span class="insight-highlight">'+state.diary.length+' note</span>.</p></div>';c.innerHTML=h||'<div class="empty-state"><div class="emoji">üîç</div><h3>Pochi dati</h3></div>';}
function setHistoryPeriod(period){historyPeriodFilter=period;document.querySelectorAll('[data-period]').forEach(b=>b.classList.toggle('selected',b.dataset.period===period));renderHistory();}
function setHistoryFeeling(feelingId){historyFeelingFilter=historyFeelingFilter===feelingId?null:feelingId;document.querySelectorAll('[data-feeling]').forEach(b=>b.classList.toggle('selected',b.dataset.feeling===historyFeelingFilter));renderHistory();}
function initHistoryFilters(){const container=document.getElementById('historyFeelingFilters');if(!container)return;let h='<button class="filter-chip selected" data-feeling="all" onclick="setHistoryFeeling(null)">Tutte</button>';feelings.forEach(f=>{h+='<button class="filter-chip" data-feeling="'+f.id+'" onclick="setHistoryFeeling(\''+f.id+'\')">'+f.emoji+' '+f.label+'</button>';});container.innerHTML=h;}
function filterHistory(){let filtered=[...state.history];if(historyPeriodFilter!=='all'){const now=new Date();const cutoff=new Date();if(historyPeriodFilter==='today')cutoff.setHours(0,0,0,0);else if(historyPeriodFilter==='week')cutoff.setDate(now.getDate()-7);else if(historyPeriodFilter==='month')cutoff.setMonth(now.getMonth()-1);filtered=filtered.filter(e=>new Date(e.date)>=cutoff);}if(historyFeelingFilter){filtered=filtered.filter(e=>e.feeling===historyFeelingFilter);}return filtered;}
function renderHistory(){initHistoryFilters();const filtered=filterHistory();const c=document.getElementById('historyContent');const counter=document.getElementById('historyCount');if(state.history.length===0){c.innerHTML='<div class="empty-state"><div class="emoji">üìã</div><h3>Nessun momento</h3></div>';counter.textContent='I tuoi momenti';return;}counter.textContent=filtered.length+(filtered.length===1?' momento':' momenti')+(filtered.length<state.history.length?' (filtrati)':'');if(filtered.length===0){c.innerHTML='<div class="empty-state"><div class="emoji">üîç</div><h3>Nessun risultato</h3><p>Prova altri filtri</p></div>';return;}c.innerHTML='<div style="padding:0 20px">'+filtered.slice(0,50).map(e=>{const f=feelings.find(x=>x.id===e.feeling)||{emoji:'üò∂',label:'Sconosciuto'};const tr=triggers.find(x=>x.id===e.trigger)||{label:'Sconosciuto'};const d=new Date(e.date);let h='<div class="history-card">';h+='<div class="history-card-header">';h+='<div class="history-card-emoji">'+f.emoji+'</div>';h+='<div class="history-card-main">';h+='<div class="history-card-feeling">'+f.label+'</div>';h+='<div class="history-card-meta">';h+='<span>'+formatDate(d)+'</span>';h+='<span>‚Ä¢</span>';h+='<span>'+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})+'</span>';h+='</div>';h+='</div>';h+='<div class="diary-entry-intensity" style="margin-top:4px">'+ [1,2,3,4,5].map(i=>'<div class="diary-intensity-dot'+(i<=e.intensity?' filled':'')+'"></div>').join('')+'</div>';h+='</div>';h+='<div class="history-card-trigger">üìã '+tr.label+'</div>';if(e.taskName){const emoji=getCategoryEmoji(e.taskCategory||'altro');h+='<div class="history-card-task">'+emoji+' <strong>'+e.taskName+'</strong></div>';}if(e.strategyUsed){const completed=e.strategyCompleted;h+='<div class="history-card-strategy'+(completed?'':' incomplete')+'"><span>'+(completed?'‚úì':'‚óã')+'</span><span>'+e.strategyUsed+'</span></div>';}if(e.notes){h+='<div style="margin-top:8px;padding:8px;background:rgba(160,160,184,0.1);border-radius:6px;font-size:0.85rem;color:var(--text-secondary)">'+e.notes+'</div>';}h+='<div class="history-card-actions"><button class="edit-btn" onclick="editHistoryItem('+e.id+')">‚úèÔ∏è Modifica</button><button class="delete-btn" onclick="deleteHistoryItem('+e.id+')">üóëÔ∏è Elimina</button></div>';h+='</div>';return h;}).join('')+'</div>';}
function formatDate(d){const n=new Date(),diff=n-d,days=Math.floor(diff/(1000*60*60*24));if(days===0){const h=Math.floor(diff/(1000*60*60));return h===0?'Ora':h+' ore fa';}if(days===1)return'Ieri';if(days<7)return days+' giorni fa';return d.toLocaleDateString('it-IT',{day:'numeric',month:'short'});}
function deleteHistoryItem(id){if(!confirm('Vuoi davvero eliminare questo momento?\n\nQuesta azione non pu√≤ essere annullata.'))return;state.history=state.history.filter(e=>e.id!==id);saveState();renderHistory();showToast('üóëÔ∏è Momento eliminato');}
function editHistoryItem(id){const item=state.history.find(e=>e.id===id);if(!item)return;const newNotes=prompt('Modifica le note:',item.notes||'');if(newNotes===null)return;item.notes=newNotes;saveState();renderHistory();showToast('‚úèÔ∏è Modificato');}
function renderLearn(){const c=document.getElementById('learnContent');let h='<div class="diary-entries-title">Concetti chiave</div>';learnTopics.forEach(t=>{h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+t.emoji+'</span><span class="insight-card-title">'+t.title+'</span></div><p class="insight-card-content">'+t.content+'</p></div>';});h+='<div class="diary-entries-title" style="margin-top:24px">Strategie per contesto</div>';h+='<div class="understanding-card"><div class="understanding-title">üíº LAVORO</div>';contextStrategies.lavoro.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';h+='<div class="understanding-card" style="margin-top:12px"><div class="understanding-title">üìö STUDIO</div>';contextStrategies.studio.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';h+='<div class="understanding-card" style="margin-top:12px"><div class="understanding-title">üë• SOCIALE</div>';contextStrategies.sociale.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';c.innerHTML=h;}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function toggleCheckbox(id){const checkbox=document.getElementById(id);checkbox.checked=!checkbox.checked;checkbox.parentElement.classList.toggle('checked',checkbox.checked);}
function selectReportPeriod(days){reportPeriodDays=days;document.querySelectorAll('.report-period-btn').forEach(b=>b.classList.remove('selected'));event.target.classList.add('selected');}
function filterDataByPeriod(data){if(reportPeriodDays===0)return data;const cutoff=new Date();cutoff.setDate(cutoff.getDate()-reportPeriodDays);return data.filter(item=>new Date(item.date)>=cutoff);}
function generatePDFReport(){const{jsPDF}=window.jspdf;const doc=new jsPDF();const includePatterns=document.getElementById('reportIncludePatterns').checked;const includeHistory=document.getElementById('reportIncludeHistory').checked;const includeDiary=document.getElementById('reportIncludeDiary').checked;const includeStrategies=document.getElementById('reportIncludeStrategies').checked;let y=20;doc.setFontSize(20);doc.setFont(undefined,'bold');doc.text('Il Mio Percorso con l\'ADHD',20,y);y+=10;doc.setFontSize(11);doc.setFont(undefined,'normal');const today=new Date().toLocaleDateString('it-IT',{day:'numeric',month:'long',year:'numeric'});const periodText=reportPeriodDays===0?'dall\'inizio':reportPeriodDays===7?'nell\'ultima settimana':'nell\'ultimo mese';doc.text(today,20,y);y+=5;doc.setTextColor(100);doc.text('Questo documento racconta il mio viaggio '+periodText+'.',20,y);doc.setTextColor(0);y+=12;const filteredHistory=filterDataByPeriod(state.history);const filteredDiary=filterDataByPeriod(state.diary);if(filteredHistory.length>0){const intro=doc.splitTextToSize('Ho chiesto aiuto '+filteredHistory.length+(filteredHistory.length===1?' volta':' volte')+' in questo periodo. Ogni momento e\' stato un passo verso la comprensione di me stesso.',170);intro.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;}if(includePatterns&&filteredHistory.length>0){doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('Come Mi Sono Sentito',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const feelingCounts={};const triggerCounts={};filteredHistory.forEach(e=>{feelingCounts[e.feeling]=(feelingCounts[e.feeling]||0)+1;triggerCounts[e.trigger]=(triggerCounts[e.trigger]||0)+1;});const topFeeling=Object.entries(feelingCounts).sort((a,b)=>b[1]-a[1])[0];if(topFeeling){const f=feelings.find(x=>x.id===topFeeling[0]);const lines=doc.splitTextToSize('Molto spesso mi sono sentito '+f.label.toLowerCase()+'. E\' successo '+topFeeling[1]+(topFeeling[1]===1?' volta':' volte')+', e va bene cosi. Riconoscere questa emozione e\' gia\' un grande passo.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=3;}const topTrigger=Object.entries(triggerCounts).sort((a,b)=>b[1]-a[1])[0];if(topTrigger){const tr=triggers.find(x=>x.id===topTrigger[0]);const lines=doc.splitTextToSize('Quello che mi mette piu\' in difficolta\': "'+tr.label+'". Lo so ora, e questa consapevolezza mi da\' potere.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=3;}const avgIntensity=(filteredHistory.reduce((sum,e)=>sum+e.intensity,0)/filteredHistory.length).toFixed(1);const intensityText=avgIntensity<3?'gestibile':'intensa';doc.text('L\'intensita\' media di quello che provo e\' '+intensityText+' ('+avgIntensity+'/5).',20,y);y+=10;}if(includeHistory&&filteredHistory.length>0){if(y>240){doc.addPage();y=20;}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('I Momenti in Cui Ho Chiesto Aiuto',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const lines=doc.splitTextToSize('Questi sono i momenti in cui ho deciso di non affrontare tutto da solo. Ogni volta che ho usato questa app, ho fatto una scelta coraggiosa.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;doc.setFontSize(9);filteredHistory.slice(0,10).forEach(e=>{if(y>270){doc.addPage();y=20;}const f=feelings.find(x=>x.id===e.feeling)||{label:'Sconosciuto'};const tr=triggers.find(x=>x.id===e.trigger)||{label:'Sconosciuto'};const d=new Date(e.date).toLocaleDateString('it-IT',{day:'numeric',month:'short'});const intensityStars='*'.repeat(e.intensity);doc.text(d+' ['+intensityStars+'] '+f.label+' - '+tr.label,23,y);y+=5;});y+=8;}if(includeDiary&&filteredDiary.length>0){if(y>240){doc.addPage();y=20;}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('Le Mie Riflessioni',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const lines=doc.splitTextToSize('Ho scritto queste note per me stesso. Sono pensieri veri, senza filtri.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;doc.setFontSize(9);filteredDiary.slice(0,5).forEach(entry=>{if(y>260){doc.addPage();y=20;}const d=new Date(entry.date).toLocaleDateString('it-IT',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});doc.setFont(undefined,'bold');doc.text(d,23,y);doc.setFont(undefined,'normal');y+=5;const lines=doc.splitTextToSize(entry.text,165);lines.slice(0,3).forEach(line=>{if(y>270){doc.addPage();y=20;}doc.text(line,23,y);y+=5;});y+=3;});}const difficultTasks=getTopDifficultTasks(5);if(difficultTasks.length>0){if(y>210){doc.addPage();y=20;}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('Le Cose Che Trovo Difficili',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const lines=doc.splitTextToSize('Questi task mi bloccano piu\' spesso. Non e\' colpa mia - il mio cervello ADHD li trova piu\' difficili. E va bene.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;doc.setFontSize(9);difficultTasks.forEach(task=>{if(y>265){doc.addPage();y=20;}const rate=task.timesResolved>0?Math.round((task.timesResolved/task.timesBlocked)*100):0;const catLabel={'studio':'Studio','lavoro':'Lavoro','casa':'Casa','sociale':'Sociale','cura':'Cura','admin':'Admin','altro':'Altro'}[task.category]||'Altro';doc.setFont(undefined,'bold');doc.text('['+catLabel+'] '+task.name,23,y);doc.setFont(undefined,'normal');y+=5;doc.text('   Mi ha bloccato '+task.timesBlocked+(task.timesBlocked===1?' volta':' volte')+'. Ho superato il blocco nel '+rate+'% dei casi.',23,y);y+=5;const best=getBestStrategyForTask(normalizeTaskName(task.name));if(best){doc.setTextColor(80,150,100);doc.text('   -> Funziona: '+best.name+' ('+Math.round(best.rate*100)+'% successo)',23,y);doc.setTextColor(0);y+=5;}y+=3;});y+=3;}const tasksWithStrat=getTasksWithBestStrategies(5);if(tasksWithStrat.length>0){if(y>210){doc.addPage();y=20;}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('Ho Scoperto Cosa Funziona Per Me',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const lines=doc.splitTextToSize('Queste strategie hanno funzionato davvero. Sono la mia cassetta degli attrezzi personale.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;doc.setFontSize(9);tasksWithStrat.forEach(item=>{if(y>270){doc.addPage();y=20;}const catLabel={'studio':'Studio','lavoro':'Lavoro','casa':'Casa','sociale':'Sociale','cura':'Cura','admin':'Admin','altro':'Altro'}[item.task.category]||'Altro';doc.text('['+catLabel+'] Per "'+item.task.name+'"',23,y);y+=5;doc.setTextColor(80,150,100);doc.text('   OK '+item.strategy.name+' funziona nel '+Math.round(item.strategy.rate*100)+'% dei casi',23,y);doc.setTextColor(0);y+=7;});}if(includeStrategies){if(y>200){doc.addPage();y=20;}doc.setFontSize(14);doc.setFont(undefined,'bold');doc.text('Altre Strategie Da Provare',20,y);doc.setFont(undefined,'normal');y+=8;doc.setFontSize(10);const lines=doc.splitTextToSize('Queste strategie potrebbero aiutarmi in diversi contesti. Posso provarle quando serve.',170);lines.forEach(line=>{doc.text(line,20,y);y+=5;});y+=5;doc.setFontSize(9);doc.setFont(undefined,'bold');doc.text('Al lavoro:',23,y);doc.setFont(undefined,'normal');y+=5;contextStrategies.lavoro.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}const lines=doc.splitTextToSize('- '+s.name+' - '+s.desc,165);lines.forEach(line=>{doc.text(line,25,y);y+=4;});y+=2;});y+=3;doc.setFont(undefined,'bold');doc.text('Nello studio:',23,y);doc.setFont(undefined,'normal');y+=5;contextStrategies.studio.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}const lines=doc.splitTextToSize('- '+s.name+' - '+s.desc,165);lines.forEach(line=>{doc.text(line,25,y);y+=4;});y+=2;});y+=3;doc.setFont(undefined,'bold');doc.text('Nelle situazioni sociali:',23,y);doc.setFont(undefined,'normal');y+=5;contextStrategies.sociale.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}const lines=doc.splitTextToSize('- '+s.name+' - '+s.desc,165);lines.forEach(line=>{doc.text(line,25,y);y+=4;});y+=2;});}if(y>230){doc.addPage();y=20;}doc.setFontSize(12);doc.setFont(undefined,'bold');doc.text('Riflessione Finale',20,y);doc.setFont(undefined,'normal');y+=10;doc.setFontSize(10);doc.setTextColor(60);const conclusion=doc.splitTextToSize('Questo documento racconta il mio viaggio. Non e\' perfetto, e non deve esserlo. Ogni momento di difficolta\' che ho affrontato, ogni strategia che ho provato, ogni nota che ho scritto - tutto questo fa parte della mia crescita.\n\nConvivere con l\'ADHD e\' una sfida quotidiana, ma sto imparando a conoscermi meglio. Sto costruendo la mia cassetta degli attrezzi. Sto diventando piu\' consapevole.\n\nQuesto non e\' un fallimento. E\' il mio percorso.',170);conclusion.forEach(line=>{if(y>270){doc.addPage();y=20;}doc.text(line,20,y);y+=5;});doc.setTextColor(0);const filename='il-mio-percorso-adhd-'+today.replace(/\//g,'-')+'.pdf';doc.save(filename);showScreen('insightsScreen');showToast('üìñ Percorso salvato!');}
</script>
</body>
</html>
