<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Come Stai?">
  <title>Come Stai?</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{--bg-deep:#1a1a2e;--bg-card:#25253d;--bg-elevated:#2d2d4a;--accent-calm:#7eb8da;--accent-warm:#e8a87c;--accent-soft:#c3aed6;--accent-green:#7dd3a8;--accent-coral:#e07a7a;--text-primary:#f0f0f5;--text-secondary:#a0a0b8;--text-muted:#6a6a82;--radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-full:100px;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,20px)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Nunito',sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.6}
    .app{height:100%;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
    .screen{display:none;flex-direction:column;height:100%;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .screen.active{display:flex}
    .home-screen{justify-content:center;align-items:center;text-align:center;padding:40px 24px}
    .home-greeting{font-size:1.1rem;color:var(--text-secondary);margin-bottom:8px}
    .home-question{font-size:1.9rem;font-weight:800;margin-bottom:35px;line-height:1.2}
    .home-main-btn{width:160px;height:160px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 20px 60px rgba(126,184,218,0.3);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .home-main-btn:active{transform:scale(0.95)}
    .home-main-btn .icon{font-size:2.2rem}
    .home-actions{margin-top:40px;display:flex;flex-direction:column;gap:12px;width:100%;max-width:280px}
    .home-action-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px 24px;border-radius:var(--radius-lg);border:1px solid var(--bg-elevated);background:var(--bg-card);color:var(--text-secondary);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer}
    .home-action-btn:active{background:var(--bg-elevated);transform:scale(0.98)}
    .home-secondary{margin-top:30px;display:flex;gap:12px}
    .home-sec-btn{padding:12px 20px;border-radius:var(--radius-full);border:1px solid var(--bg-elevated);background:transparent;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer}
    .flow-header{display:flex;align-items:center;gap:16px;margin-bottom:30px;padding-top:10px}
    .back-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-secondary);font-size:1.25rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .flow-progress{flex:1;height:4px;background:var(--bg-elevated);border-radius:2px;overflow:hidden}
    .flow-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-calm),var(--accent-soft));transition:width 0.4s}
    .flow-step{font-size:0.85rem;color:var(--text-muted)}
    .flow-question{font-size:1.5rem;font-weight:700;margin-bottom:12px}
    .flow-subtitle{color:var(--text-secondary);font-size:1rem;margin-bottom:30px}
    .options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .option-card{background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);padding:20px 16px;cursor:pointer;text-align:center;transition:all 0.2s}
    .option-card:active{transform:scale(0.97)}
    .option-card.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .option-card .emoji{font-size:2rem;margin-bottom:10px;display:block}
    .option-card .label{font-size:0.9rem;font-weight:600}
    .triggers-list{display:flex;flex-direction:column;gap:10px}
    .trigger-card{background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);padding:18px 20px;cursor:pointer;display:flex;align-items:center;gap:14px}
    .trigger-card.selected{border-color:var(--accent-warm);background:rgba(232,168,124,0.1)}
    .trigger-card .emoji{font-size:1.5rem}
    .trigger-card .label{font-size:0.95rem;font-weight:600}
    .intensity-section{margin-top:24px}
    .intensity-label{display:flex;justify-content:space-between;margin-bottom:16px;font-size:0.9rem;color:var(--text-secondary)}
    .intensity-value{font-weight:700;color:var(--text-primary)}
    .intensity-bar{display:flex;gap:8px}
    .intensity-dot{flex:1;height:50px;border-radius:var(--radius-sm);border:2px solid var(--bg-elevated);background:var(--bg-card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--text-muted)}
    .intensity-dot.selected{border-color:var(--accent-warm);background:rgba(232,168,124,0.15);color:var(--accent-warm)}
    .response-screen{padding:20px;padding-bottom:40px}
    .response-header{text-align:center;margin-bottom:24px}
    .response-emoji{font-size:3rem;margin-bottom:12px}
    .response-title{font-size:1.3rem;font-weight:700;margin-bottom:6px}
    .response-feeling{color:var(--accent-calm);font-weight:600}
    .understanding-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:20px}
    .understanding-title{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--accent-soft);margin-bottom:10px}
    .understanding-text{font-size:0.95rem;color:var(--text-secondary);line-height:1.6}
    .understanding-text strong{color:var(--text-primary)}
    .guided-actions{margin-bottom:24px}
    .guided-actions-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .guided-action-card{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;cursor:pointer;border:1px solid transparent}
    .guided-action-card:active{border-color:var(--accent-calm)}
    .guided-action-icon{width:48px;height:48px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.5rem;background:rgba(126,184,218,0.15)}
    .guided-action-info{flex:1}
    .guided-action-name{font-weight:700;font-size:0.95rem}
    .guided-action-desc{font-size:0.8rem;color:var(--text-muted)}
    .guided-action-arrow{color:var(--text-muted);font-size:1.2rem}
    .strategies-section{margin-bottom:24px}
    .strategies-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .strategy-card{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:10px;border-left:3px solid var(--accent-green)}
    .strategy-card.secondary{border-left-color:var(--accent-calm)}
    .strategy-name{font-weight:700;font-size:0.95rem;margin-bottom:4px}
    .strategy-desc{font-size:0.85rem;color:var(--text-secondary);line-height:1.5}
    .feedback-section{text-align:center;padding:16px 0}
    .feedback-question{font-size:0.9rem;color:var(--text-secondary);margin-bottom:12px}
    .feedback-btns{display:flex;justify-content:center;gap:12px}
    .feedback-btn{padding:10px 20px;border-radius:var(--radius-full);border:1px solid var(--bg-elevated);background:var(--bg-card);color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer}
    .feedback-btn.selected.positive{background:rgba(125,211,168,0.15);border-color:var(--accent-green);color:var(--accent-green)}
    .feedback-btn.selected.negative{background:rgba(224,122,122,0.15);border-color:var(--accent-coral);color:var(--accent-coral)}
    .timer-screen,.breathe-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px}
    .timer-title,.breathe-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .timer-subtitle,.breathe-subtitle{color:var(--text-secondary);font-size:0.95rem;margin-bottom:40px}
    .timer-circle{width:200px;height:200px;position:relative;margin-bottom:40px}
    .timer-circle svg{transform:rotate(-90deg)}
    .timer-circle circle{fill:none;stroke-width:8}
    .timer-circle .bg{stroke:var(--bg-elevated)}
    .timer-circle .progress{stroke:var(--accent-calm);stroke-linecap:round;transition:stroke-dashoffset 1s linear}
    .timer-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;font-weight:800}
    .timer-controls,.breathe-controls{display:flex;gap:16px}
    .timer-btn{padding:16px 32px;border-radius:var(--radius-full);border:none;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .timer-btn.primary{background:var(--accent-calm);color:var(--bg-deep)}
    .timer-btn.secondary{background:var(--bg-card);color:var(--text-secondary)}
    .timer-done{display:none;flex-direction:column;align-items:center;gap:16px}
    .timer-done.show{display:flex}
    .timer-done-emoji{font-size:4rem}
    .timer-done-text{font-size:1.2rem;font-weight:700}
    .breathe-circle{width:180px;height:180px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));display:flex;align-items:center;justify-content:center;margin-bottom:30px;transition:transform 4s ease-in-out;box-shadow:0 0 60px rgba(195,174,214,0.3)}
    .breathe-circle.inhale{transform:scale(1.3)}
    .breathe-circle.exhale{transform:scale(1)}
    .breathe-instruction{font-size:1.5rem;font-weight:700;color:var(--bg-deep)}
    .breathe-counter{font-size:1.1rem;color:var(--text-secondary);margin-bottom:40px}
    .dump-screen,.ground-screen{padding:20px;padding-bottom:120px}
    .dump-header,.ground-header{text-align:center;margin-bottom:24px}
    .dump-emoji,.ground-emoji{font-size:2.5rem;margin-bottom:12px}
    .dump-title,.ground-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .dump-subtitle,.ground-subtitle{color:var(--text-secondary);font-size:0.9rem}
    .dump-textarea{width:100%;min-height:250px;padding:20px;background:var(--bg-card);border:2px solid var(--bg-elevated);border-radius:var(--radius-lg);color:var(--text-primary);font-family:inherit;font-size:1rem;line-height:1.6;resize:none}
    .dump-textarea:focus{outline:none;border-color:var(--accent-warm)}
    .dump-tip{margin-top:16px;padding:14px;background:rgba(232,168,124,0.1);border-radius:var(--radius-md);font-size:0.85rem;color:var(--accent-warm)}
    .dump-actions{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;display:flex;gap:12px}
    .dump-actions .btn{flex:1;padding:16px;border-radius:var(--radius-lg);border:none;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .dump-actions .btn.primary{background:var(--accent-warm);color:var(--bg-deep)}
    .dump-actions .btn.secondary{background:var(--bg-card);color:var(--text-secondary)}
    .ground-step{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:12px;display:flex;align-items:flex-start;gap:16px;border:2px solid transparent}
    .ground-step.active{border-color:var(--accent-green);background:rgba(125,211,168,0.08)}
    .ground-step.done{opacity:0.5}
    .ground-step-num{width:36px;height:36px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem}
    .ground-step.active .ground-step-num{background:var(--accent-green);color:var(--bg-deep)}
    .ground-step-content{flex:1}
    .ground-step-title{font-weight:700;margin-bottom:4px}
    .ground-step-desc{font-size:0.85rem;color:var(--text-secondary)}
    .ground-step-input{margin-top:12px;display:none}
    .ground-step.active .ground-step-input{display:block}
    .ground-input-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .ground-input-item{padding:8px 14px;background:var(--bg-elevated);border:1px solid transparent;border-radius:var(--radius-full);color:var(--text-secondary);font-family:inherit;font-size:0.85rem}
    .ground-input-item:focus{outline:none;border-color:var(--accent-green)}
    .ground-next-btn{margin-top:12px;padding:12px 24px;background:var(--accent-green);color:var(--bg-deep);border:none;border-radius:var(--radius-full);font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer}
    .diary-screen{padding:20px}
    .diary-header,.insights-header{margin-bottom:24px}
    .diary-title,.insights-title{font-size:1.5rem;font-weight:800;margin-bottom:6px}
    .diary-subtitle,.insights-subtitle{color:var(--text-secondary);font-size:0.95rem}
    .diary-new-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:18px;background:linear-gradient(135deg,var(--accent-warm),var(--accent-coral));color:white;border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:24px}
    .diary-entries-title{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:12px}
    .diary-entry{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;margin-bottom:12px;cursor:pointer}
    .diary-entry-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .diary-entry-emoji{font-size:1.5rem}
    .diary-entry-meta{flex:1}
    .diary-entry-date{font-weight:600;font-size:0.9rem}
    .diary-entry-time{font-size:0.8rem;color:var(--text-muted)}
    .diary-entry-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .diary-entry-intensity{display:flex;gap:3px}
    .diary-intensity-dot{width:8px;height:8px;border-radius:2px;background:var(--bg-elevated)}
    .diary-intensity-dot.filled{background:var(--accent-warm)}
    .diary-new-screen{padding:20px;padding-bottom:120px}
    .diary-new-header{text-align:center;margin-bottom:24px}
    .diary-new-title{font-size:1.3rem;font-weight:700;margin-bottom:8px}
    .diary-section-label{font-size:0.9rem;font-weight:600;margin-bottom:12px}
    .diary-mood-grid{display:flex;justify-content:space-between;gap:8px}
    .diary-mood-btn{flex:1;padding:14px 8px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);cursor:pointer;text-align:center}
    .diary-mood-btn.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .diary-mood-btn .emoji{font-size:1.5rem;display:block;margin-bottom:4px}
    .diary-mood-btn .label{font-size:0.7rem;color:var(--text-muted)}
    .diary-text-section{margin-bottom:20px}
    .diary-text-input{width:100%;min-height:150px;padding:16px;background:var(--bg-card);border:2px solid var(--bg-elevated);border-radius:var(--radius-lg);color:var(--text-primary);font-family:inherit;font-size:1rem;line-height:1.6;resize:none}
    .diary-text-input:focus{outline:none;border-color:var(--accent-calm)}
    .diary-prompts{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .diary-prompt{padding:8px 14px;background:var(--bg-card);border:1px solid var(--bg-elevated);border-radius:var(--radius-full);font-size:0.8rem;color:var(--text-secondary);cursor:pointer}
    .diary-save-btn{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;padding:18px;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer}
    .diary-detail-screen{padding:20px}
    .diary-detail-header{text-align:center;padding:20px 0;border-bottom:1px solid var(--bg-elevated);margin-bottom:20px}
    .diary-detail-emoji{font-size:3rem;margin-bottom:12px}
    .diary-detail-date{font-size:1.1rem;font-weight:700}
    .diary-detail-time{color:var(--text-muted);font-size:0.9rem}
    .diary-detail-content{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:20px}
    .diary-detail-text{font-size:1rem;line-height:1.7;color:var(--text-secondary)}
    .diary-delete-btn{width:100%;padding:14px;background:rgba(224,122,122,0.1);border:none;border-radius:var(--radius-lg);color:var(--accent-coral);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer}
    .insight-card{background:var(--bg-card);border-radius:var(--radius-lg);padding:20px;margin-bottom:14px}
    .insight-card-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .insight-card-emoji{font-size:1.4rem}
    .insight-card-title{font-weight:700;font-size:0.95rem}
    .insight-card-content{font-size:0.9rem;color:var(--text-secondary);line-height:1.6}
    .insight-highlight{color:var(--accent-calm);font-weight:600}
    .continue-btn{position:fixed;bottom:calc(var(--safe-bottom) + 20px);left:20px;right:20px;padding:18px;background:linear-gradient(135deg,var(--accent-calm),var(--accent-soft));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1.05rem;font-weight:700;cursor:pointer;display:none;z-index:100}
    .continue-btn.show{display:block}
    .close-btn{position:fixed;top:calc(var(--safe-top) + 16px);right:20px;width:44px;height:44px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-secondary);font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:100}
    .notes-section{margin-top:20px}
    .notes-label{font-size:0.9rem;color:var(--text-secondary);margin-bottom:10px}
    .notes-input{width:100%;padding:16px;background:var(--bg-elevated);border:2px solid var(--bg-elevated);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:1rem;resize:none;min-height:80px}
    .notes-input:focus{outline:none;border-color:var(--accent-calm)}
    .empty-state{text-align:center;padding:50px 20px}
    .empty-state .emoji{font-size:3.5rem;margin-bottom:16px}
    .empty-state h3{font-size:1.1rem;margin-bottom:8px}
    .empty-state p{color:var(--text-muted);font-size:0.9rem}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-elevated);color:var(--text-primary);padding:16px 28px;border-radius:var(--radius-full);font-weight:600;box-shadow:0 10px 40px rgba(0,0,0,0.3);opacity:0;transition:all 0.3s;z-index:200}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .report-option{margin-bottom:20px}
    .report-option-label{display:block;font-size:0.9rem;font-weight:700;margin-bottom:12px;color:var(--text-primary)}
    .report-checkbox{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .report-checkbox:active{transform:scale(0.98)}
    .report-checkbox.checked{border-color:var(--accent-calm);background:rgba(126,184,218,0.1)}
    .report-checkbox input{width:22px;height:22px;cursor:pointer;accent-color:var(--accent-calm)}
    .report-checkbox-label{flex:1;font-size:0.95rem;font-weight:600}
    .report-period{display:flex;gap:10px;margin-bottom:16px}
    .report-period-btn{flex:1;padding:14px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius-md);color:var(--text-secondary);font-family:inherit;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s}
    .report-period-btn:active{transform:scale(0.97)}
    .report-period-btn.selected{border-color:var(--accent-calm);background:rgba(126,184,218,0.1);color:var(--text-primary)}
    .report-download-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1.05rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:24px}
    .report-download-btn:active{transform:scale(0.98)}
    .generate-report-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent-soft),var(--accent-calm));color:var(--bg-deep);border:none;border-radius:var(--radius-lg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:10px}
  </style>
</head>
<body>
  <div class="app">
    <div class="screen active" id="homeScreen">
      <div class="home-screen">
        <p class="home-greeting" id="greeting">Ciao</p>
        <h1 class="home-question">Come stai<br>in questo momento?</h1>
        <button class="home-main-btn" onclick="startFlow()">
          <span class="icon">üí≠</span>
          <span>Ho bisogno<br>di aiuto</span>
        </button>
        <div class="home-actions">
          <button class="home-action-btn" onclick="showScreen('diaryScreen')">
            <span>üìù</span><span>Scrivi nel diario</span>
          </button>
        </div>
        <div class="home-secondary">
          <button class="home-sec-btn" onclick="showScreen('learnScreen')">üí° Impara</button>
          <button class="home-sec-btn" onclick="showScreen('insightsScreen')">üìä Pattern</button>
          <button class="home-sec-btn" onclick="showScreen('historyScreen')">üìã Storico</button>
        </div>
      </div>
    </div>
    <div class="screen" id="feelingScreen">
      <div class="flow-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="flow-progress"><div class="flow-progress-fill" style="width:33%"></div></div>
        <span class="flow-step">1/3</span>
      </div>
      <h2 class="flow-question">Come ti senti?</h2>
      <p class="flow-subtitle">Scegli quello che descrive meglio questo momento</p>
      <div class="options-grid" id="feelingsGrid"></div>
      <div class="intensity-section" id="intensitySection" style="display:none">
        <div class="intensity-label"><span>Quanto √® forte?</span><span class="intensity-value" id="intensityValue">3</span></div>
        <div class="intensity-bar">
          <div class="intensity-dot" onclick="setIntensity(1)">1</div>
          <div class="intensity-dot" onclick="setIntensity(2)">2</div>
          <div class="intensity-dot selected" onclick="setIntensity(3)">3</div>
          <div class="intensity-dot" onclick="setIntensity(4)">4</div>
          <div class="intensity-dot" onclick="setIntensity(5)">5</div>
        </div>
      </div>
      <button class="continue-btn" id="feelingContinue" onclick="goToTrigger()">Continua ‚Üí</button>
    </div>
    <div class="screen" id="triggerScreen">
      <div class="flow-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="flow-progress"><div class="flow-progress-fill" style="width:66%"></div></div>
        <span class="flow-step">2/3</span>
      </div>
      <h2 class="flow-question">Cosa stava succedendo?</h2>
      <p class="flow-subtitle">Cosa ha scatenato questa sensazione?</p>
      <div class="triggers-list" id="triggersList"></div>
      <div class="notes-section">
        <p class="notes-label">Vuoi aggiungere qualcosa? (opzionale)</p>
        <textarea class="notes-input" id="notesInput" placeholder="Descrivi la situazione..."></textarea>
      </div>
      <button class="continue-btn" id="triggerContinue" onclick="generateResponse()">Dammi una mano ‚Üí</button>
    </div>
    <div class="screen" id="responseScreen">
      <button class="close-btn" onclick="finishAndGoHome()">√ó</button>
      <div class="response-screen">
        <div class="response-header">
          <div class="response-emoji" id="responseEmoji">ü§ó</div>
          <h2 class="response-title">Capisco, ti senti <span class="response-feeling" id="responseFeelingText">bloccato</span></h2>
        </div>
        <div class="understanding-card">
          <div class="understanding-title">üí° Cosa sta succedendo</div>
          <p class="understanding-text" id="understandingText"></p>
        </div>
        <div class="guided-actions">
          <h3 class="guided-actions-title">‚ö° Prova subito</h3>
          <div id="guidedActionsList"></div>
        </div>
        <div class="strategies-section">
          <h3 class="strategies-title">üõ†Ô∏è Altre strategie</h3>
          <div id="strategiesList"></div>
        </div>
        <div class="feedback-section">
          <p class="feedback-question">Ti √® stato utile?</p>
          <div class="feedback-btns">
            <button class="feedback-btn positive" onclick="giveFeedback(true)">üëç S√¨</button>
            <button class="feedback-btn negative" onclick="giveFeedback(false)">üëé No</button>
          </div>
        </div>
      </div>
    </div>
    <div class="screen" id="timerScreen">
      <button class="close-btn" onclick="stopTimer();showScreen('responseScreen')">√ó</button>
      <div class="timer-screen">
        <h2 class="timer-title">‚è±Ô∏è Regola dei 2 minuti</h2>
        <p class="timer-subtitle">Inizia qualsiasi cosa per soli 2 minuti. Spesso basta per sbloccarsi.</p>
        <div class="timer-circle">
          <svg width="200" height="200">
            <circle class="bg" cx="100" cy="100" r="90"/>
            <circle class="progress" id="timerProgress" cx="100" cy="100" r="90" stroke-dasharray="565.48" stroke-dashoffset="0"/>
          </svg>
          <div class="timer-display" id="timerDisplay">2:00</div>
        </div>
        <div class="timer-controls" id="timerControls">
          <button class="timer-btn primary" id="timerStartBtn" onclick="startTimer()">Inizia</button>
          <button class="timer-btn secondary" onclick="stopTimer();showScreen('responseScreen')">Annulla</button>
        </div>
        <div class="timer-done" id="timerDone">
          <div class="timer-done-emoji">üéâ</div>
          <div class="timer-done-text">Ce l'hai fatta!</div>
          <button class="timer-btn primary" onclick="resetTimer()">Altri 2 minuti</button>
          <button class="timer-btn secondary" onclick="showScreen('responseScreen')">Ho finito</button>
        </div>
      </div>
    </div>
    <div class="screen" id="breatheScreen">
      <button class="close-btn" onclick="stopBreathing();showScreen('responseScreen')">√ó</button>
      <div class="breathe-screen">
        <h2 class="breathe-title">üå¨Ô∏è Respira con me</h2>
        <p class="breathe-subtitle">Segui il ritmo. 4 secondi inspira, 4 secondi espira.</p>
        <div class="breathe-circle" id="breatheCircle">
          <span class="breathe-instruction" id="breatheInstruction">Pronto?</span>
        </div>
        <div class="breathe-counter" id="breatheCounter">5 cicli</div>
        <div class="breathe-controls">
          <button class="timer-btn primary" id="breatheStartBtn" onclick="startBreathing()">Inizia</button>
          <button class="timer-btn secondary" onclick="stopBreathing();showScreen('responseScreen')">Chiudi</button>
        </div>
      </div>
    </div>
    <div class="screen" id="dumpScreen">
      <div class="dump-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="dump-header">
          <div class="dump-emoji">üß†</div>
          <h2 class="dump-title">Svuota la mente</h2>
          <p class="dump-subtitle">Scrivi tutto quello che hai in testa. Non deve essere ordinato o sensato.</p>
        </div>
        <textarea class="dump-textarea" id="dumpTextarea" placeholder="Scrivi tutto..."></textarea>
        <div class="dump-tip">üí° Una volta fuori dalla testa, i pensieri pesano meno.</div>
      </div>
      <div class="dump-actions">
        <button class="btn secondary" onclick="showScreen('responseScreen')">Chiudi</button>
        <button class="btn primary" onclick="saveDump()">Fatto ‚úì</button>
      </div>
    </div>
    <div class="screen" id="groundScreen">
      <div class="ground-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('responseScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="ground-header">
          <div class="ground-emoji">üåø</div>
          <h2 class="ground-title">Torna al presente</h2>
          <p class="ground-subtitle">Tecnica 5-4-3-2-1</p>
        </div>
        <div id="groundingSteps"></div>
      </div>
    </div>
    <div class="screen" id="learnScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üí° Impara</h1>
          <p class="insights-subtitle">Comprendi il tuo ADHD</p>
        </div>
        <div id="learnContent"></div>
      </div>
    </div>
    <div class="screen" id="diaryScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-header">
          <h1 class="diary-title">üìù Diario emotivo</h1>
          <p class="diary-subtitle">Cattura i tuoi momenti</p>
        </div>
        <button class="diary-new-btn" onclick="showScreen('diaryNewScreen')">‚úèÔ∏è Nuova nota</button>
        <div class="diary-entries-title">Note recenti</div>
        <div id="diaryEntries"></div>
      </div>
    </div>
    <div class="screen" id="diaryNewScreen">
      <div class="diary-new-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('diaryScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-new-header">
          <h2 class="diary-new-title">Come ti senti ora?</h2>
        </div>
        <div class="diary-mood-section">
          <p class="diary-section-label">Il tuo stato d'animo</p>
          <div class="diary-mood-grid" id="diaryMoodGrid"></div>
        </div>
        <div class="diary-text-section">
          <p class="diary-section-label">Cosa vuoi annotare?</p>
          <textarea class="diary-text-input" id="diaryTextInput" placeholder="Scrivi liberamente..."></textarea>
          <div class="diary-prompts">
            <button class="diary-prompt" onclick="addPrompt('Mi sento cos√¨ perch√©...')">Mi sento cos√¨ perch√©...</button>
            <button class="diary-prompt" onclick="addPrompt('Oggi ho notato che...')">Oggi ho notato...</button>
          </div>
        </div>
      </div>
      <button class="diary-save-btn" onclick="saveDiaryEntry()">Salva nota</button>
    </div>
    <div class="screen" id="diaryDetailScreen">
      <div class="diary-detail-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('diaryScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-detail-header" id="diaryDetailHeader"></div>
        <div class="diary-detail-content">
          <p class="diary-detail-text" id="diaryDetailText"></p>
        </div>
        <button class="diary-delete-btn" onclick="deleteDiaryEntry()">üóëÔ∏è Elimina nota</button>
      </div>
    </div>
    <div class="screen" id="insightsScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üìä I tuoi pattern</h1>
          <p class="insights-subtitle">Cosa abbiamo imparato insieme</p>
        </div>
        <div id="insightsContent"></div>
      </div>
    </div>
    <div class="screen" id="historyScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="diary-header">
          <h1 class="diary-title">üìã Storico</h1>
        </div>
        <div id="historyContent"></div>
      </div>
    </div>
    <div class="screen" id="reportScreen">
      <div class="diary-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('insightsScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>
        <div class="insights-header">
          <h1 class="insights-title">üìÑ Report per terapista</h1>
          <p class="insights-subtitle">Configura e scarica il report</p>
        </div>
        <div class="report-option">
          <label class="report-option-label">Periodo</label>
          <div class="report-period">
            <button class="report-period-btn selected" onclick="selectReportPeriod(7)">7 giorni</button>
            <button class="report-period-btn" onclick="selectReportPeriod(30)">30 giorni</button>
            <button class="report-period-btn" onclick="selectReportPeriod(0)">Tutto</button>
          </div>
        </div>
        <div class="report-option">
          <label class="report-option-label">Contenuti da includere</label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludePatterns')">
            <input type="checkbox" id="reportIncludePatterns" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Pattern emotivi e trigger</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeHistory')">
            <input type="checkbox" id="reportIncludeHistory" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Storico momenti difficili</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeDiary')">
            <input type="checkbox" id="reportIncludeDiary" onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Note dal diario</span>
          </label>
          <label class="report-checkbox" onclick="toggleCheckbox('reportIncludeStrategies')">
            <input type="checkbox" id="reportIncludeStrategies" checked onclick="event.stopPropagation()">
            <span class="report-checkbox-label">Strategie utilizzate</span>
          </label>
        </div>
        <button class="report-download-btn" onclick="generatePDFReport()">
          <span>üì•</span>
          <span>Scarica PDF</span>
        </button>
      </div>
    </div>
    <div class="toast" id="toast"></div>
  </div>
<script>
const feelings=[{id:'blocked',emoji:'üò∂',label:'Bloccato'},{id:'frustrated',emoji:'üò§',label:'Frustrato'},{id:'overwhelmed',emoji:'üåÄ',label:'Sovraccarico'},{id:'down',emoji:'üòî',label:'Gi√π'},{id:'anxious',emoji:'üò∞',label:'Ansioso'},{id:'drained',emoji:'ü•±',label:'Svuotato'},{id:'scattered',emoji:'üå™Ô∏è',label:'Disperso'},{id:'restless',emoji:'‚ö°',label:'Irrequieto'},{id:'hyperfocus',emoji:'üéØ',label:'Iperfocus'},{id:'shame',emoji:'üòû',label:'In colpa'}];
const triggers=[{id:'big_task',emoji:'üìã',label:'Devo iniziare un compito importante'},{id:'too_many',emoji:'üóÇÔ∏è',label:'Troppe cose, non so da dove partire'},{id:'criticized',emoji:'üí¨',label:'Mi hanno criticato'},{id:'mistake',emoji:'‚ùå',label:'Ho fatto un errore'},{id:'distracted',emoji:'üì±',label:'Mi sono distratto'},{id:'deadline',emoji:'‚è∞',label:'Scadenza vicina'},{id:'conflict',emoji:'üí¢',label:'Conflitto con qualcuno'},{id:'tired',emoji:'üò¥',label:'Stanchezza fisica'},{id:'unknown',emoji:'‚ùì',label:'Non so, √® arrivato cos√¨'},{id:'boring_task',emoji:'üòë',label:'Compito noioso ma necessario'},{id:'transition',emoji:'üîÑ',label:'Devo cambiare attivit√†'},{id:'social_event',emoji:'üë•',label:'Evento sociale imminente'},{id:'interruption',emoji:'üîî',label:'Sono stato interrotto'},{id:'waiting',emoji:'‚è≥',label:'Devo aspettare qualcosa'},{id:'decision',emoji:'ü§î',label:'Devo prendere una decisione'},{id:'noise',emoji:'üîä',label:'Troppo rumore/stimoli'},{id:'routine_break',emoji:'üíî',label:'La mia routine √® saltata'}];
const diaryMoods=[{id:'great',emoji:'üòä',label:'Bene'},{id:'okay',emoji:'üòê',label:'Cos√¨ cos√¨'},{id:'low',emoji:'üòî',label:'Gi√π'},{id:'anxious',emoji:'üò∞',label:'Ansioso'},{id:'angry',emoji:'üò§',label:'Irritato'}];
const guidedActions=[{id:'timer',icon:'‚è±Ô∏è',name:'Timer 2 minuti',desc:'Inizia per soli 2 minuti',screen:'timerScreen'},{id:'breathe',icon:'üå¨Ô∏è',name:'Respira con me',desc:'5 cicli di respirazione',screen:'breatheScreen'},{id:'dump',icon:'üß†',name:'Svuota la mente',desc:'Scrivi tutto senza filtri',screen:'dumpScreen'},{id:'ground',icon:'üåø',name:'Torna al presente',desc:'Tecnica 5-4-3-2-1',screen:'groundScreen'}];
const groundingSteps=[{num:5,sense:'VEDI',desc:'5 cose che vedi',placeholders:['lampada','muro','telefono','finestra','mano']},{num:4,sense:'TOCCA',desc:'4 cose che tocchi',placeholders:['tavolo','tessuto','sedia','pelle']},{num:3,sense:'SENTI',desc:'3 cose che senti',placeholders:['respiro','traffico','musica']},{num:2,sense:'ANNUSA',desc:'2 cose che annusi',placeholders:['aria','caff√®']},{num:1,sense:'GUSTA',desc:'1 cosa che gusti',placeholders:['saliva']}];
const learnTopics=[
  {emoji:'üß†',title:'Cos\'√® l\'ADHD',content:'L\'ADHD √® una <strong>differenza neurologica</strong> che influenza attenzione, impulsi e regolazione emotiva. Non √® pigrizia o mancanza di volont√†. Il tuo cervello funziona in modo diverso.',context:'generale'},
  {emoji:'‚ö°',title:'Deficit di dopamina',content:'Il cervello ADHD produce <strong>meno dopamina</strong>. Per questo cerchi stimoli forti, ti annoi facilmente e hai bisogno di "urgenza" per attivarti.',context:'generale'},
  {emoji:'üéØ',title:'Iperfocus',content:'L\'iperfocus √® quando sei <strong>totalmente assorbito</strong> in un\'attivit√† interessante. √à un superpotere ADHD, ma pu√≤ farti perdere tempo su cose non prioritarie.',context:'lavoro'},
  {emoji:'üíî',title:'RSD - Sensibilit√† al rifiuto',content:'La <strong>Rejection Sensitive Dysphoria</strong> √® quando una critica o un rifiuto ti colpisce 10 volte pi√π forte. √à parte dell\'ADHD, non debolezza.',context:'sociale'},
  {emoji:'‚è∞',title:'Cecit√† temporale',content:'Il cervello ADHD non percepisce il tempo come gli altri. Ci sono solo <strong>"adesso" e "non adesso"</strong>. Per questo le scadenze lontane non ti motivano.',context:'lavoro'},
  {emoji:'üåÄ',title:'Paralisi da analisi',content:'Troppe opzioni causano <strong>blocco decisionale</strong>. Il cervello ADHD va in overload. Soluzione: riduci le scelte drasticamente.',context:'studio'},
  {emoji:'üîã',title:'Energy management',content:'Con ADHD l\'energia mentale √® <strong>limitata</strong>. Ogni decisione, cambio compito o stimolo la consuma. Gestisci l\'energia, non solo il tempo.',context:'lavoro'},
  {emoji:'üì±',title:'Distraibilit√†',content:'Non √® che "non ti concentri". Il tuo cervello <strong>si concentra su tutto</strong> contemporaneamente. Servono barriere esterne (timer, ambiente, body doubling).',context:'studio'},
  {emoji:'üé≤',title:'Ricerca di novit√†',content:'Il cervello ADHD <strong>ama il nuovo</strong>. Per questo inizi mille progetti. Non √® mancanza di impegno, √® bisogno di stimoli freschi.',context:'generale'},
  {emoji:'üõ°Ô∏è',title:'Strategie vs Forza di volont√†',content:'La forza di volont√† non basta con ADHD. Servono <strong>sistemi esterni</strong>: timer, checklist, body doubling, environment design.',context:'lavoro'},
  {emoji:'üò¥',title:'Paradosso stanco/agitato',content:'Con ADHD puoi essere <strong>esausto ma irrequieto</strong>. Il corpo √® stanco, il cervello √® agitato. Servono tecniche di grounding e quiet time.',context:'generale'},
  {emoji:'üîÑ',title:'Task switching',content:'Cambiare attivit√† <strong>costa molto</strong> al cervello ADHD. Serve un rituale di chiusura e uno di apertura per ogni transizione.',context:'lavoro'},
  {emoji:'üíä',title:'Medication & tools',content:'I farmaci possono aiutare, ma non sono magici. Funzionano meglio <strong>insieme a strategie</strong> comportamentali e sistemi di supporto.',context:'generale'},
  {emoji:'üé≠',title:'Masking',content:'Nascondere l\'ADHD per sembrare "normale" consuma <strong>energia immensa</strong>. Va bene mostrare chi sei. L\'ADHD non √® difetto.',context:'sociale'},
  {emoji:'‚úÖ',title:'Sistemi che funzionano',content:'<strong>Timer visivi, body doubling, gamification, chunking, external accountability</strong>. Non cambiare te stesso, cambia l\'ambiente.',context:'studio'}
];
const contextStrategies={
  lavoro:[
    {name:'Pomodoro modificato',desc:'25 min lavoro, 5 min break. Ma puoi accorciare a 15-3 se serve. L\'importante √® il ritmo.'},
    {name:'Body doubling virtuale',desc:'Lavora in videocall con qualcuno, anche in silenzio. La presenza aiuta.'},
    {name:'Un compito alla volta',desc:'Chiudi tutte le tab. Un file. Un compito. Finito quello, prossimo.'},
    {name:'Deadline artificiali',desc:'Crea urgenza falsa. "Devo finire entro le 15:00" anche se la vera deadline √® domani.'}
  ],
  studio:[
    {name:'Chunk down',desc:'Spezza tutto in pezzi da 10-15 minuti. Studia un pezzo, break, prossimo.'},
    {name:'Active recall',desc:'Non rileggere. Chiudi il libro e ripeti. L\'ADHD impara facendo, non guardando.'},
    {name:'Cambia location',desc:'Studia in posti diversi. Il cervello ADHD ama la novit√†.'},
    {name:'Insegna a qualcuno',desc:'Spiega ad alta voce. Anche a un pupazzo. L\'output attivo fissa la memoria.'}
  ],
  sociale:[
    {name:'Prepara frasi',desc:'3 frasi pronte per iniziare conversazioni. Toglie il carico mentale dell\'improvvisazione.'},
    {name:'Time-box sociale',desc:'"Resto 1 ora". Sapere che finisce aiuta. Puoi sempre restare di pi√π.'},
    {name:'Safe word',desc:'Con amici fidati, una parola per dire "sono in overload" senza spiegare.'},
    {name:'Recovery time',desc:'Dopo eventi sociali, blocca tempo per ricaricare. Non √® antisociale, √® necessit√†.'}
  ]
};
const responses={
  'blocked_big_task':{understanding:'Quando un compito sembra grande, il cervello ADHD va in <strong>paralisi</strong>. Non √® pigrizia.',actions:['timer','dump'],strategies:[{name:'Body doubling',desc:'Lavora accanto a qualcuno.'},{name:'Versione brutta',desc:'Fai prima una versione imperfetta.'}]},
  'blocked_too_many':{understanding:'Troppe opzioni causano <strong>sovraccarico</strong>. Tutto sembra urgente.',actions:['dump','timer'],strategies:[{name:'Regola dei 3',desc:'Max 3 cose importanti oggi.'},{name:'Domanda magica',desc:'"Se potessi fare solo UNA cosa?"'}]},
  'blocked_boring_task':{understanding:'Il cervello ADHD <strong>rifiuta i compiti noiosi</strong>. Servono stimoli.',actions:['timer','dump'],strategies:[{name:'Gamification',desc:'Crea una sfida: "quanto veloce?"'},{name:'Ricompensa dopo',desc:'Cosa fai DOPO averlo finito?'}]},
  'blocked_transition':{understanding:'Il <strong>task switching</strong> √® difficile per l\'ADHD.',actions:['breathe','timer'],strategies:[{name:'Ponte mentale',desc:'Finisci con un mini-win, poi stacca 2 min.'},{name:'Nuovo contesto',desc:'Cambia stanza o posizione.'}]},
  'frustrated_criticized':{understanding:'La <strong>sensibilit√† al rifiuto</strong> (RSD) √® comune con ADHD.',actions:['breathe','ground'],strategies:[{name:'Fatto vs Interpretazione',desc:'Cosa √® stato DETTO vs cosa INTERPRETO?'},{name:'Test del tempo',desc:'Tra una settimana sar√† ancora grave?'}]},
  'frustrated_mistake':{understanding:'Gli errori attivano il <strong>critico interiore</strong>.',actions:['breathe','dump'],strategies:[{name:'Zoom out',desc:'Su 100 cose, quante vanno bene?'},{name:'Ripara e vai',desc:'Puoi rimediare? Fallo. Altrimenti lascia andare.'}]},
  'frustrated_distracted':{understanding:'La distrazione <strong>non √® mancanza di volont√†</strong>. √à il cervello ADHD.',actions:['dump','ground'],strategies:[{name:'Reset ambientale',desc:'Togli stimoli non necessari ora.'},{name:'Compassione',desc:'Accade. Riparti senza giudizio.'}]},
  'frustrated_interruption':{understanding:'Le interruzioni <strong>rompono l\'iperfocus</strong> e serve tempo per tornare.',actions:['breathe','dump'],strategies:[{name:'Buffer time',desc:'5 minuti per riconnetterti al flusso.'},{name:'Nota rapida',desc:'Scrivi dove eri prima dell\'interruzione.'}]},
  'overwhelmed_too_many':{understanding:'Il <strong>sovraccarico</strong> √® il cervello che dice "troppi input".',actions:['breathe','dump','ground'],strategies:[{name:'Triage brutale',desc:'Cosa succede se NON lo fai?'},{name:'Una cosa alla volta',desc:'Finisci UNA cosa, poi la prossima.'}]},
  'overwhelmed_noise':{understanding:'Il <strong>sovraccarico sensoriale</strong> consuma energia cognitiva.',actions:['breathe','ground'],strategies:[{name:'Riduzione stimoli',desc:'Cuffie, luce soft, spazio calmo.'},{name:'Break sensoriale',desc:'5 min in un posto tranquillo.'}]},
  'overwhelmed_decision':{understanding:'Troppe scelte causano <strong>paralisi decisionale</strong>.',actions:['dump','breathe'],strategies:[{name:'Dimezza opzioni',desc:'Elimina met√† alternative subito.'},{name:'Flip a coin',desc:'Se non decidi in 2 min, lascia al caso.'}]},
  'overwhelmed_routine_break':{understanding:'La <strong>routine d√† struttura</strong>. Perderla disorienta.',actions:['ground','breathe'],strategies:[{name:'Mini-routine',desc:'Anche solo 3 passaggi ripetibili.'},{name:'Ancora esterna',desc:'Un timer, un posto, un rituale semplice.'}]},
  'anxious_big_task':{understanding:'L\'ansia √® <strong>paura del fallimento</strong> mascherata.',actions:['breathe','timer','ground'],strategies:[{name:'Worst case',desc:'Cosa succederebbe davvero?'},{name:'Ancora al presente',desc:'Cosa devi fare ORA?'}]},
  'anxious_deadline':{understanding:'L\'ansia da scadenza √® il cervello in <strong>modalit√† allarme</strong>.',actions:['breathe','ground','timer'],strategies:[{name:'Mini-win',desc:'Fai la cosa pi√π piccola. Il progresso calma.'},{name:'Relativizza',desc:'Su scala 1-10, quanto √® grave davvero?'}]},
  'anxious_social_event':{understanding:'L\'<strong>ansia sociale</strong> √® comune con ADHD. Temi il giudizio.',actions:['breathe','ground'],strategies:[{name:'Script mentale',desc:'3 frasi pronte per rompere il ghiaccio.'},{name:'Exit strategy',desc:'Sapere che puoi andartene calma.'}]},
  'anxious_conflict':{understanding:'Il <strong>conflitto attiva RSD</strong>. Il rifiuto fa molto male.',actions:['breathe','ground','dump'],strategies:[{name:'Pausa prima',desc:'Non rispondere subito. Respira 5 volte.'},{name:'Fatti vs Paura',desc:'Cosa √® successo vs cosa temo.'}]},
  'down_criticized':{understanding:'La critica ha toccato un punto dolente.',actions:['breathe','dump'],strategies:[{name:'Contenitore vittorie',desc:'Scrivi 3 cose di cui vai fiero.'},{name:'Questo non sei tu',desc:'Un feedback √® su un\'azione, non su di te.'}]},
  'down_mistake':{understanding:'Gli errori ADHD <strong>attivano la vergogna</strong>.',actions:['dump','breathe'],strategies:[{name:'Normalizza',desc:'Con ADHD gli errori sono pi√π frequenti. OK.'},{name:'Pattern fix',desc:'Quale sistema previene questo errore?'}]},
  'down_unknown':{understanding:'A volte il <strong>down arriva senza motivo</strong>. Pu√≤ essere chimico.',actions:['ground','breathe'],strategies:[{name:'Ride the wave',desc:'Non serve spiegarlo. Passa.'},{name:'Check basics',desc:'Hai mangiato? Dormito? Bevuto?'}]},
  'drained_tired':{understanding:'Sei <strong>svuotato</strong>. L\'ADHD consuma pi√π energia.',actions:['breathe','ground'],strategies:[{name:'Permesso di fermarti',desc:'Riposare non √® pigrizia.'},{name:'Check fisico',desc:'Fame? Sete? Sonno?'}]},
  'drained_too_many':{understanding:'Il <strong>decision fatigue</strong> esaurisce l\'energia mentale.',actions:['ground','breathe'],strategies:[{name:'Modalit√† autopilota',desc:'Fai solo cose automatiche ora.'},{name:'Power nap',desc:'15-20 minuti possono resettare.'}]},
  'scattered_distracted':{understanding:'Il cervello ADHD <strong>salta tra stimoli</strong>. √à normale.',actions:['dump','ground'],strategies:[{name:'Brain dump totale',desc:'Svuota TUTTI i pensieri. Scegli uno.'},{name:'Focus su uno',desc:'Carta e penna. Un compito. Timer.'}]},
  'scattered_transition':{understanding:'Il <strong>cambio attivit√† disperde</strong> l\'attenzione.',actions:['breathe','dump'],strategies:[{name:'Chiusura rituale',desc:'Chiudi esplicitamente l\'attivit√† precedente.'},{name:'Reset fisico',desc:'Alzati, cammina, torna.'}]},
  'scattered_interruption':{understanding:'Le interruzioni <strong>frammentano il flusso</strong> mentale.',actions:['dump','timer'],strategies:[{name:'Cattura pensieri',desc:'Nota veloce di dove eri.'},{name:'Ricostruisci contesto',desc:'Rileggi ultime righe/passi fatti.'}]},
  'restless_boring_task':{understanding:'Il cervello ADHD <strong>cerca stimoli</strong>. Il noioso √® doloroso.',actions:['timer','dump'],strategies:[{name:'Stimolo extra',desc:'Musica, movimento, cambio posizione.'},{name:'Sprint brevi',desc:'10 min sprint, poi break.'}]},
  'restless_waiting':{understanding:'L\'<strong>attesa √® tortura</strong> per l\'ADHD. Serve azione.',actions:['breathe','ground'],strategies:[{name:'Micro-task',desc:'Cosa puoi fare in questo tempo morto?'},{name:'Fidget strategico',desc:'Movimento piccolo per scaricare.'}]},
  'restless_tired':{understanding:'Il <strong>paradosso ADHD</strong>: stanco ma agitato.',actions:['breathe','ground'],strategies:[{name:'Quiet stillness',desc:'Stare fermi senza dormire. Riposa la mente.'},{name:'Rilascio fisico',desc:'5 min stretching o camminata lenta.'}]},
  'hyperfocus_interruption':{understanding:'L\'<strong>iperfocus √® fragile</strong>. Romperlo causa frustrazione.',actions:['dump','breathe'],strategies:[{name:'Nota stato',desc:'Scrivi velocemente dove sei nel flusso.'},{name:'Bookmark mentale',desc:'Crea un segnalibro per tornare.'}]},
  'hyperfocus_deadline':{understanding:'L\'iperfocus pu√≤ essere <strong>sulla cosa sbagliata</strong>.',actions:['timer','dump'],strategies:[{name:'Priority check',desc:'Questa √® la cosa pi√π urgente ORA?'},{name:'Redirect gentile',desc:'Timer per chiudere, poi passa.'}]},
  'shame_distracted':{understanding:'La <strong>vergogna ADHD</strong> dice "dovrei essere diverso".',actions:['dump','breathe'],strategies:[{name:'Self-compassion',desc:'Hai ADHD. Il tuo cervello funziona cos√¨.'},{name:'Sistema, non colpa',desc:'Quale supporto esterno serve?'}]},
  'shame_mistake':{understanding:'Gli errori ADHD attivano <strong>vergogna profonda</strong>.',actions:['breathe','dump'],strategies:[{name:'Separa azione da s√©',desc:'Hai fatto un errore. Non SEI un errore.'},{name:'Repair action',desc:'Cosa puoi fare ORA per sistemare?'}]},
  'shame_criticized':{understanding:'RSD + critica = <strong>vergogna amplificata</strong>.',actions:['breathe','ground','dump'],strategies:[{name:'Fact-check RSD',desc:'La tua reazione √® 10x. Il fatto √®...?'},{name:'Chi dice cosa',desc:'Da chi viene? √à fonte affidabile?'}]},
  'default':{understanding:'Quello che senti √® <strong>valido</strong>.',actions:['breathe','ground','dump'],strategies:[{name:'Check-in fisico',desc:'Fame? Sete? Stanchezza?'},{name:'Movimento',desc:'5 minuti possono resettare il cervello.'}]}
};
let state={history:[],diary:[],patterns:{}};
let currentFlow={feeling:null,intensity:3,trigger:null,notes:''};
let screenHistory=['homeScreen'];
let timerInterval=null,timerSeconds=120;
let breatheCycles=5;
let currentGroundStep=0;
let diaryMood=null;
let currentDiaryEntry=null;
let reportPeriodDays=7;

document.addEventListener('DOMContentLoaded',()=>{loadState();setGreeting();renderFeelings();renderTriggers();renderDiaryMoods();});
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(console.error);

function loadState(){const s=localStorage.getItem('come-stai-v2');if(s)state=JSON.parse(s);}
function saveState(){localStorage.setItem('come-stai-v2',JSON.stringify(state));}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(screenHistory[screenHistory.length-1]!==id)screenHistory.push(id);if(id==='insightsScreen')renderInsights();if(id==='historyScreen')renderHistory();if(id==='diaryScreen')renderDiaryEntries();if(id==='groundScreen')initGrounding();if(id==='learnScreen')renderLearn();}
function goBack(){screenHistory.pop();const prev=screenHistory[screenHistory.length-1]||'homeScreen';document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(prev).classList.add('active');}
function setGreeting(){const h=new Date().getHours();document.getElementById('greeting').textContent=h<12?'Buongiorno':h<18?'Buon pomeriggio':'Buonasera';}
function startFlow(){currentFlow={feeling:null,intensity:3,trigger:null,notes:''};document.getElementById('intensitySection').style.display='none';document.getElementById('feelingContinue').classList.remove('show');renderFeelings();showScreen('feelingScreen');}
function renderFeelings(){document.getElementById('feelingsGrid').innerHTML=feelings.map(f=>'<div class="option-card" data-id="'+f.id+'" onclick="selectFeeling(\''+f.id+'\')"><span class="emoji">'+f.emoji+'</span><span class="label">'+f.label+'</span></div>').join('');}
function selectFeeling(id){currentFlow.feeling=id;document.querySelectorAll('#feelingsGrid .option-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===id));document.getElementById('intensitySection').style.display='block';document.getElementById('feelingContinue').classList.add('show');}
function setIntensity(v){currentFlow.intensity=v;document.getElementById('intensityValue').textContent=v;document.querySelectorAll('.intensity-dot').forEach((d,i)=>d.classList.toggle('selected',i+1===v));}
function goToTrigger(){document.getElementById('triggerContinue').classList.remove('show');renderTriggers();showScreen('triggerScreen');}
function renderTriggers(){document.getElementById('triggersList').innerHTML=triggers.map(t=>'<div class="trigger-card" data-id="'+t.id+'" onclick="selectTrigger(\''+t.id+'\')"><span class="emoji">'+t.emoji+'</span><span class="label">'+t.label+'</span></div>').join('');}
function selectTrigger(id){currentFlow.trigger=id;document.querySelectorAll('#triggersList .trigger-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===id));document.getElementById('triggerContinue').classList.add('show');}
function generateResponse(){currentFlow.notes=document.getElementById('notesInput').value;const key=currentFlow.feeling+'_'+currentFlow.trigger;const r=responses[key]||responses['default'];const f=feelings.find(x=>x.id===currentFlow.feeling);document.getElementById('responseEmoji').textContent=f.emoji;document.getElementById('responseFeelingText').textContent=f.label.toLowerCase();document.getElementById('understandingText').innerHTML=r.understanding;document.getElementById('guidedActionsList').innerHTML=r.actions.map(aid=>{const a=guidedActions.find(x=>x.id===aid);return'<div class="guided-action-card" onclick="showScreen(\''+a.screen+'\')"><div class="guided-action-icon">'+a.icon+'</div><div class="guided-action-info"><div class="guided-action-name">'+a.name+'</div><div class="guided-action-desc">'+a.desc+'</div></div><span class="guided-action-arrow">‚Üí</span></div>';}).join('');document.getElementById('strategiesList').innerHTML=r.strategies.map((s,i)=>'<div class="strategy-card'+(i===1?' secondary':'')+'"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>').join('');state.history.unshift({id:Date.now(),date:new Date().toISOString(),feeling:currentFlow.feeling,trigger:currentFlow.trigger,intensity:currentFlow.intensity,notes:currentFlow.notes});updatePatterns();saveState();showScreen('responseScreen');}
function giveFeedback(h){if(state.history.length>0)state.history[0].helpful=h;saveState();document.querySelectorAll('.feedback-btn').forEach(b=>b.classList.remove('selected'));event.target.classList.add('selected');showToast(h?'Grazie! üíö':'Grazie per il feedback');}
function finishAndGoHome(){screenHistory=['homeScreen'];showScreen('homeScreen');}
function startTimer(){document.getElementById('timerStartBtn').style.display='none';timerInterval=setInterval(()=>{timerSeconds--;updateTimerDisplay();if(timerSeconds<=0){clearInterval(timerInterval);timerDone();}},1000);}
function updateTimerDisplay(){const m=Math.floor(timerSeconds/60),s=timerSeconds%60;document.getElementById('timerDisplay').textContent=m+':'+(s<10?'0':'')+s;const offset=565.48*(1-timerSeconds/120);document.getElementById('timerProgress').style.strokeDashoffset=offset;}
function timerDone(){document.getElementById('timerControls').style.display='none';document.getElementById('timerDone').classList.add('show');showToast('üéâ 2 minuti completati!');}
function resetTimer(){timerSeconds=120;updateTimerDisplay();document.getElementById('timerDone').classList.remove('show');document.getElementById('timerControls').style.display='flex';document.getElementById('timerStartBtn').style.display='block';}
function stopTimer(){clearInterval(timerInterval);resetTimer();}
function startBreathing(){document.getElementById('breatheStartBtn').style.display='none';breatheCycles=5;runBreatheCycle();}
function runBreatheCycle(){if(breatheCycles<=0){breathingDone();return;}const c=document.getElementById('breatheCircle'),i=document.getElementById('breatheInstruction'),n=document.getElementById('breatheCounter');c.classList.add('inhale');c.classList.remove('exhale');i.textContent='Inspira...';n.textContent=breatheCycles+' cicli';setTimeout(()=>{c.classList.remove('inhale');c.classList.add('exhale');i.textContent='Espira...';setTimeout(()=>{breatheCycles--;runBreatheCycle();},4000);},4000);}
function breathingDone(){document.getElementById('breatheInstruction').textContent='Fatto! üôè';document.getElementById('breatheCounter').textContent='Come ti senti?';document.getElementById('breatheStartBtn').style.display='block';document.getElementById('breatheStartBtn').textContent='Ripeti';showToast('üå¨Ô∏è Respirazione completata');}
function stopBreathing(){breatheCycles=0;document.getElementById('breatheCircle').classList.remove('inhale','exhale');document.getElementById('breatheInstruction').textContent='Pronto?';document.getElementById('breatheCounter').textContent='5 cicli';document.getElementById('breatheStartBtn').style.display='block';document.getElementById('breatheStartBtn').textContent='Inizia';}
function saveDump(){const t=document.getElementById('dumpTextarea').value;if(t.trim()){state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:'dump',text:t,type:'dump'});saveState();showToast('üí≠ Pensieri salvati');}document.getElementById('dumpTextarea').value='';showScreen('responseScreen');}
function initGrounding(){currentGroundStep=0;renderGroundingSteps();}
function renderGroundingSteps(){document.getElementById('groundingSteps').innerHTML=groundingSteps.map((s,i)=>'<div class="ground-step'+(i===currentGroundStep?' active':'')+(i<currentGroundStep?' done':'')+'"><div class="ground-step-num">'+(i<currentGroundStep?'‚úì':s.num)+'</div><div class="ground-step-content"><div class="ground-step-title">'+s.sense+'</div><div class="ground-step-desc">'+s.desc+'</div><div class="ground-step-input"><div class="ground-input-row">'+s.placeholders.map(p=>'<input type="text" class="ground-input-item" placeholder="'+p+'">').join('')+'</div><button class="ground-next-btn" onclick="nextGroundStep()">Avanti ‚Üí</button></div></div></div>').join('');}
function nextGroundStep(){currentGroundStep++;if(currentGroundStep>=groundingSteps.length){showToast('üåø Grounding completato!');setTimeout(()=>showScreen('responseScreen'),1500);return;}renderGroundingSteps();}
function renderDiaryMoods(){document.getElementById('diaryMoodGrid').innerHTML=diaryMoods.map(m=>'<button class="diary-mood-btn" data-id="'+m.id+'" onclick="selectDiaryMood(\''+m.id+'\')"><span class="emoji">'+m.emoji+'</span><span class="label">'+m.label+'</span></button>').join('');}
function selectDiaryMood(id){diaryMood=id;document.querySelectorAll('.diary-mood-btn').forEach(b=>b.classList.toggle('selected',b.dataset.id===id));}
function addPrompt(t){const i=document.getElementById('diaryTextInput');i.value=t+' '+i.value;i.focus();}
function saveDiaryEntry(){const t=document.getElementById('diaryTextInput').value.trim();if(!t){showToast('Scrivi qualcosa');return;}state.diary.unshift({id:Date.now(),date:new Date().toISOString(),mood:diaryMood||'okay',text:t,type:'entry'});saveState();document.getElementById('diaryTextInput').value='';diaryMood=null;document.querySelectorAll('.diary-mood-btn').forEach(b=>b.classList.remove('selected'));showToast('üìù Nota salvata');showScreen('diaryScreen');}
function renderDiaryEntries(){const c=document.getElementById('diaryEntries');const e=state.diary.filter(x=>x.type==='entry'||x.type==='dump');if(e.length===0){c.innerHTML='<div class="empty-state"><div class="emoji">üìù</div><h3>Nessuna nota</h3><p>Inizia a scrivere</p></div>';return;}c.innerHTML=e.slice(0,20).map(x=>{const m=diaryMoods.find(d=>d.id===x.mood)||{emoji:'üí≠'};const d=new Date(x.date);return'<div class="diary-entry" onclick="openDiaryEntry('+x.id+')"><div class="diary-entry-header"><span class="diary-entry-emoji">'+m.emoji+'</span><div class="diary-entry-meta"><div class="diary-entry-date">'+formatDate(d)+'</div><div class="diary-entry-time">'+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})+'</div></div></div><p class="diary-entry-text">'+x.text+'</p></div>';}).join('');}
function openDiaryEntry(id){currentDiaryEntry=state.diary.find(x=>x.id===id);if(!currentDiaryEntry)return;const m=diaryMoods.find(x=>x.id===currentDiaryEntry.mood)||{emoji:'üí≠'};const d=new Date(currentDiaryEntry.date);document.getElementById('diaryDetailHeader').innerHTML='<div class="diary-detail-emoji">'+m.emoji+'</div><div class="diary-detail-date">'+formatDate(d)+'</div><div class="diary-detail-time">'+d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})+'</div>';document.getElementById('diaryDetailText').textContent=currentDiaryEntry.text;showScreen('diaryDetailScreen');}
function deleteDiaryEntry(){if(!currentDiaryEntry)return;if(confirm('Eliminare?')){state.diary=state.diary.filter(x=>x.id!==currentDiaryEntry.id);saveState();showToast('Eliminata');showScreen('diaryScreen');}}
function updatePatterns(){const e=state.history[0];if(!e)return;if(!state.patterns.feelings)state.patterns.feelings={};if(!state.patterns.triggers)state.patterns.triggers={};if(!state.patterns.times)state.patterns.times={};state.patterns.feelings[e.feeling]=(state.patterns.feelings[e.feeling]||0)+1;state.patterns.triggers[e.trigger]=(state.patterns.triggers[e.trigger]||0)+1;const h=new Date(e.date).getHours();const t=h<12?'mattina':h<18?'pomeriggio':'sera';state.patterns.times[t]=(state.patterns.times[t]||0)+1;}
function renderInsights(){const c=document.getElementById('insightsContent');let h='<button class="generate-report-btn" onclick="showScreen(\'reportScreen\')"><span>üìÑ</span><span>Genera report per terapista</span></button>';if(state.history.length<3){c.innerHTML=h+'<div class="empty-state"><div class="emoji">üìä</div><h3>Non ho abbastanza dati</h3><p>Usa l\'app qualche volta</p></div>';return;}if(state.patterns.feelings){const t=Object.entries(state.patterns.feelings).sort((a,b)=>b[1]-a[1])[0];if(t){const f=feelings.find(x=>x.id===t[0]);h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+f.emoji+'</span><span class="insight-card-title">Emozione pi√π frequente</span></div><p class="insight-card-content">Ti senti <span class="insight-highlight">'+f.label.toLowerCase()+'</span> pi√π spesso ('+t[1]+' volte).</p></div>';}}if(state.patterns.triggers){const t=Object.entries(state.patterns.triggers).sort((a,b)=>b[1]-a[1])[0];if(t){const tr=triggers.find(x=>x.id===t[0]);h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+tr.emoji+'</span><span class="insight-card-title">Trigger pi√π comune</span></div><p class="insight-card-content">"<span class="insight-highlight">'+tr.label+'</span>" ti mette in difficolt√† pi√π spesso.</p></div>';}}if(state.patterns.times){const t=Object.entries(state.patterns.times).sort((a,b)=>b[1]-a[1])[0];if(t&&t[1]>=2)h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">üïê</span><span class="insight-card-title">Momento critico</span></div><p class="insight-card-content">I momenti difficili arrivano pi√π spesso <span class="insight-highlight">di '+t[0]+'</span>.</p></div>';}if(state.diary.length>0)h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">üìù</span><span class="insight-card-title">Il tuo diario</span></div><p class="insight-card-content">Hai scritto <span class="insight-highlight">'+state.diary.length+' note</span>.</p></div>';c.innerHTML=h||'<div class="empty-state"><div class="emoji">üîç</div><h3>Pochi dati</h3></div>';}
function renderHistory(){const c=document.getElementById('historyContent');if(state.history.length===0){c.innerHTML='<div class="empty-state"><div class="emoji">üìã</div><h3>Nessun momento</h3></div>';return;}c.innerHTML=state.history.slice(0,20).map(e=>{const f=feelings.find(x=>x.id===e.feeling)||{emoji:'üò∂'};const tr=triggers.find(x=>x.id===e.trigger)||{label:''};const d=new Date(e.date);return'<div class="diary-entry"><div class="diary-entry-header"><span class="diary-entry-emoji">'+f.emoji+'</span><div class="diary-entry-meta"><div class="diary-entry-date">'+formatDate(d)+'</div><div class="diary-entry-time">'+tr.label+'</div></div><div class="diary-entry-intensity">'+ [1,2,3,4,5].map(i=>'<div class="diary-intensity-dot'+(i<=e.intensity?' filled':'')+'"></div>').join('')+'</div></div></div>';}).join('');}
function formatDate(d){const n=new Date(),diff=n-d,days=Math.floor(diff/(1000*60*60*24));if(days===0){const h=Math.floor(diff/(1000*60*60));return h===0?'Ora':h+' ore fa';}if(days===1)return'Ieri';if(days<7)return days+' giorni fa';return d.toLocaleDateString('it-IT',{day:'numeric',month:'short'});}
function renderLearn(){const c=document.getElementById('learnContent');let h='<div class="diary-entries-title">Concetti chiave</div>';learnTopics.forEach(t=>{h+='<div class="insight-card"><div class="insight-card-header"><span class="insight-card-emoji">'+t.emoji+'</span><span class="insight-card-title">'+t.title+'</span></div><p class="insight-card-content">'+t.content+'</p></div>';});h+='<div class="diary-entries-title" style="margin-top:24px">Strategie per contesto</div>';h+='<div class="understanding-card"><div class="understanding-title">üíº LAVORO</div>';contextStrategies.lavoro.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';h+='<div class="understanding-card" style="margin-top:12px"><div class="understanding-title">üìö STUDIO</div>';contextStrategies.studio.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';h+='<div class="understanding-card" style="margin-top:12px"><div class="understanding-title">üë• SOCIALE</div>';contextStrategies.sociale.forEach(s=>{h+='<div class="strategy-card" style="margin-top:10px"><div class="strategy-name">'+s.name+'</div><div class="strategy-desc">'+s.desc+'</div></div>';});h+='</div>';c.innerHTML=h;}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function toggleCheckbox(id){const checkbox=document.getElementById(id);checkbox.checked=!checkbox.checked;checkbox.parentElement.classList.toggle('checked',checkbox.checked);}
function selectReportPeriod(days){reportPeriodDays=days;document.querySelectorAll('.report-period-btn').forEach(b=>b.classList.remove('selected'));event.target.classList.add('selected');}
function filterDataByPeriod(data){if(reportPeriodDays===0)return data;const cutoff=new Date();cutoff.setDate(cutoff.getDate()-reportPeriodDays);return data.filter(item=>new Date(item.date)>=cutoff);}
function generatePDFReport(){const{jsPDF}=window.jspdf;const doc=new jsPDF();const includePatterns=document.getElementById('reportIncludePatterns').checked;const includeHistory=document.getElementById('reportIncludeHistory').checked;const includeDiary=document.getElementById('reportIncludeDiary').checked;const includeStrategies=document.getElementById('reportIncludeStrategies').checked;let y=20;doc.setFontSize(18);doc.text('Report ADHD - Come Stai?',20,y);y+=10;doc.setFontSize(10);const today=new Date().toLocaleDateString('it-IT');const periodText=reportPeriodDays===0?'Tutto lo storico':reportPeriodDays===7?'Ultimi 7 giorni':'Ultimi 30 giorni';doc.text('Data: '+today,20,y);y+=6;doc.text('Periodo: '+periodText,20,y);y+=15;const filteredHistory=filterDataByPeriod(state.history);const filteredDiary=filterDataByPeriod(state.diary);if(includePatterns&&filteredHistory.length>0){doc.setFontSize(14);doc.text('Pattern Emotivi',20,y);y+=8;doc.setFontSize(10);const feelingCounts={};const triggerCounts={};filteredHistory.forEach(e=>{feelingCounts[e.feeling]=(feelingCounts[e.feeling]||0)+1;triggerCounts[e.trigger]=(triggerCounts[e.trigger]||0)+1;});const topFeeling=Object.entries(feelingCounts).sort((a,b)=>b[1]-a[1])[0];if(topFeeling){const f=feelings.find(x=>x.id===topFeeling[0]);doc.text('Emozione piu frequente: '+f.label+' ('+topFeeling[1]+' volte)',25,y);y+=6;}const topTrigger=Object.entries(triggerCounts).sort((a,b)=>b[1]-a[1])[0];if(topTrigger){const tr=triggers.find(x=>x.id===topTrigger[0]);doc.text('Trigger piu comune: '+tr.label+' ('+topTrigger[1]+' volte)',25,y);y+=6;}const avgIntensity=(filteredHistory.reduce((sum,e)=>sum+e.intensity,0)/filteredHistory.length).toFixed(1);doc.text('Intensita media: '+avgIntensity+'/5',25,y);y+=10;}if(includeHistory&&filteredHistory.length>0){doc.setFontSize(14);doc.text('Storico Momenti Difficili',20,y);y+=8;doc.setFontSize(9);filteredHistory.slice(0,10).forEach(e=>{if(y>270){doc.addPage();y=20;}const f=feelings.find(x=>x.id===e.feeling)||{label:'Sconosciuto'};const tr=triggers.find(x=>x.id===e.trigger)||{label:'Sconosciuto'};const d=new Date(e.date).toLocaleDateString('it-IT');doc.text(d+' - '+f.label+' ('+e.intensity+'/5) - '+tr.label,25,y);y+=5;});y+=8;}if(includeDiary&&filteredDiary.length>0){if(y>250){doc.addPage();y=20;}doc.setFontSize(14);doc.text('Note dal Diario',20,y);y+=8;doc.setFontSize(9);filteredDiary.slice(0,5).forEach(entry=>{if(y>260){doc.addPage();y=20;}const d=new Date(entry.date).toLocaleDateString('it-IT');doc.text(d+':',25,y);y+=5;const lines=doc.splitTextToSize(entry.text,160);lines.slice(0,3).forEach(line=>{if(y>270){doc.addPage();y=20;}doc.text(line,25,y);y+=5;});y+=3;});}if(includeStrategies){if(y>220){doc.addPage();y=20;}doc.setFontSize(14);doc.text('Strategie Consigliate',20,y);y+=8;doc.setFontSize(9);doc.text('Lavoro:',25,y);y+=5;contextStrategies.lavoro.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}doc.text('- '+s.name+': '+s.desc,30,y);y+=5;});y+=3;doc.text('Studio:',25,y);y+=5;contextStrategies.studio.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}doc.text('- '+s.name+': '+s.desc,30,y);y+=5;});y+=3;doc.text('Sociale:',25,y);y+=5;contextStrategies.sociale.slice(0,2).forEach(s=>{if(y>270){doc.addPage();y=20;}doc.text('- '+s.name+': '+s.desc,30,y);y+=5;});}const filename='report-adhd-'+today.replace(/\//g,'-')+'.pdf';doc.save(filename);showScreen('insightsScreen');showToast('üìÑ Report scaricato!');}
</script>
</body>
</html>
