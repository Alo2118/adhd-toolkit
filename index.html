<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Come Stai?">
  <meta name="description" content="Il tuo supporto per i momenti difficili">
  
  <title>Come Stai?</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-deep: #1a1a2e;
      --bg-card: #25253d;
      --bg-elevated: #2d2d4a;
      --bg-input: #1f1f35;
      
      --accent-calm: #7eb8da;
      --accent-warm: #e8a87c;
      --accent-soft: #c3aed6;
      --accent-green: #7dd3a8;
      --accent-coral: #e07a7a;
      
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b8;
      --text-muted: #6a6a82;
      
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-full: 100px;
      
      --safe-top: env(safe-area-inset-top, 20px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Nunito', -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    /* Screens */
    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .screen.active {
      display: flex;
    }

    /* Home Screen */
    .home-screen {
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px 30px;
    }

    .home-greeting {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .home-question {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 40px;
      line-height: 1.2;
    }

    .home-main-btn {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent-calm), var(--accent-soft));
      color: var(--bg-deep);
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 20px 60px rgba(126, 184, 218, 0.3);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .home-main-btn:active {
      transform: scale(0.95);
    }

    .home-main-btn .icon {
      font-size: 2.5rem;
    }

    .home-secondary {
      margin-top: 50px;
      display: flex;
      gap: 16px;
    }

    .home-sec-btn {
      padding: 14px 24px;
      border-radius: var(--radius-full);
      border: 1px solid var(--bg-elevated);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .home-sec-btn:active {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    /* Flow Screen */
    .flow-screen {
      padding-bottom: 100px;
    }

    .flow-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 30px;
      padding-top: 10px;
    }

    .back-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .flow-progress {
      flex: 1;
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .flow-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-calm), var(--accent-soft));
      transition: width 0.4s ease;
    }

    .flow-step {
      font-size: 0.85rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .flow-question {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .flow-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: 30px;
    }

    /* Emotion/Trigger Selection */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .option-card {
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 20px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:active {
      transform: scale(0.97);
    }

    .option-card.selected {
      border-color: var(--accent-calm);
      background: rgba(126, 184, 218, 0.1);
    }

    .option-card .emoji {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }

    .option-card .label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .option-card.selected .label {
      color: var(--accent-calm);
    }

    /* Trigger list (single column) */
    .triggers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trigger-card {
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 18px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .trigger-card:active {
      transform: scale(0.98);
    }

    .trigger-card.selected {
      border-color: var(--accent-warm);
      background: rgba(232, 168, 124, 0.1);
    }

    .trigger-card .emoji {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .trigger-card .label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .trigger-card.selected .label {
      color: var(--accent-warm);
    }

    /* Intensity slider */
    .intensity-section {
      margin-top: 20px;
    }

    .intensity-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .intensity-label span {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .intensity-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    .intensity-bar {
      display: flex;
      gap: 8px;
    }

    .intensity-dot {
      flex: 1;
      height: 50px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--bg-elevated);
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--text-muted);
    }

    .intensity-dot:active {
      transform: scale(0.95);
    }

    .intensity-dot.selected {
      border-color: var(--dot-color);
      background: var(--dot-bg);
      color: var(--dot-color);
    }

    .intensity-dot:nth-child(1) { --dot-color: var(--accent-green); --dot-bg: rgba(125, 211, 168, 0.15); }
    .intensity-dot:nth-child(2) { --dot-color: var(--accent-calm); --dot-bg: rgba(126, 184, 218, 0.15); }
    .intensity-dot:nth-child(3) { --dot-color: var(--accent-warm); --dot-bg: rgba(232, 168, 124, 0.15); }
    .intensity-dot:nth-child(4) { --dot-color: var(--accent-coral); --dot-bg: rgba(224, 122, 122, 0.15); }
    .intensity-dot:nth-child(5) { --dot-color: #e05a5a; --dot-bg: rgba(224, 90, 90, 0.15); }

    /* Response Screen */
    .response-screen {
      padding: 30px 24px;
    }

    .response-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .response-emoji {
      font-size: 3.5rem;
      margin-bottom: 16px;
    }

    .response-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .response-feeling {
      color: var(--accent-calm);
      font-weight: 600;
    }

    /* Understanding section */
    .understanding-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
    }

    .understanding-title {
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-soft);
      margin-bottom: 12px;
    }

    .understanding-text {
      font-size: 1rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .understanding-text strong {
      color: var(--text-primary);
    }

    /* Strategies section */
    .strategies-section {
      margin-bottom: 24px;
    }

    .strategies-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .strategy-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-green);
    }

    .strategy-card.secondary {
      border-left-color: var(--accent-calm);
    }

    .strategy-card.tertiary {
      border-left-color: var(--accent-soft);
    }

    .strategy-name {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .strategy-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .strategy-action {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--bg-elevated);
    }

    .strategy-action-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .strategy-action-text {
      font-size: 0.95rem;
      color: var(--accent-green);
      font-weight: 600;
    }

    /* Quick action */
    .quick-action {
      background: linear-gradient(135deg, rgba(125, 211, 168, 0.15), rgba(126, 184, 218, 0.15));
      border: 1px solid rgba(125, 211, 168, 0.3);
      border-radius: var(--radius-lg);
      padding: 24px;
      text-align: center;
      margin-bottom: 24px;
    }

    .quick-action-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-green);
      margin-bottom: 10px;
    }

    .quick-action-text {
      font-size: 1.15rem;
      font-weight: 700;
      line-height: 1.4;
      margin-bottom: 16px;
    }

    .quick-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      background: var(--accent-green);
      color: var(--bg-deep);
      border: none;
      border-radius: var(--radius-full);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action-btn:active {
      transform: scale(0.97);
    }

    /* Feedback section */
    .feedback-section {
      text-align: center;
      padding: 20px 0;
      margin-top: auto;
    }

    .feedback-question {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .feedback-btns {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .feedback-btn {
      padding: 12px 24px;
      border-radius: var(--radius-full);
      border: 1px solid var(--bg-elevated);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feedback-btn:active {
      transform: scale(0.97);
    }

    .feedback-btn.positive:active,
    .feedback-btn.positive.selected {
      background: rgba(125, 211, 168, 0.15);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .feedback-btn.negative:active,
    .feedback-btn.negative.selected {
      background: rgba(224, 122, 122, 0.15);
      border-color: var(--accent-coral);
      color: var(--accent-coral);
    }

    /* Insights Screen */
    .insights-screen {
      padding: 20px;
    }

    .insights-header {
      margin-bottom: 30px;
    }

    .insights-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .insights-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .insight-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 16px;
    }

    .insight-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .insight-card-emoji {
      font-size: 1.5rem;
    }

    .insight-card-title {
      font-weight: 700;
      font-size: 1rem;
    }

    .insight-card-content {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .insight-highlight {
      color: var(--accent-calm);
      font-weight: 600;
    }

    .pattern-tag {
      display: inline-block;
      padding: 6px 14px;
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      font-size: 0.8rem;
      font-weight: 600;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* History Screen */
    .history-screen {
      padding: 20px;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .history-title {
      font-size: 1.5rem;
      font-weight: 800;
    }

    .history-item {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .history-item-emoji {
      font-size: 1.75rem;
    }

    .history-item-content {
      flex: 1;
    }

    .history-item-feeling {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .history-item-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .history-item-intensity {
      display: flex;
      gap: 3px;
    }

    .intensity-mini-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: var(--bg-elevated);
    }

    .intensity-mini-dot.filled {
      background: var(--accent-warm);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .emoji {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* Continue Button */
    .continue-btn {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 20px);
      left: 20px;
      right: 20px;
      padding: 18px;
      background: linear-gradient(135deg, var(--accent-calm), var(--accent-soft));
      color: var(--bg-deep);
      border: none;
      border-radius: var(--radius-lg);
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
      z-index: 100;
    }

    .continue-btn.show {
      display: block;
    }

    .continue-btn:active {
      transform: scale(0.98);
    }

    .continue-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-elevated);
      color: var(--text-primary);
      padding: 16px 28px;
      border-radius: var(--radius-full);
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Notes input */
    .notes-section {
      margin-top: 24px;
    }

    .notes-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .notes-input {
      width: 100%;
      padding: 16px;
      background: var(--bg-input);
      border: 2px solid var(--bg-elevated);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      resize: none;
      min-height: 100px;
      transition: border-color 0.2s;
    }

    .notes-input:focus {
      outline: none;
      border-color: var(--accent-calm);
    }

    .notes-input::placeholder {
      color: var(--text-muted);
    }

    /* Close button for response */
    .close-btn {
      position: fixed;
      top: calc(var(--safe-top) + 16px);
      right: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .animate-in {
      animation: fadeIn 0.5s ease backwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    /* Scrollbar */
    .screen::-webkit-scrollbar {
      width: 4px;
    }

    .screen::-webkit-scrollbar-track {
      background: transparent;
    }

    .screen::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    
    <!-- HOME SCREEN -->
    <div class="screen active" id="homeScreen">
      <div class="home-screen">
        <p class="home-greeting" id="greeting">Ciao</p>
        <h1 class="home-question">Come stai<br>in questo momento?</h1>
        
        <button class="home-main-btn" onclick="startFlow()">
          <span class="icon">üí≠</span>
          <span>Ho bisogno<br>di aiuto</span>
        </button>
        
        <div class="home-secondary">
          <button class="home-sec-btn" onclick="showScreen('insightsScreen')">üìä Pattern</button>
          <button class="home-sec-btn" onclick="showScreen('historyScreen')">üìù Storico</button>
        </div>
      </div>
    </div>

    <!-- FLOW: FEELING SCREEN -->
    <div class="screen" id="feelingScreen">
      <div class="flow-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="goBack()">‚Üê</button>
          <div class="flow-progress">
            <div class="flow-progress-fill" style="width: 33%"></div>
          </div>
          <span class="flow-step">1/3</span>
        </div>

        <h2 class="flow-question animate-in">Come ti senti?</h2>
        <p class="flow-subtitle animate-in delay-1">Scegli quello che descrive meglio questo momento</p>

        <div class="options-grid" id="feelingsGrid">
          <!-- Populated by JS -->
        </div>

        <div class="intensity-section" id="intensitySection" style="display:none">
          <div class="intensity-label">
            <span>Quanto √® forte questa sensazione?</span>
            <span class="intensity-value" id="intensityValue">3</span>
          </div>
          <div class="intensity-bar">
            <div class="intensity-dot" data-value="1" onclick="setIntensity(1)">1</div>
            <div class="intensity-dot" data-value="2" onclick="setIntensity(2)">2</div>
            <div class="intensity-dot selected" data-value="3" onclick="setIntensity(3)">3</div>
            <div class="intensity-dot" data-value="4" onclick="setIntensity(4)">4</div>
            <div class="intensity-dot" data-value="5" onclick="setIntensity(5)">5</div>
          </div>
        </div>
      </div>

      <button class="continue-btn" id="feelingContinue" onclick="goToTrigger()">Continua ‚Üí</button>
    </div>

    <!-- FLOW: TRIGGER SCREEN -->
    <div class="screen" id="triggerScreen">
      <div class="flow-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="goBack()">‚Üê</button>
          <div class="flow-progress">
            <div class="flow-progress-fill" style="width: 66%"></div>
          </div>
          <span class="flow-step">2/3</span>
        </div>

        <h2 class="flow-question animate-in">Cosa stava succedendo?</h2>
        <p class="flow-subtitle animate-in delay-1">Cosa pensi abbia scatenato questa sensazione?</p>

        <div class="triggers-list" id="triggersList">
          <!-- Populated by JS -->
        </div>

        <div class="notes-section animate-in delay-3">
          <p class="notes-label">Vuoi aggiungere qualcosa? (opzionale)</p>
          <textarea class="notes-input" id="notesInput" placeholder="Descrivi la situazione..."></textarea>
        </div>
      </div>

      <button class="continue-btn" id="triggerContinue" onclick="generateResponse()">Dammi una mano ‚Üí</button>
    </div>

    <!-- RESPONSE SCREEN -->
    <div class="screen" id="responseScreen">
      <button class="close-btn" onclick="finishAndGoHome()">√ó</button>
      
      <div class="response-screen">
        <div class="response-header animate-in">
          <div class="response-emoji" id="responseEmoji">ü§ó</div>
          <h2 class="response-title">Capisco, ti senti <span class="response-feeling" id="responseFeelingText">bloccato</span></h2>
        </div>

        <div class="understanding-card animate-in delay-1" id="understandingCard">
          <div class="understanding-title">üí° Cosa sta succedendo</div>
          <p class="understanding-text" id="understandingText">
            <!-- Populated by JS -->
          </p>
        </div>

        <div class="quick-action animate-in delay-2" id="quickAction">
          <div class="quick-action-label">‚ú® Prova subito</div>
          <p class="quick-action-text" id="quickActionText">
            <!-- Populated by JS -->
          </p>
          <button class="quick-action-btn" id="quickActionBtn" onclick="markQuickActionDone()">
            <span>Ce la faccio</span> üí™
          </button>
        </div>

        <div class="strategies-section animate-in delay-3">
          <h3 class="strategies-title">üõ†Ô∏è Strategie che possono aiutarti</h3>
          <div id="strategiesList">
            <!-- Populated by JS -->
          </div>
        </div>

        <div class="feedback-section animate-in delay-4">
          <p class="feedback-question">Questo ti √® stato utile?</p>
          <div class="feedback-btns">
            <button class="feedback-btn positive" onclick="giveFeedback(true)">üëç S√¨</button>
            <button class="feedback-btn negative" onclick="giveFeedback(false)">üëé No</button>
          </div>
        </div>
      </div>
    </div>

    <!-- INSIGHTS SCREEN -->
    <div class="screen" id="insightsScreen">
      <div class="insights-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>

        <div class="insights-header">
          <h1 class="insights-title">I tuoi pattern</h1>
          <p class="insights-subtitle">Cosa abbiamo imparato insieme</p>
        </div>

        <div id="insightsContent">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div class="screen" id="historyScreen">
      <div class="history-screen">
        <div class="flow-header">
          <button class="back-btn" onclick="showScreen('homeScreen')">‚Üê</button>
          <div style="flex:1"></div>
        </div>

        <div class="history-header">
          <h1 class="history-title">Storico</h1>
        </div>

        <div id="historyContent">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>
  </div>

  <script>
    // ===================== DATA =====================
    const feelings = [
      { id: 'blocked', emoji: 'üò∂', label: 'Bloccato', desc: 'Non riesco a partire' },
      { id: 'frustrated', emoji: 'üò§', label: 'Frustrato', desc: 'Tutto mi irrita' },
      { id: 'overwhelmed', emoji: 'üåÄ', label: 'Sovraccarico', desc: 'Troppe cose' },
      { id: 'down', emoji: 'üòî', label: 'Gi√π', desc: 'Non ne vale la pena' },
      { id: 'anxious', emoji: 'üò∞', label: 'Ansioso', desc: 'Paura di sbagliare' },
      { id: 'drained', emoji: 'ü•±', label: 'Svuotato', desc: 'Zero energia' }
    ];

    const triggers = [
      { id: 'big_task', emoji: 'üìã', label: 'Devo iniziare un compito importante' },
      { id: 'too_many', emoji: 'üóÇÔ∏è', label: 'Troppe cose da fare, non so da dove partire' },
      { id: 'criticized', emoji: 'üí¨', label: 'Mi hanno criticato o giudicato' },
      { id: 'mistake', emoji: '‚ùå', label: 'Ho fatto un errore' },
      { id: 'distracted', emoji: 'üì±', label: 'Mi sono distratto e ho perso tempo' },
      { id: 'deadline', emoji: '‚è∞', label: 'Ho una scadenza vicina' },
      { id: 'conflict', emoji: 'üí¢', label: 'Ho avuto un conflitto con qualcuno' },
      { id: 'bored', emoji: 'üòë', label: 'Noia profonda, niente mi stimola' },
      { id: 'tired', emoji: 'üò¥', label: 'Sono stanco fisicamente' },
      { id: 'unknown', emoji: '‚ùì', label: 'Non so, √® arrivato cos√¨' }
    ];

    // Responses database: feeling + trigger ‚Üí understanding + strategies
    const responses = {
      // BLOCKED
      'blocked_big_task': {
        understanding: 'Quando un compito sembra grande, il cervello ADHD va in <strong>paralisi da decisione</strong>. Non √® pigrizia: √® che il tuo cervello non riesce a spezzare il compito in passi gestibili e si blocca.',
        quickAction: 'Scrivi solo la PRIMA micro-azione. Non tutto il piano, solo il primo passo fisico. "Aprire il documento" o "Prendere il telefono".',
        strategies: [
          { name: 'Regola dei 2 minuti', desc: 'Prometti a te stesso solo 2 minuti. Non di finire, solo di iniziare. Spesso basta questo per sbloccarsi.', action: 'Imposta un timer per 2 minuti e inizia' },
          { name: 'Body doubling', desc: 'Lavora accanto a qualcuno (anche in videocall). La presenza di altri riduce la resistenza.', action: 'Chiama un amico o usa un video "study with me"' },
          { name: 'Rimuovi un passaggio', desc: 'Qual √® il passaggio che ti blocca di pi√π? Eliminalo o semplificalo drasticamente.', action: 'Identifica l\'ostacolo e bypassalo' }
        ]
      },
      'blocked_too_many': {
        understanding: 'Con troppe opzioni, il cervello ADHD si <strong>sovraccarica</strong>. Non sai da dove partire perch√© tutto sembra urgente e importante allo stesso tempo.',
        quickAction: 'Scegli UNA cosa sola. Non la pi√π importante, quella che riesci a fare ORA. Il resto non esiste per i prossimi 25 minuti.',
        strategies: [
          { name: 'Brain dump + 1', desc: 'Scrivi tutto quello che hai in testa su carta. Poi cerchia UNA sola cosa e ignora il resto.', action: 'Prendi carta e penna, svuota la mente' },
          { name: 'La regola dei 3', desc: 'Oggi puoi fare al massimo 3 cose importanti. Sceglile ora e lascia perdere il resto.', action: 'Scrivi le tue 3 priorit√† di oggi' },
          { name: 'Domanda magica', desc: '"Se potessi fare solo UNA cosa oggi, quale farebbe la differenza maggiore?"', action: 'Rispondi onestamente e parti da l√¨' }
        ]
      },
      'blocked_deadline': {
        understanding: 'Le scadenze vicine possono creare <strong>panico paralizzante</strong>. L\'urgenza non ti motiva, ti blocca ancora di pi√π perch√© aumenta la pressione.',
        quickAction: 'Fermati. Respira. Hai pi√π tempo di quanto pensi. Qual √® il minimo accettabile che puoi consegnare?',
        strategies: [
          { name: 'Abbassa lo standard', desc: 'Non deve essere perfetto, deve essere fatto. "Fatto" batte "perfetto" sempre.', action: 'Chiediti: qual √® il 70% accettabile?' },
          { name: 'Spezza la scadenza', desc: 'Crea 3-4 mini-scadenze da qui a quella vera. Rende tutto pi√π gestibile.', action: 'Dividi il lavoro in blocchi con orari' },
          { name: 'Comunica', desc: 'Se sei davvero in difficolt√†, meglio avvisare prima che dopo. Spesso si trova una soluzione.', action: 'Scrivi un messaggio onesto a chi aspetta' }
        ]
      },

      // FRUSTRATED
      'frustrated_criticized': {
        understanding: 'La <strong>sensibilit√† al rifiuto</strong> (RSD) √® comune con l\'ADHD. Una critica che per altri √® un feedback, per te pu√≤ sembrare un attacco personale devastante.',
        quickAction: 'Quello che senti √® reale, ma potrebbe non essere proporzionato. Aspetta 30 minuti prima di reagire.',
        strategies: [
          { name: 'Fatto vs Interpretazione', desc: 'Scrivi: cosa √® stato DETTO esattamente? Cosa sto INTERPRETANDO io? Spesso sono molto diversi.', action: 'Separa i fatti dalle tue conclusioni' },
          { name: 'Il test del tempo', desc: 'Tra una settimana questo sembrer√† ancora cos√¨ grave? Di solito no.', action: 'Immagina te stesso tra 7 giorni' },
          { name: 'Parla come a un amico', desc: 'Se un amico ricevesse questa critica, cosa gli diresti? Dillo a te stesso.', action: 'Sii gentile con te' }
        ]
      },
      'frustrated_mistake': {
        understanding: 'Gli errori attivano il <strong>critico interiore</strong> che √® spesso spietato con chi ha ADHD. Tendi a trasformare un errore in una conferma di non essere "abbastanza".',
        quickAction: 'Un errore √® un dato, non un verdetto su chi sei. Cosa puoi imparare? E poi lascia andare.',
        strategies: [
          { name: 'Zoom out', desc: 'Su 100 cose che fai, quante vanno bene? Gli errori sembrano enormi ma sono una piccola percentuale.', action: 'Elenca 3 cose che hai fatto bene oggi' },
          { name: 'Normalizza', desc: 'Tutti sbagliano. Letteralmente tutti. L\'errore ti rende umano, non incapace.', action: 'Ricorda un errore di qualcuno che ammiri' },
          { name: 'Ripara e vai avanti', desc: 'Puoi fare qualcosa per rimediare? Fallo. Non puoi? Allora lascia andare.', action: 'Decidi: riparo o rilascio?' }
        ]
      },
      'frustrated_distracted': {
        understanding: 'La frustrazione post-distrazione √® <strong>doppiamente difficile</strong>: non solo hai perso tempo, ma ora ti senti anche in colpa. √à una trappola emotiva.',
        quickAction: 'Stop. Il tempo perso √® perso. L\'unica domanda che conta: cosa faccio ADESSO nei prossimi 15 minuti?',
        strategies: [
          { name: 'Reset senza giudizio', desc: 'D√¨ "ok, √® successo" e ricomincia. La colpa non ti fa recuperare tempo.', action: 'Accetta e riparte da zero' },
          { name: 'Blocca il trigger', desc: 'Cosa ti ha distratto? Puoi toglierlo di mezzo per la prossima ora?', action: 'Metti il telefono in un\'altra stanza' },
          { name: 'Sessione breve', desc: 'Non provare a recuperare tutto. 25 minuti di focus valgono pi√π di 2 ore di senso di colpa.', action: 'Timer 25 min, una cosa sola' }
        ]
      },

      // OVERWHELMED
      'overwhelmed_too_many': {
        understanding: 'Il <strong>sovraccarico</strong> non √® debolezza: √® il tuo cervello che dice "troppi input". L\'ADHD rende difficile filtrare e prioritizzare automaticamente.',
        quickAction: 'Fermati completamente. Chiudi tutto. 5 minuti di silenzio. Il mondo pu√≤ aspettare.',
        strategies: [
          { name: 'Triage brutale', desc: 'Di tutto quello che devi fare, cosa succede se NON lo fai? Elimina tutto il possibile.', action: 'Taglia almeno 3 cose dalla lista' },
          { name: 'Una cosa alla volta', desc: 'Il multitasking √® un mito. Scegli UNA cosa. Finiscila. Poi la prossima.', action: 'Nascondi tutto tranne una cosa' },
          { name: 'Scarica su carta', desc: 'Tutto quello che hai in testa, scrivilo. Una volta fuori dalla mente, pesa meno.', action: 'Brain dump di 5 minuti' }
        ]
      },
      'overwhelmed_deadline': {
        understanding: 'Scadenza + sovraccarico = <strong>tempesta perfetta</strong>. Il panico aumenta il rumore mentale e rende ancora pi√π difficile pensare chiaramente.',
        quickAction: 'Prima: un respiro profondo. Poi: qual √® la cosa minima che devi consegnare? Fai solo quella.',
        strategies: [
          { name: 'Minimo vitale', desc: 'Non il lavoro perfetto, il lavoro minimo accettabile. Puoi migliorarlo dopo.', action: 'Definisci il "buono abbastanza"' },
          { name: 'Aiuto esterno', desc: 'Puoi chiedere aiuto? Delegare qualcosa? Chiedere una proroga?', action: 'Identifica chi pu√≤ aiutarti' },
          { name: 'Un\'ora alla volta', desc: 'Non guardare tutto. Guarda solo la prossima ora. Cosa puoi fare ORA?', action: 'Pianifica solo i prossimi 60 minuti' }
        ]
      },

      // DOWN
      'down_criticized': {
        understanding: 'La critica ha toccato un punto dolente. Spesso con l\'ADHD porti gi√† un <strong>carico di autosvalutazione</strong>, e basta poco per farlo traboccare.',
        quickAction: 'Quello che senti √® valido. Ma non √® la verit√† completa su chi sei. √à solo un momento.',
        strategies: [
          { name: 'Contenitore delle vittorie', desc: 'Hai un posto dove tieni traccia delle cose buone che fai? Se no, crealo ora.', action: 'Scrivi 3 cose di cui vai fiero' },
          { name: 'Prospettiva esterna', desc: 'Cosa direbbe qualcuno che ti vuole bene? Ascolta quella voce, non il critico.', action: 'Chiama o scrivi a quella persona' },
          { name: 'Questo non sei tu', desc: 'Un feedback negativo √® su un\'AZIONE, non sulla tua PERSONA.', action: 'Separa cosa hai fatto da chi sei' }
        ]
      },
      'down_mistake': {
        understanding: 'L\'errore ha attivato la spirale del <strong>"vedi? Non sei capace"</strong>. Questa voce mente. Gli errori non definiscono il tuo valore.',
        quickAction: 'Respira. Metti una mano sul petto. D√¨: "Ho sbagliato. Va bene. Posso riprovarci."',
        strategies: [
          { name: 'Storia completa', desc: 'Stai guardando solo l\'errore. Ma oggi cos\'altro √® successo? Cosa hai fatto bene?', action: 'Elenca il quadro completo' },
          { name: 'Self-compassion', desc: 'Parleresti cos√¨ duramente a un amico che ha sbagliato? Trattati con la stessa gentilezza.', action: 'Scrivi una frase gentile per te' },
          { name: 'Impara e rilascia', desc: 'Cosa puoi imparare da questo errore? Una volta capito, lascialo andare.', action: 'Trova una lezione e voltia pagina' }
        ]
      },

      // ANXIOUS
      'anxious_big_task': {
        understanding: 'L\'ansia davanti a un compito grande √® <strong>paura del fallimento</strong> mascherata. Il tuo cervello sta cercando di proteggerti evitando il rischio.',
        quickAction: 'L\'ansia diminuisce quando inizi. Il primo passo non deve essere perfetto, deve solo esistere.',
        strategies: [
          { name: 'Worst case scenario', desc: 'Cosa succederebbe davvero se non andasse bene? Probabilmente molto meno di quanto temi.', action: 'Scrivi il peggio che pu√≤ succedere' },
          { name: 'Versione brutta', desc: 'E se facessi prima una versione volutamente imperfetta? Puoi sempre migliorarla.', action: 'Crea una bozza "orribile" in 10 min' },
          { name: 'Ancora al presente', desc: 'L\'ansia vive nel futuro. Torna al presente: cosa devi fare ORA, in questo minuto?', action: '5 respiri profondi, poi un\'azione' }
        ]
      },
      'anxious_deadline': {
        understanding: 'L\'ansia da scadenza √® il tuo cervello in <strong>modalit√† allarme</strong>. Vuole aiutarti ma sta solo aumentando il panico.',
        quickAction: 'Fermati. 3 respiri lenti. Il panico non accelera il lavoro, lo rallenta. La calma √® produttiva.',
        strategies: [
          { name: 'Grounding', desc: 'Prima di tutto: 5 cose che vedi, 4 che tocchi, 3 che senti. Torna nel tuo corpo.', action: 'Fai l\'esercizio 5-4-3-2-1' },
          { name: 'Mini-win', desc: 'Fai la cosa pi√π piccola e veloce della lista. La sensazione di progresso calma l\'ansia.', action: 'Completa un micro-task in 5 minuti' },
          { name: 'Relativizza', desc: 'Su una scala 1-10 di "disastri della vita", quanto √® grave davvero? Di solito max 4.', action: 'Dai un voto realistico alla situazione' }
        ]
      },

      // DRAINED
      'drained_tired': {
        understanding: 'Sei <strong>svuotato</strong>. L\'ADHD consuma pi√π energia degli altri perch√© il tuo cervello lavora sempre di pi√π per le cose "normali".',
        quickAction: 'Non √® il momento di forzare. Cosa ti serve DAVVERO? Riposo? Cibo? Aria? Datti quello.',
        strategies: [
          { name: 'Permesso di fermarti', desc: 'Riposare non √® pigrizia, √® necessario. Soprattutto per te. Il riposo √® produttivo.', action: 'Datti 20 minuti di pausa vera' },
          { name: 'Ricarica fisica', desc: 'Spesso lo svuotamento mentale √® anche fisico. Hai mangiato? Bevuto acqua? Dormito?', action: 'Controlla i bisogni base' },
          { name: 'Domani esiste', desc: 'Non tutto deve essere fatto oggi. Cosa puoi rimandare a domani senza conseguenze gravi?', action: 'Sposta 2 cose a domani' }
        ]
      },
      'drained_too_many': {
        understanding: 'Hai dato troppo e ora sei <strong>in riserva</strong>. La lista infinita ha consumato le tue energie. √à normale, non √® fallimento.',
        quickAction: 'Stop. Basta per oggi. Scegli UNA cosa non negoziabile, fai quella, poi fermati.',
        strategies: [
          { name: 'Chiudi i loop', desc: 'Le cose "quasi finite" consumano energia. Finiscine una, anche piccola.', action: 'Completa una cosa al 100%' },
          { name: 'Dichiara "basta"', desc: 'D√¨ ad alta voce: "Per oggi ho fatto abbastanza." E credici.', action: 'Dillo, ad alta voce, ora' },
          { name: 'Rituali di chiusura', desc: 'Un gesto fisico che dice "la giornata lavorativa √® finita". Chiudi il laptop, cambia stanza.', action: 'Crea un confine fisico' }
        ]
      },

      // DEFAULT
      'default': {
        understanding: 'Anche se non hai identificato un trigger specifico, quello che senti √® <strong>valido</strong>. A volte il cervello ADHD si sovraccarica senza un motivo apparente.',
        quickAction: 'Prenditi 5 minuti per te. Respira. Non devi capire tutto ora. Devi solo essere gentile con te stesso.',
        strategies: [
          { name: 'Check-in fisico', desc: 'Come sta il tuo corpo? Fame? Sete? Stanchezza? A volte il disagio mentale √® fisico mascherato.', action: 'Ascolta il corpo e rispondi ai suoi bisogni' },
          { name: 'Movimento', desc: '5 minuti di movimento possono resettare il cervello. Cammina, stretching, balla.', action: 'Muoviti per 5 minuti' },
          { name: 'Parla con qualcuno', desc: 'A volte basta dire ad alta voce cosa senti per sentirsi meglio.', action: 'Chiama o scrivi a qualcuno' }
        ]
      }
    };

    // ===================== STATE =====================
    let state = {
      history: [],
      patterns: {}
    };

    let currentFlow = {
      feeling: null,
      intensity: 3,
      trigger: null,
      notes: ''
    };

    let screenHistory = ['homeScreen'];

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', () => {
      loadState();
      setGreeting();
      renderFeelings();
      renderTriggers();
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // ===================== STATE MANAGEMENT =====================
    function loadState() {
      const saved = localStorage.getItem('come-stai-data');
      if (saved) {
        state = JSON.parse(saved);
      }
    }

    function saveState() {
      localStorage.setItem('come-stai-data', JSON.stringify(state));
    }

    // ===================== NAVIGATION =====================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      
      if (screenHistory[screenHistory.length - 1] !== screenId) {
        screenHistory.push(screenId);
      }

      // Render content for specific screens
      if (screenId === 'insightsScreen') renderInsights();
      if (screenId === 'historyScreen') renderHistory();
    }

    function goBack() {
      screenHistory.pop();
      const prevScreen = screenHistory[screenHistory.length - 1] || 'homeScreen';
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(prevScreen).classList.add('active');
    }

    // ===================== HOME =====================
    function setGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Ciao';
      if (hour < 12) greeting = 'Buongiorno';
      else if (hour < 18) greeting = 'Buon pomeriggio';
      else greeting = 'Buonasera';
      document.getElementById('greeting').textContent = greeting;
    }

    // ===================== FLOW =====================
    function startFlow() {
      currentFlow = { feeling: null, intensity: 3, trigger: null, notes: '' };
      renderFeelings();
      document.getElementById('intensitySection').style.display = 'none';
      document.getElementById('feelingContinue').classList.remove('show');
      showScreen('feelingScreen');
    }

    function renderFeelings() {
      const grid = document.getElementById('feelingsGrid');
      grid.innerHTML = feelings.map((f, i) => `
        <div class="option-card animate-in delay-${Math.min(i, 4)}" data-id="${f.id}" onclick="selectFeeling('${f.id}')">
          <span class="emoji">${f.emoji}</span>
          <span class="label">${f.label}</span>
        </div>
      `).join('');
    }

    function selectFeeling(id) {
      currentFlow.feeling = id;
      
      // Update UI
      document.querySelectorAll('#feelingsGrid .option-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === id);
      });
      
      // Show intensity section
      document.getElementById('intensitySection').style.display = 'block';
      document.getElementById('feelingContinue').classList.add('show');
    }

    function setIntensity(value) {
      currentFlow.intensity = value;
      document.getElementById('intensityValue').textContent = value;
      
      document.querySelectorAll('.intensity-dot').forEach(dot => {
        dot.classList.toggle('selected', parseInt(dot.dataset.value) === value);
      });
    }

    function goToTrigger() {
      renderTriggers();
      document.getElementById('triggerContinue').classList.remove('show');
      showScreen('triggerScreen');
    }

    function renderTriggers() {
      const list = document.getElementById('triggersList');
      
      // Filter triggers based on feeling for relevance
      const relevantTriggers = triggers;
      
      list.innerHTML = relevantTriggers.map((t, i) => `
        <div class="trigger-card animate-in delay-${Math.min(i, 4)}" data-id="${t.id}" onclick="selectTrigger('${t.id}')">
          <span class="emoji">${t.emoji}</span>
          <span class="label">${t.label}</span>
        </div>
      `).join('');
    }

    function selectTrigger(id) {
      currentFlow.trigger = id;
      
      // Update UI
      document.querySelectorAll('#triggersList .trigger-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === id);
      });
      
      document.getElementById('triggerContinue').classList.add('show');
    }

    // ===================== RESPONSE =====================
    function generateResponse() {
      currentFlow.notes = document.getElementById('notesInput').value;
      
      // Find matching response
      const key = `${currentFlow.feeling}_${currentFlow.trigger}`;
      const response = responses[key] || responses['default'];
      const feeling = feelings.find(f => f.id === currentFlow.feeling);
      
      // Update response screen
      document.getElementById('responseEmoji').textContent = feeling.emoji;
      document.getElementById('responseFeelingText').textContent = feeling.label.toLowerCase();
      document.getElementById('understandingText').innerHTML = response.understanding;
      document.getElementById('quickActionText').textContent = response.quickAction;
      
      // Render strategies
      const strategiesHtml = response.strategies.map((s, i) => `
        <div class="strategy-card ${i === 1 ? 'secondary' : i === 2 ? 'tertiary' : ''}">
          <div class="strategy-name">${s.name}</div>
          <div class="strategy-desc">${s.desc}</div>
          ${s.action ? `
            <div class="strategy-action">
              <div class="strategy-action-label">Prova ora</div>
              <div class="strategy-action-text">${s.action}</div>
            </div>
          ` : ''}
        </div>
      `).join('');
      document.getElementById('strategiesList').innerHTML = strategiesHtml;
      
      // Save to history
      const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        feeling: currentFlow.feeling,
        trigger: currentFlow.trigger,
        intensity: currentFlow.intensity,
        notes: currentFlow.notes,
        helpful: null
      };
      state.history.unshift(entry);
      
      // Update patterns
      updatePatterns(entry);
      saveState();
      
      showScreen('responseScreen');
    }

    function markQuickActionDone() {
      const btn = document.getElementById('quickActionBtn');
      btn.innerHTML = '‚úÖ Fatto!';
      btn.style.background = 'var(--bg-elevated)';
      btn.style.color = 'var(--accent-green)';
      showToast('Ottimo lavoro! üí™');
    }

    function giveFeedback(helpful) {
      // Update last entry
      if (state.history.length > 0) {
        state.history[0].helpful = helpful;
        saveState();
      }
      
      // Update UI
      document.querySelectorAll('.feedback-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (helpful) {
        showToast('Grazie! Sono contento che ti sia stato utile üíö');
      } else {
        showToast('Grazie per il feedback. Cercher√≤ di migliorare.');
      }
    }

    function finishAndGoHome() {
      screenHistory = ['homeScreen'];
      showScreen('homeScreen');
    }

    // ===================== PATTERNS =====================
    function updatePatterns(entry) {
      const feelingKey = entry.feeling;
      const triggerKey = entry.trigger;
      const dayOfWeek = new Date(entry.date).getDay();
      const hour = new Date(entry.date).getHours();
      
      if (!state.patterns.feelings) state.patterns.feelings = {};
      if (!state.patterns.triggers) state.patterns.triggers = {};
      if (!state.patterns.days) state.patterns.days = {};
      if (!state.patterns.times) state.patterns.times = {};
      if (!state.patterns.combinations) state.patterns.combinations = {};
      
      // Count feelings
      state.patterns.feelings[feelingKey] = (state.patterns.feelings[feelingKey] || 0) + 1;
      
      // Count triggers
      state.patterns.triggers[triggerKey] = (state.patterns.triggers[triggerKey] || 0) + 1;
      
      // Count days
      state.patterns.days[dayOfWeek] = (state.patterns.days[dayOfWeek] || 0) + 1;
      
      // Count time periods
      let timePeriod = 'notte';
      if (hour >= 6 && hour < 12) timePeriod = 'mattina';
      else if (hour >= 12 && hour < 18) timePeriod = 'pomeriggio';
      else if (hour >= 18 && hour < 22) timePeriod = 'sera';
      state.patterns.times[timePeriod] = (state.patterns.times[timePeriod] || 0) + 1;
      
      // Count combinations
      const comboKey = `${feelingKey}_${triggerKey}`;
      state.patterns.combinations[comboKey] = (state.patterns.combinations[comboKey] || 0) + 1;
    }

    // ===================== INSIGHTS =====================
    function renderInsights() {
      const container = document.getElementById('insightsContent');
      
      if (state.history.length < 3) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="emoji">üìä</div>
            <h3>Non ho ancora abbastanza dati</h3>
            <p>Usa l'app qualche volta e inizier√≤ a mostrarti i tuoi pattern.</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      // Most common feeling
      if (state.patterns.feelings) {
        const topFeeling = Object.entries(state.patterns.feelings)
          .sort((a, b) => b[1] - a[1])[0];
        if (topFeeling) {
          const feeling = feelings.find(f => f.id === topFeeling[0]);
          html += `
            <div class="insight-card">
              <div class="insight-card-header">
                <span class="insight-card-emoji">${feeling.emoji}</span>
                <span class="insight-card-title">La tua emozione pi√π frequente</span>
              </div>
              <p class="insight-card-content">
                Ti senti <span class="insight-highlight">${feeling.label.toLowerCase()}</span> pi√π spesso delle altre emozioni.
                √à emerso in ${topFeeling[1]} occasioni.
              </p>
            </div>
          `;
        }
      }
      
      // Most common trigger
      if (state.patterns.triggers) {
        const topTrigger = Object.entries(state.patterns.triggers)
          .sort((a, b) => b[1] - a[1])[0];
        if (topTrigger) {
          const trigger = triggers.find(t => t.id === topTrigger[0]);
          html += `
            <div class="insight-card">
              <div class="insight-card-header">
                <span class="insight-card-emoji">${trigger.emoji}</span>
                <span class="insight-card-title">Il trigger pi√π comune</span>
              </div>
              <p class="insight-card-content">
                "<span class="insight-highlight">${trigger.label}</span>" √® la situazione che pi√π spesso ti mette in difficolt√†.
              </p>
            </div>
          `;
        }
      }
      
      // Time patterns
      if (state.patterns.times) {
        const topTime = Object.entries(state.patterns.times)
          .sort((a, b) => b[1] - a[1])[0];
        if (topTime && topTime[1] >= 2) {
          html += `
            <div class="insight-card">
              <div class="insight-card-header">
                <span class="insight-card-emoji">üïê</span>
                <span class="insight-card-title">Quando succede di pi√π</span>
              </div>
              <p class="insight-card-content">
                I momenti difficili tendono ad arrivare pi√π spesso <span class="insight-highlight">di ${topTime[0]}</span>.
                Potresti prepararti meglio per quei momenti.
              </p>
            </div>
          `;
        }
      }
      
      // Helpful strategies
      const helpfulEntries = state.history.filter(h => h.helpful === true);
      if (helpfulEntries.length >= 2) {
        html += `
          <div class="insight-card">
            <div class="insight-card-header">
              <span class="insight-card-emoji">‚úÖ</span>
              <span class="insight-card-title">Le strategie funzionano</span>
            </div>
            <p class="insight-card-content">
              In <span class="insight-highlight">${helpfulEntries.length} occasioni</span> hai detto che i consigli ti sono stati utili.
              Continua cos√¨!
            </p>
          </div>
        `;
      }
      
      container.innerHTML = html || `
        <div class="empty-state">
          <div class="emoji">üîç</div>
          <h3>Ancora pochi dati</h3>
          <p>Continua a usare l'app per scoprire i tuoi pattern.</p>
        </div>
      `;
    }

    // ===================== HISTORY =====================
    function renderHistory() {
      const container = document.getElementById('historyContent');
      
      if (state.history.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="emoji">üìù</div>
            <h3>Nessun momento registrato</h3>
            <p>Quando hai bisogno di aiuto, troverai qui lo storico.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = state.history.slice(0, 20).map(entry => {
        const feeling = feelings.find(f => f.id === entry.feeling);
        const trigger = triggers.find(t => t.id === entry.trigger);
        const date = new Date(entry.date);
        const dateStr = formatDate(date);
        
        return `
          <div class="history-item">
            <span class="history-item-emoji">${feeling?.emoji || 'üò∂'}</span>
            <div class="history-item-content">
              <div class="history-item-feeling">${feeling?.label || 'Sconosciuto'}</div>
              <div class="history-item-meta">
                ${dateStr} ¬∑ ${trigger?.label || ''}
              </div>
            </div>
            <div class="history-item-intensity">
              ${[1,2,3,4,5].map(i => `
                <div class="intensity-mini-dot ${i <= entry.intensity ? 'filled' : ''}"></div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) {
          const mins = Math.floor(diff / (1000 * 60));
          return mins <= 1 ? 'Ora' : `${mins} min fa`;
        }
        return hours === 1 ? '1 ora fa' : `${hours} ore fa`;
      } else if (days === 1) {
        return 'Ieri';
      } else if (days < 7) {
        return `${days} giorni fa`;
      } else {
        return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
      }
    }

    // ===================== UTILS =====================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>